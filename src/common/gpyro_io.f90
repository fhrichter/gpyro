MODULE GPYRO_IO

USE PREC
USE GPYRO_VARS

IMPLICIT NONE

CONTAINS 

! *****************************************************************************
SUBROUTINE READ_GPYRO
! *****************************************************************************
! This is the main input subroutine.  It reads in several namelist groups and 
! ALLOCATES the main arrays. 

INTEGER, PARAMETER :: NSPECMAX = 50, NRXNMAX = 50

INTEGER :: I, J

! Variables for namelist group GPYRO_GENERAL:
CHARACTER(300) :: MESSAGE
CHARACTER(4) :: SWEEP_dIRECTION
REAL(EB) :: TAMB,GX,GZ,GY,DT0,TREF,P0,ALPHA,ALPHA_YIS,ALPHA_YJG,ALPHA_H,ALPHA_HG,ALPHA_P,TMPTOL, &
            HTOL,YITOL,PTOL,EPS,VHLC,YJTOL,HGTOL,HCV, NU_A,NU_B,NU_C,FDS_HEAT_OF_COMBUSTION,TORTUOSITY_FACTOR, &
            GPYRO_TO_GPYRO_TOLERANCE, CONSTANT_HM0,OBST_SCALING_FACTOR,ADD_TO_OBST_XB,DT_CSVDUMP, &
            EPS_YJG,EPS_YIS, ADD_TO_OBST_X, ADD_TO_OBST_Y, ADD_TO_OBST_Z
INTEGER :: NTDMA_ITERATIONS,NRXNS,NHGRXNS,NSSPECIESITERNS,NCONTINUITYITERNS,NCOEFF_UPDATE_SKIP,FDS_MATL_VER,CONV_DIFF_SCHEME
LOGICAL :: THERMAL_EQUILIBRIUM,SOLVE_GAS_ENERGY,SOLVE_PRESSURE, SOLVE_GAS_YJ,EXPLICIT_T, &
           USE_TOFH_NEWTON,SHYI_CORRECTION,BLOWING, &
           CONVENTIONAL_RXN_ORDER,NOCONSUMPTION,FDSMODE,CONSTANT_DHVOL,FULL_QSG, &
           GASES_PRODUCED_AT_TSOLID,DUMP_INTERMEDIATE_TIMINGS,USE_TORTUOSITY_FACTOR_FOR_FLUX,USE_CONSTANT_HM0, &
           CSVDUMP, USE_SOLID_ENTHALPY_SOLVER_TEST, FIX_DOMAIN_TEMPERATURE, DUMP_DETAILED_CONVERGENCE, KOZENY_CARMAN, ANISOTROPIC_SPECIES(1:NSPECMAX), &
           USE_ANISOTROPIC_SOLID_ENTHALPY_SOLVER, GEOMETRY_IS_UPSIDE_DOWN

! Variables for namelist group GPYRO_OUTPUT
CHARACTER(60) :: CASENAME
REAL(EB) :: DTDUMP_GA,DTDUMP_POINT,DTDUMP_PROFILE,DTDUMP_SMOKEVIEW,TMP_REDUCED_DTDUMP,REDUCED_DTDUMP, &
            DTMIN_KILL
INTEGER  :: N_POINT_QUANTITIES,N_PROFILE_QUANTITIES,N_SMOKEVIEW_QUANTITIES
CHARACTER(60), DIMENSION(1:1000) :: POINT_QUANTITY,PROFILE_QUANTITY,SMOKEVIEW_QUANTITY
REAL(EB), DIMENSION(1:1000) :: POINT_Z,POINT_X,POINT_Y,PROFILE_COORD1,PROFILE_COORD2,SMOKEVIEW_LOCATION
CHARACTER(1), DIMENSION (1:1000) :: PROFILE_DIRECTION
CHARACTER(2), DIMENSION (1:1000) :: SMOKEVIEW_PLANE
INTEGER, DIMENSION(1:1000) :: PROFILE_ISKIP,POINT_QUANTITY_INDEX,PROFILE_QUANTITY_INDEX,SMOKEVIEW_QUANTITY_INDEX,POINT_IMESH,PROFILE_IMESH,SMOKEVIEW_IMESH

! Variables for namelist group GPYRO_SPROPS:
REAL(EB), DIMENSION (1:NSPECMAX) :: K0Z, NKZ, R0, NR, C0, NC, EMIS, KAPPA, TMELT, DHMELT, SIGMA2MELT,    &
                                    GAMMA, PERMZ, RS0, PORE_DIAMETER, K0X, NKX, PERMX, K0Y, NKY, PERMY

! Variables for namelist group GPYRO_GPROPS:
INTEGER :: NGSPEC, IBG, IO2
REAL(EB) :: CPG
REAL(EB), DIMENSION (1:NSPECMAX) :: M, SIGMA, EPSOK
CHARACTER(60), DIMENSION (1:NSPECMAX) :: NAME

! Variables for namelist group GPYRO_RXNS:
CHARACTER(60), DIMENSION (1:NRXNMAX) :: CFROM,CTO
REAL(EB), DIMENSION (1:NRXNMAX) :: Z,E,DHS,DHV,CHI,ORDER,ORDERO2,KCAT,TCRIT
INTEGER, DIMENSION (1:NRXNMAX) :: IKINETICMODEL,IO2TYPE,ICAT

! Variables for namelist group GPYRO_HGRXNS:
CHARACTER(60), DIMENSION (1:NRXNMAX) :: CREACTANT1,CREACTANT2
REAL(EB), DIMENSION (1:NRXNMAX) :: P,Q,DH,B

! Variables for namelist group GPYRO_GYIELDS:
REAL(EB), DIMENSION (1:NSPECMAX,1:NRXNMAX) :: GYIELDS

! Variables for namelist group GPYRO_HGYIELDS:
REAL(EB), DIMENSION (1:NSPECMAX,1:NRXNMAX) :: HGYIELDS

! Variables for namelist group GPYRO_ALLBC:
REAL(EB), DIMENSION(1:100) :: T,QE,HC,TINF,TFIXED,MDOTPP,PRES,HM
LOGICAL, DIMENSION (1:100) :: RERADIATION
REAL(EB), DIMENSION(1:100,1:NSPECMAX) :: YJINF

! Variables for namelist group GPYRO_CASES:
INTEGER :: NCASES
INTEGER, DIMENSION(1:100) :: IMESH
REAL(EB), DIMENSION(1:100) :: TSTOP,BETA
LOGICAL, DIMENSION (1:100) :: ZEROD

!Variables for namelist group GPYRO_IC:
INTEGER :: IC, NIC
REAL(EB) :: TMP_INITIAL(1:100), TMPG_INITIAL(1:100), P_INITIAL(1:100)
REAL(EB), DIMENSION (1:100,1:NSPECMAX) :: YI0, YJ0

!Variables for namelist group GPYRO_ALLBC:
INTEGER :: ISURF, NSURF_IDX
INTEGER, DIMENSION(1:100) :: SURF_IDX(100)
REAL(EB), DIMENSION(1:100) :: QEG, HCG, TINFG, TFIXEDG

!Variables for namelist group GPYRO_GEOM:
INTEGER :: IOBST, NMESH, NOBST 
INTEGER, DIMENSION(1:100) :: NCELLZ,NCELLX,NCELLY,DEFAULT_IC,ICNUM 
REAL(EB), DIMENSION(1:100) :: ZDIM,XDIM,YDIM,X1,X2,Z1,Z2,Y1,Y2 
REAL(EB), DIMENSION(1:100) :: OFFSETZ, OFFSETX, OFFSETY, NHC
CHARACTER(100) :: GEOMETRY_FILE(100)
INTEGER, DIMENSION(1:100,1:6) :: SURF_IDX2D, DEFAULT_SURF_IDX
REAL(EB), DIMENSION(100,6) :: HCR

! Misc local variables:
INTEGER :: IOS,ISPEC,ICASE,IRXN,NSSPEC
CHARACTER(100) :: FN
      
!Namelist groups:
NAMELIST /GPYRO_GENERAL/ P0,TAMB,GX,GZ,GY,DT0,TREF,NTDMA_ITERATIONS, &
         THERMAL_EQUILIBRIUM,SOLVE_GAS_ENERGY,SHYI_CORRECTION, &
         SOLVE_PRESSURE,SOLVE_GAS_YJ,EXPLICIT_T,USE_TOFH_NEWTON, &
         NSSPECIESITERNS,NCONTINUITYITERNS,BLOWING,CONVENTIONAL_RXN_ORDER,  &
         ALPHA,ALPHA_YIS,ALPHA_YJG,ALPHA_HG,ALPHA_P,ALPHA_H,NCOEFF_UPDATE_SKIP,TMPTOL,HTOL,YITOL,PTOL,NOCONSUMPTION,EPS,VHLC,YJTOL,HGTOL, &
         HCV,NU_A,NU_B,NU_C,FDSMODE,CONSTANT_DHVOL,FULL_QSG,GASES_PRODUCED_AT_TSOLID,FDS_HEAT_OF_COMBUSTION, &
         FDS_MATL_VER,DUMP_INTERMEDIATE_TIMINGS,CONV_DIFF_SCHEME, TORTUOSITY_FACTOR, USE_TORTUOSITY_FACTOR_FOR_FLUX, USE_CONSTANT_HM0, CONSTANT_HM0, &
         GPYRO_TO_GPYRO_TOLERANCE, OBST_SCALING_FACTOR, ADD_TO_OBST_XB, &
         CSVDUMP, DT_CSVDUMP, SWEEP_DIRECTION, USE_SOLID_ENTHALPY_SOLVER_TEST, FIX_DOMAIN_TEMPERATURE, DUMP_DETAILED_CONVERGENCE, &
         EPS_YJG, EPS_YIS, KOZENY_CARMAN, ADD_TO_OBST_X, ADD_TO_OBST_Y, ADD_TO_OBST_Z, ANISOTROPIC_SPECIES, USE_ANISOTROPIC_SOLID_ENTHALPY_SOLVER, &
         GEOMETRY_IS_UPSIDE_DOWN

NAMELIST /GPYRO_OUTPUT/ CASENAME,N_POINT_QUANTITIES,N_PROFILE_QUANTITIES,  &
         N_SMOKEVIEW_QUANTITIES,DTDUMP_GA,DTDUMP_POINT,DTDUMP_PROFILE,DTDUMP_SMOKEVIEW, &
         TMP_REDUCED_DTDUMP,REDUCED_DTDUMP,DTMIN_KILL,POINT_QUANTITY,POINT_Z,POINT_X,POINT_Y,PROFILE_QUANTITY, &
         PROFILE_DIRECTION, PROFILE_COORD1,PROFILE_COORD2,PROFILE_ISKIP,SMOKEVIEW_QUANTITY,SMOKEVIEW_PLANE,SMOKEVIEW_LOCATION,POINT_QUANTITY_INDEX, &
         PROFILE_QUANTITY_INDEX, SMOKEVIEW_QUANTITY_INDEX, POINT_IMESH, PROFILE_IMESH, SMOKEVIEW_IMESH

NAMELIST /GPYRO_SPROPS/ NSSPEC,NAME,K0Z,NKZ,R0,NR,C0,NC,EMIS,KAPPA,TMELT,DHMELT,SIGMA2MELT,GAMMA,PERMZ, & 
                        RS0,PORE_DIAMETER,K0X,NKX,PERMX,K0Y,NKY,PERMY

NAMELIST /GPYRO_GPROPS/ NGSPEC,IBG,IO2,CPG,NAME,YJ0,M,SIGMA,EPSOK,C0,NC

NAMELIST /GPYRO_RXNS/ NRXNS,CFROM,CTO,Z,E,DHS,DHV,CHI,ORDER,ORDERO2,IKINETICMODEL,IO2TYPE,M,KCAT,ICAT,TCRIT 

NAMELIST /GPYRO_HGRXNS/ NHGRXNS,CREACTANT1,CREACTANT2,P,Q,B,Z,E,DH

NAMELIST /GPYRO_GYIELDS/ GYIELDS
      
NAMELIST /GPYRO_HGYIELDS/ HGYIELDS

NAMELIST /GPYRO_CASES/ NCASES,IMESH,TSTOP,ZEROD,BETA

NAMELIST /GPYRO_IC/ NIC,TMP_INITIAL,TMPG_INITIAL,P_INITIAL,YI0,YJ0

NAMELIST /GPYRO_ALLBC/ NSURF_IDX, SURF_IDX, T, QE, HC, NHC, TINF, RERADIATION, TFIXED, MDOTPP, PRES, QEG, HCG, TINFG, TFIXEDG, HM, YJINF

NAMELIST /GPYRO_GEOM/ NMESH, NOBST, ZDIM, NCELLZ, XDIM, NCELLX, YDIM, NCELLY, GEOMETRY_FILE, DEFAULT_SURF_IDX, DEFAULT_IC, OFFSETZ, &
                      OFFSETX, OFFSETY, IMESH, Z1, Z2, X1, X2, Y1, Y2, ICNUM, SURF_IDX2D, HCR

CALL SET_GPYRO_DEFAULTS_GENERAL ! Set default parameter values

! Get the name of the input file from the command line:
IF (IGPYRO_TYPE .NE. 1) THEN !If FDS or GA
   FN = 'gpyro.data'
ELSE
   CALL GETARG(1,FN)
ENDIF

IF (FN(1:1)==' ') THEN
   MESSAGE="Error, no input file specified."
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

! Open the input file and read in namelist groups
OPEN(LUINPUT,FILE=FN,FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   MESSAGE='Problem opening input file ' // TRIM(FN)
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

READ(LUINPUT,NML=GPYRO_GENERAL,IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_GENERAL.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (FDSMODE) CALL GPYRO_FDSMODE('GPYRO_GENERAL')
      
! Copy local variables into global data structure GPG% (GPyro, general)
GPG%TAMB                         = TAMB
GPG%GX                           = GX
GPG%GY                           = GY
GPG%GZ                           = GZ
GPG%P0                           = P0
GPG%DT0                          = DT0
GPG%TREF                         = TREF
GPG%NTDMA_ITERATIONS             = NTDMA_ITERATIONS
GPG%THERMAL_EQUILIBRIUM          = THERMAL_EQUILIBRIUM
GPG%SOLVE_GAS_ENERGY             = SOLVE_GAS_ENERGY
GPG%SHYI_CORRECTION              = SHYI_CORRECTION
GPG%SOLVE_PRESSURE               = SOLVE_PRESSURE
GPG%SOLVE_GAS_YJ                 = SOLVE_GAS_YJ
GPG%EXPLICIT_T                   = EXPLICIT_T
GPG%USE_TOFH_NEWTON              = USE_TOFH_NEWTON
GPG%BLOWING                      = BLOWING
GPG%NSSPECIESITERNS              = NSSPECIESITERNS
GPG%NCONTINUITYITERNS            = NCONTINUITYITERNS
GPG%ALPHA                        = ALPHA
GPG%ALPHA_YIS                    = ALPHA_YIS
GPG%ALPHA_YJG                    = ALPHA_YJG
GPG%ALPHA_H                      = ALPHA_H
GPG%ALPHA_HG                     = ALPHA_HG
GPG%ALPHA_P                      = ALPHA_P
GPG%NCOEFF_UPDATE_SKIP           = NCOEFF_UPDATE_SKIP
GPG%CONVENTIONAL_RXN_ORDER       = CONVENTIONAL_RXN_ORDER
GPG%KOZENY_CARMAN                = KOZENY_CARMAN
GPG%USE_ANISOTROPIC_SOLID_ENTHALPY_SOLVER = USE_ANISOTROPIC_SOLID_ENTHALPY_SOLVER
GPG%GEOMETRY_IS_UPSIDE_DOWN      = GEOMETRY_IS_UPSIDE_DOWN

GPG%TMPTOL                       = TMPTOL
GPG%HTOL                         = HTOL
GPG%YITOL                        = YITOL
GPG%YJTOL                        = YJTOL
GPG%EPS_YIS                      = EPS_YIS
GPG%EPS_YJG                      = EPS_YJG
GPG%PTOL                         = PTOL
GPG%NOCONSUMPTION                = NOCONSUMPTION
GPG%EPS                          = EPS
GPG%VHLC                         = VHLC
      
GPG%HCV                          = HCV
GPG%NU_A                         = NU_A
GPG%NU_B                         = NU_B
GPG%NU_C                         = NU_C
GPG%FDSMODE                      = FDSMODE
GPG%CONSTANT_DHVOL               = CONSTANT_DHVOL
GPG%FULL_QSG                     = FULL_QSG
GPG%GASES_PRODUCED_AT_TSOLID     = GASES_PRODUCED_AT_TSOLID

GPG%FDS_HEAT_OF_COMBUSTION         = FDS_HEAT_OF_COMBUSTION
GPG%FDS_MATL_VER                   = FDS_MATL_VER
GPG%DUMP_INTERMEDIATE_TIMINGS      = DUMP_INTERMEDIATE_TIMINGS
GPG%DUMP_DETAILED_CONVERGENCE      = DUMP_DETAILED_CONVERGENCE
GPG%CONV_DIFF_SCHEME               = CONV_DIFF_SCHEME
GPG%TORTUOSITY_FACTOR              = TORTUOSITY_FACTOR
GPG%USE_TORTUOSITY_FACTOR_FOR_FLUX = USE_TORTUOSITY_FACTOR_FOR_FLUX
GPG%USE_CONSTANT_HM0               = USE_CONSTANT_HM0
GPG%CONSTANT_HM0                   = CONSTANT_HM0
GPG%GPYRO_TO_GPYRO_TOLERANCE       = GPYRO_TO_GPYRO_TOLERANCE
GPG%OBST_SCALING_FACTOR            = OBST_SCALING_FACTOR
GPG%ADD_TO_OBST_XB                 = ADD_TO_OBST_XB
GPG%ADD_TO_OBST_X                  = ADD_TO_OBST_X
GPG%ADD_TO_OBST_Y                  = ADD_TO_OBST_Y
GPG%ADD_TO_OBST_Z                  = ADD_TO_OBST_Z
GPG%ANISOTROPIC_SPECIES(:)         = ANISOTROPIC_SPECIES(:)
GPG%CSVDUMP                        = CSVDUMP
GPG%DT_CSVDUMP                     = DT_CSVDUMP
GPG%SWEEP_DIRECTION                = SWEEP_DIRECTION
GPG%USE_SOLID_ENTHALPY_SOLVER_TEST = USE_SOLID_ENTHALPY_SOLVER_TEST
GPG%FIX_DOMAIN_TEMPERATURE         = FIX_DOMAIN_TEMPERATURE

! Now get NGPYROBC, "Number of Gpyro boundary conditions".
! For an FDS implementation this is determined elsewhere from the 
! geometry specified in the FDS input file.
! For a 1D standalone or GA implementation, NGPYROBC=1. 
! However, for 2D standalone implementation NGPYROBC > 1.

! If this is a standalone implementation:	
IF (IGPYRO_TYPE .EQ. 1) THEN 
! Read in namelist group GPYRO_CASES
   CALL SET_GPYRO_DEFAULTS_CASES ! Set default parameter values
   REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_CASES,IOSTAT=IOS)
   IF (IOS >  0) THEN
      MESSAGE='Error: Problem with namelist group &GPYRO_CASES.'
      CALL SHUTDOWN_GPYRO(MESSAGE)
   ENDIF
ENDIF

! Read in GPYRO_SPROPS
CALL SET_GPYRO_DEFAULTS_SPROPS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_SPROPS,IOSTAT=IOS)
IF (IOS .GT.  0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_SPROPS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_SPROPS ')

SPROP%NSSPEC = NSSPEC

ALLOCATE(SPROP%NAME         (1:NSSPEC) )
ALLOCATE(SPROP%K0Z          (1:NSSPEC) )
ALLOCATE(SPROP%NKZ          (1:NSSPEC) )
ALLOCATE(SPROP%R0           (1:NSSPEC) )
ALLOCATE(SPROP%NR           (1:NSSPEC) )
ALLOCATE(SPROP%C0           (1:NSSPEC) )
ALLOCATE(SPROP%NC           (1:NSSPEC) )
ALLOCATE(SPROP%EMIS         (1:NSSPEC) )
ALLOCATE(SPROP%KAPPA        (1:NSSPEC) )
ALLOCATE(SPROP%TMELT        (1:NSSPEC) )
ALLOCATE(SPROP%DHMELT       (1:NSSPEC) )
ALLOCATE(SPROP%SIGMA2MELT   (1:NSSPEC) )
ALLOCATE(SPROP%GAMMA        (1:NSSPEC) )
ALLOCATE(SPROP%PERMZ        (1:NSSPEC) )
ALLOCATE(SPROP%RS0          (1:NSSPEC) )
ALLOCATE(SPROP%PORE_DIAMETER(1:NSSPEC) )
ALLOCATE(SPROP%K0X          (1:NSSPEC) )
ALLOCATE(SPROP%NKX          (1:NSSPEC) )
ALLOCATE(SPROP%PERMX        (1:NSSPEC) )
ALLOCATE(SPROP%K0Y          (1:NSSPEC) )
ALLOCATE(SPROP%NKY          (1:NSSPEC) )
ALLOCATE(SPROP%PERMY        (1:NSSPEC) )

! Make sure no unused species are defined:
DO ISPEC = NSSPEC + 1, 20
   IF (NAME(ISPEC) .NE. 'null') THEN
      MESSAGE='More than NSPEC solid species have been defined. Increase NSPEC or delete properties for unused species.'
      CALL SHUTDOWN_GPYRO(MESSAGE)
   ENDIF
ENDDO
      
! Copy data from namelist group GPYRO_SPROPS:
DO ISPEC = 1, NSSPEC
   SPROP%NAME(ISPEC)          = NAME(ISPEC)
   SPROP%K0Z(ISPEC)           = K0Z(ISPEC)
   SPROP%NKZ(ISPEC)           = NKZ(ISPEC)
   SPROP%R0(ISPEC)            = R0(ISPEC)
   SPROP%NR(ISPEC)            = NR(ISPEC)
   SPROP%C0(ISPEC)            = C0(ISPEC)
   SPROP%NC(ISPEC)            = NC(ISPEC)
   SPROP%EMIS(ISPEC)          = EMIS(ISPEC)
   SPROP%KAPPA(ISPEC)         = KAPPA(ISPEC)
   SPROP%TMELT(ISPEC)         = TMELT(ISPEC)
   SPROP%DHMELT(ISPEC)        = DHMELT(ISPEC)
   SPROP%SIGMA2MELT(ISPEC)    = SIGMA2MELT(ISPEC)
   SPROP%GAMMA(ISPEC)         = GAMMA(ISPEC)
   SPROP%PERMZ(ISPEC)         = PERMZ(ISPEC)
   SPROP%RS0(ISPEC)           = RS0(ISPEC)
   SPROP%PORE_DIAMETER(ISPEC) = PORE_DIAMETER(ISPEC)      
   SPROP%K0X(ISPEC)           = K0X(ISPEC)
   SPROP%NKX(ISPEC)           = NKX(ISPEC)
   SPROP%PERMX(ISPEC)         = PERMX(ISPEC)
   SPROP%K0Y(ISPEC)           = K0Y(ISPEC)
   SPROP%NKY(ISPEC)           = NKY(ISPEC)
   SPROP%PERMY(ISPEC)         = PERMY(ISPEC)   
ENDDO

! Read in namelist groups GPYRO_RXNS, GPYRO_HGRXNS, GYPROGPROPS
! Do this only to get NRXNS, NHGRXNS, and NGSPEC
CALL SET_GPYRO_DEFAULTS_RXNS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_RXNS,IOSTAT=IOS)
IF (IOS .GT.  0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_RXNS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

CALL SET_GPYRO_DEFAULTS_HGRXNS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_HGRXNS,IOSTAT=IOS)
IF (IOS .GT.  0) THEN 
   MESSAGE='Error: Problem with namelist group &GPYRO_HGRXNS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

CALL SET_GPYRO_DEFAULTS_GPROPS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_GPROPS,IOSTAT=IOS)
IF (IOS .GT.  0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_GPROPS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

SPROP%NRXN   = NRXNS
GPROP%NHGRXN = NHGRXNS
   
! Make sure at least one gaseous species is defined
IF (NGSPEC .LT. 1) THEN
   MESSAGE='Must specify at least 1 gaseous species and assign it a specific heat. This applies even if the gas-phase species conservation equation is not solved.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

! Allocate gaseous property arrays:
ALLOCATE(GPROP%NAME    (1:NGSPEC) )
ALLOCATE(GPROP%M       (1:NGSPEC) )
ALLOCATE(GPROP%SIGMA   (1:NGSPEC) )
ALLOCATE(GPROP%EPSOK   (1:NGSPEC) )
ALLOCATE(GPROP%C0      (1:NGSPEC) )
ALLOCATE(GPROP%NC      (1:NGSPEC) )
ALLOCATE(GPROP%YIELDS  (1:NGSPEC,1:NRXNS) )
ALLOCATE(GPROP%HGYIELDS(1:NGSPEC,1:NHGRXNS))

! Read namelist groups GPYRO_GPROPS
CALL SET_GPYRO_DEFAULTS_GPROPS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_GPROPS,IOSTAT=IOS)
IF (IOS .GT.  0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_GPROPS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_GPROPS ')

GPROP%NGSPEC               = NGSPEC
GPROP%IBG                  = IBG
GPROP%IO2                  = IO2
GPG%HGTOL                  = HGTOL
GPROP%CPG                  = CPG

! Make sure no unused gaseous species are defined:
DO ISPEC = NGSPEC + 1, 20
   IF (NAME(ISPEC) .NE. 'null') THEN
      MESSAGE='More than NGSPEC gaseous species have been defined. Increase NGSPEC or delete properties for unused species.'
      CALL SHUTDOWN_GPYRO(MESSAGE)
   ENDIF
ENDDO

DO ISPEC = 1, NGSPEC
   GPROP%NAME(ISPEC)    = NAME(ISPEC)
   GPROP%M(ISPEC)       = M(ISPEC)
   GPROP%SIGMA(ISPEC)   = SIGMA(ISPEC)
   GPROP%EPSOK(ISPEC)   = EPSOK(ISPEC)
   GPROP%C0(ISPEC)      = C0(ISPEC)
   GPROP%NC(ISPEC)      = NC(ISPEC)
ENDDO

! Allocate reaction and homogeneous reaction arrays: 
ALLOCATE(RXN  (1:NRXNS  ) )
ALLOCATE(HGRXN(1:NHGRXNS) )

! Read in namelist group GPYRO_RXNS
CALL SET_GPYRO_DEFAULTS_RXNS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_RXNS,IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_RXNS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_RXNS   ')

! Make sure no unused reactions are defined:
DO IRXN = NRXNS + 1, 20
   IF (CFROM(IRXN) .NE. 'null' .OR. CTO(IRXN) .NE. 'null') THEN
      MESSAGE='More than NRXNS have been defined. Increase NRXNS or delete unused reactions.'
      CALL SHUTDOWN_GPYRO(MESSAGE)
   ENDIF
ENDDO

! Copy data from namelist group GPYRO_RXNS:
DO IRXN = 1, NRXNS
   RXN(IRXN)%CFROM          = CFROM(IRXN)
   RXN(IRXN)%CTO            = CTO(IRXN)
   RXN(IRXN)%Z              = Z(IRXN)
   RXN(IRXN)%E              = E(IRXN)
   RXN(IRXN)%DHS            = DHS(IRXN)
   RXN(IRXN)%DHV            = DHV(IRXN)
   RXN(IRXN)%CHI            = CHI(IRXN)
   RXN(IRXN)%ORDER          = ORDER(IRXN)
   RXN(IRXN)%ORDERO2        = ORDERO2(IRXN)
   RXN(IRXN)%IKINETICMODEL  = IKINETICMODEL(IRXN)
   RXN(IRXN)%IO2TYPE        = IO2TYPE(IRXN)
   RXN(IRXN)%M              = M(IRXN)
   RXN(IRXN)%KCAT           = KCAT(IRXN)
   RXN(IRXN)%ICAT           = ICAT(IRXN)
   RXN(IRXN)%TCRIT          = TCRIT(IRXN)
ENDDO

! Read in GPYRO_HGRXNS
CALL SET_GPYRO_DEFAULTS_HGRXNS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_HGRXNS,IOSTAT=IOS)
IF (IOS .GT. 0) THEN 
   MESSAGE='Error: Problem with namelist group &GPYRO_HGRXNS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_HGRXNS ')

! Make sure no unused reactions are defined:
DO IRXN = NHGRXNS + 1, 20
   IF (CREACTANT1(IRXN) .NE. 'null' .OR. CREACTANT2(IRXN) .NE. 'null') THEN
      MESSAGE='More than NHGRXNS have been defined. Increase NHGRXNS or delete unused homogeneous gaseous reactions.'
      CALL SHUTDOWN_GPYRO(MESSAGE)
   ENDIF
ENDDO

! Copy data from namelist group GPYRO_HGRXNS:
DO IRXN = 1, NHGRXNS
   HGRXN(IRXN)%CREACTANT1 = CREACTANT1(IRXN)
   HGRXN(IRXN)%CREACTANT2 = CREACTANT2(IRXN)
   HGRXN(IRXN)%P          = P(IRXN)
   HGRXN(IRXN)%Q          = Q(IRXN)
   HGRXN(IRXN)%B          = B(IRXN)
   HGRXN(IRXN)%Z          = Z(IRXN)
   HGRXN(IRXN)%E          = E(IRXN)
   HGRXN(IRXN)%DH         = DH(IRXN)
ENDDO

! Read in namelist group GPYRO_GYIELDS
CALL SET_GPYRO_DEFAULTS_GYIELDS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_GYIELDS,IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   MESSAGE= 'Error: Problem with namelist group &GPYRO_GYIELDS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_GYIELDS')
          
DO ISPEC=NGSPEC+1, 20
   DO IRXN = NRXNS + 1, 20
      IF (GYIELDS(ISPEC,IRXN) .GT. 1E-9 .OR. GYIELDS(ISPEC,IRXN) .LT. 0.) THEN
         MESSAGE= 'Error: in &GPYRO_GYIELDS, nonzero yield specified for invalid (ISPEC,IRXN) pair.'
         CALL SHUTDOWN_GPYRO(MESSAGE)
      ENDIF
   ENDDO
ENDDO

DO ISPEC = 1, NGSPEC
   DO IRXN = 1, NRXNS
      GPROP%YIELDS(ISPEC,IRXN) = GYIELDS(ISPEC,IRXN)
   ENDDO
ENDDO

! Read in namelist group GPYRO_HGYIELDS
CALL SET_GPYRO_DEFAULTS_HGYIELDS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_HGYIELDS,IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_HGYIELDS.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

DO ISPEC = NGSPEC+1, 20
   DO IRXN = NHGRXNS + 1, 20
      IF (HGYIELDS(ISPEC,IRXN) .GT. 1E-9 .OR. HGYIELDS(ISPEC,IRXN) .LT. 0.) THEN
         MESSAGE= 'Error: in &GPYRO_HGYIELDS, nonzero yield specified for invalid (ISPEC,IRXN) pair.'
         CALL SHUTDOWN_GPYRO(MESSAGE)
      ENDIF
   ENDDO
ENDDO
          
DO ISPEC = 1, NGSPEC
   DO IRXN = 1, NHGRXNS
      GPROP%HGYIELDS(ISPEC,IRXN) = HGYIELDS(ISPEC,IRXN)
   ENDDO
ENDDO

! Read in namelist group GPYRO_CASES - only need YJINF
CALL SET_GPYRO_DEFAULTS_CASES ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_CASES,IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_CASES.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_CASES  ')

GPG%NCASES = NCASES

ALLOCATE(GPG%IMESH      (1:NCASES) )
ALLOCATE(GPG%ICASE      (1:NCASES) )
ALLOCATE(GPG%TSTOP      (1:NCASES) )
ALLOCATE(GPG%ZEROD      (1:NCASES) )
ALLOCATE(GPG%BETA       (1:NCASES) )

DO ICASE = 1, GPG%NCASES
   GPG%ICASE  (ICASE)   = ICASE
   GPG%IMESH  (ICASE)   = IMESH(ICASE)
   GPG%TSTOP  (ICASE)   = TSTOP(ICASE)
   GPG%ZEROD  (ICASE)   = ZEROD(ICASE)
   GPG%BETA   (ICASE)   = BETA(ICASE)
ENDDO
       
! Read in GPYRO_OUTPUT
CALL SET_GPYRO_DEFAULTS_OUTPUT ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_OUTPUT,IOSTAT=IOS)
IF (IOS .GT. 0) THEN 
   MESSAGE='Error: Problem with namelist group &GPYRO_OUTPUT.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_OUTPUT ')

GPG%CASENAME                     = CASENAME
GPG%N_POINT_QUANTITIES           = N_POINT_QUANTITIES
GPG%N_PROFILE_QUANTITIES         = N_PROFILE_QUANTITIES
GPG%N_SMOKEVIEW_QUANTITIES       = N_SMOKEVIEW_QUANTITIES
GPG%DTDUMP_GA                    = DTDUMP_GA
GPG%DTDUMP_POINT                 = DTDUMP_POINT
GPG%DTDUMP_PROFILE               = DTDUMP_PROFILE
GPG%DTDUMP_SMOKEVIEW             = DTDUMP_SMOKEVIEW
GPG%TMP_REDUCED_DTDUMP           = TMP_REDUCED_DTDUMP
GPG%REDUCED_DTDUMP               = REDUCED_DTDUMP
GPG%DTMIN_KILL                   = DTMIN_KILL

ALLOCATE(GPG%POINT_QUANTITY       (1:N_POINT_QUANTITIES) )
ALLOCATE(GPG%POINT_QUANTITY_INDEX (1:N_POINT_QUANTITIES) )
ALLOCATE(GPG%POINT_Z              (1:N_POINT_QUANTITIES) )
ALLOCATE(GPG%POINT_X              (1:N_POINT_QUANTITIES) )
ALLOCATE(GPG%POINT_Y              (1:N_POINT_QUANTITIES) )
ALLOCATE(GPG%POINT_IZ             (1:N_POINT_QUANTITIES) ); GPG%POINT_IZ   (:) = 0
ALLOCATE(GPG%POINT_IX             (1:N_POINT_QUANTITIES) ); GPG%POINT_IX   (:) = 0
ALLOCATE(GPG%POINT_IY             (1:N_POINT_QUANTITIES) ); GPG%POINT_IY   (:) = 0
ALLOCATE(GPG%POINT_IMESH          (1:N_POINT_QUANTITIES) )

GPG%POINT_QUANTITY       (1:N_POINT_QUANTITIES) = POINT_QUANTITY       (1:N_POINT_QUANTITIES)
GPG%POINT_QUANTITY_INDEX (1:N_POINT_QUANTITIES) = POINT_QUANTITY_INDEX (1:N_POINT_QUANTITIES)
GPG%POINT_Z              (1:N_POINT_QUANTITIES) = POINT_Z              (1:N_POINT_QUANTITIES)
GPG%POINT_X              (1:N_POINT_QUANTITIES) = POINT_X              (1:N_POINT_QUANTITIES)
GPG%POINT_Y              (1:N_POINT_QUANTITIES) = POINT_Y              (1:N_POINT_QUANTITIES)
GPG%POINT_IMESH          (1:N_POINT_QUANTITIES) = POINT_IMESH          (1:N_POINT_QUANTITIES)

ALLOCATE(GPG%PROFILE_QUANTITY       (1:N_PROFILE_QUANTITIES) )
ALLOCATE(GPG%PROFILE_QUANTITY_INDEX (1:N_PROFILE_QUANTITIES) )
ALLOCATE(GPG%PROFILE_DIRECTION      (1:N_PROFILE_QUANTITIES) )
ALLOCATE(GPG%PROFILE_COORD1         (1:N_PROFILE_QUANTITIES) )
ALLOCATE(GPG%PROFILE_COORD2         (1:N_PROFILE_QUANTITIES) )
ALLOCATE(GPG%PROFILE_ISKIP          (1:N_PROFILE_QUANTITIES) )
ALLOCATE(GPG%PROFILE_IZ             (1:N_PROFILE_QUANTITIES) ); GPG%PROFILE_IZ(:) = 0
ALLOCATE(GPG%PROFILE_IX             (1:N_PROFILE_QUANTITIES) ); GPG%PROFILE_IX(:) = 0
ALLOCATE(GPG%PROFILE_IY             (1:N_PROFILE_QUANTITIES) ); GPG%PROFILE_IY(:) = 0
ALLOCATE(GPG%PROFILE_IMESH          (1:N_PROFILE_QUANTITIES) )

GPG%PROFILE_QUANTITY       (1:N_PROFILE_QUANTITIES) = PROFILE_QUANTITY       (1:N_PROFILE_QUANTITIES)
GPG%PROFILE_QUANTITY_INDEX (1:N_PROFILE_QUANTITIES) = PROFILE_QUANTITY_INDEX (1:N_PROFILE_QUANTITIES)
GPG%PROFILE_DIRECTION      (1:N_PROFILE_QUANTITIES) = PROFILE_DIRECTION      (1:N_PROFILE_QUANTITIES)
GPG%PROFILE_COORD1         (1:N_PROFILE_QUANTITIES) = PROFILE_COORD1         (1:N_PROFILE_QUANTITIES)
GPG%PROFILE_COORD2         (1:N_PROFILE_QUANTITIES) = PROFILE_COORD2         (1:N_PROFILE_QUANTITIES)
GPG%PROFILE_ISKIP          (1:N_PROFILE_QUANTITIES) = PROFILE_ISKIP          (1:N_PROFILE_QUANTITIES)
GPG%PROFILE_IMESH          (1:N_PROFILE_QUANTITIES) = PROFILE_IMESH          (1:N_PROFILE_QUANTITIES)

ALLOCATE(GPG%SMOKEVIEW_QUANTITY       (1:N_SMOKEVIEW_QUANTITIES) )
ALLOCATE(GPG%SMOKEVIEW_PLANE          (1:N_SMOKEVIEW_QUANTITIES) )
ALLOCATE(GPG%SMOKEVIEW_LOCATION       (1:N_SMOKEVIEW_QUANTITIES) )
ALLOCATE(GPG%SMOKEVIEW_ICELL          (1:N_SMOKEVIEW_QUANTITIES) ); GPG%SMOKEVIEW_ICELL(:) = 0
ALLOCATE(GPG%SMOKEVIEW_IMESH          (1:N_SMOKEVIEW_QUANTITIES) ); GPG%SMOKEVIEW_IMESH(:) = 0
ALLOCATE(GPG%SMOKEVIEW_QUANTITY_INDEX (1:N_SMOKEVIEW_QUANTITIES) )

GPG%SMOKEVIEW_QUANTITY       (1:N_SMOKEVIEW_QUANTITIES) = SMOKEVIEW_QUANTITY       (1:N_SMOKEVIEW_QUANTITIES)
GPG%SMOKEVIEW_QUANTITY_INDEX (1:N_SMOKEVIEW_QUANTITIES) = SMOKEVIEW_QUANTITY_INDEX (1:N_SMOKEVIEW_QUANTITIES)
GPG%SMOKEVIEW_PLANE          (1:N_SMOKEVIEW_QUANTITIES) = SMOKEVIEW_PLANE          (1:N_SMOKEVIEW_QUANTITIES)
GPG%SMOKEVIEW_LOCATION       (1:N_SMOKEVIEW_QUANTITIES) = SMOKEVIEW_LOCATION       (1:N_SMOKEVIEW_QUANTITIES)
GPG%SMOKEVIEW_IMESH          (1:N_SMOKEVIEW_QUANTITIES) = SMOKEVIEW_IMESH          (1:N_SMOKEVIEW_QUANTITIES)

! Set FIRST_SF_IN_MESH and FIRST_PROF_IN_MESH
GPG%FIRST_SF_IN_MESH(:) = -1
DO J = 1, 100 !J is mesh #
   DO I = 1, N_SMOKEVIEW_QUANTITIES
       IF ((GPG%SMOKEVIEW_IMESH(I) .EQ. J .OR. GPG%SMOKEVIEW_IMESH(I) .EQ. 0) .AND. GPG%FIRST_SF_IN_MESH  (J) .LT. 1 ) GPG%FIRST_SF_IN_MESH  (J) = I
   ENDDO
ENDDO

GPG%FIRST_PROF_IN_MESH(:) = -1
DO J = 1, 100 !J is mesh #
   DO I = 1, N_PROFILE_QUANTITIES
       IF ((GPG%PROFILE_IMESH  (I) .EQ. J .OR. GPG%PROFILE_IMESH  (I)  .EQ. 0) .AND. GPG%FIRST_PROF_IN_MESH(J) .LT. 1) GPG%FIRST_PROF_IN_MESH(J) = I
   ENDDO
ENDDO

! Read in GPYRO_IC
CALL SET_GPYRO_DEFAULTS_ICS ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_IC,IOSTAT=IOS)
IF (IOS .GT. 0) THEN 
   MESSAGE='Error: Problem with namelist group &GPYRO_IC.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_IC     ')

GPG%NIC = NIC
ALLOCATE(GPG%INITIAL_CONDITIONS(1:GPG%NIC) )

! Copy back data: 
DO IC = 1, GPG%NIC
   GPG%INITIAL_CONDITIONS(IC)%TMP_INITIAL  = TMP_INITIAL(IC) 
   GPG%INITIAL_CONDITIONS(IC)%TMPG_INITIAL = TMPG_INITIAL(IC) 
   GPG%INITIAL_CONDITIONS(IC)%P_INITIAL    = P_INITIAL(IC) 
   ALLOCATE(GPG%INITIAL_CONDITIONS(IC)%YI0(1:SPROP%NSSPEC))
   GPG%INITIAL_CONDITIONS(IC)%YI0(1:SPROP%NSSPEC) = YI0(IC,1:SPROP%NSSPEC)
   ALLOCATE(GPG%INITIAL_CONDITIONS(IC)%YJ0(1:GPROP%NGSPEC))
   GPG%INITIAL_CONDITIONS(IC)%YJ0(1:GPROP%NGSPEC) = YJ0(IC,1:GPROP%NGSPEC)
ENDDO

! Read in GPYRO_ALLBC
CALL SET_GPYRO_DEFAULTS_ALLBC ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_ALLBC,IOSTAT=IOS)
IF (IOS .GT. 0) THEN 
   MESSAGE='Error: Problem with namelist group &GPYRO_ALLBC.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_ALLBC  ')

GPG%NSURF_IDX = NSURF_IDX
ALLOCATE(GPG%ALLBC(1:GPG%NSURF_IDX) )

! Copy back data: 
DO ISURF = 1, GPG%NSURF_IDX
   GPG%ALLBC(ISURF)%SURF_IDX    = SURF_IDX    (ISURF)
   GPG%ALLBC(ISURF)%T           = T           (ISURF)
   GPG%ALLBC(ISURF)%QE          = QE          (ISURF)
   GPG%ALLBC(ISURF)%HC          = HC          (ISURF)
   GPG%ALLBC(ISURF)%NHC         = NHC         (ISURF)
   GPG%ALLBC(ISURF)%TINF        = TINF        (ISURF)
   GPG%ALLBC(ISURF)%RERADIATION = RERADIATION (ISURF)
   GPG%ALLBC(ISURF)%TFIXED      = TFIXED      (ISURF)
   GPG%ALLBC(ISURF)%MDOTPP      = MDOTPP      (ISURF)
   GPG%ALLBC(ISURF)%PRES        = PRES        (ISURF)
   GPG%ALLBC(ISURF)%QEG         = QEG         (ISURF)
   GPG%ALLBC(ISURF)%HCG         = HCG         (ISURF)
   GPG%ALLBC(ISURF)%TINFG       = TINFG       (ISURF)
   GPG%ALLBC(ISURF)%TFIXEDG     = TFIXEDG     (ISURF)
   GPG%ALLBC(ISURF)%HM          = HM          (ISURF)
 
   ALLOCATE(GPG%ALLBC(ISURF)%YJINF(1:GPROP%NGSPEC))
   GPG%ALLBC(ISURF)%YJINF(1:GPROP%NGSPEC) = YJINF(ISURF,1:GPROP%NGSPEC)

   IF (GPG%SOLVE_GAS_YJ) THEN
      IF (MDOTPP(ISURF) .NE. 0. .AND. HM(ISURF) .NE. 0.) THEN
         MESSAGE='Only one of HM or MDOTPP can be nonzero.'
         CALL SHUTDOWN_GPYRO(MESSAGE)
      ENDIF
   ENDIF

ENDDO

! Read in GPYRO_GEOM
CALL SET_GPYRO_DEFAULTS_GEOM ! Set default parameter values
REWIND(LUINPUT); READ(LUINPUT,NML=GPYRO_GEOM,IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   MESSAGE='Error: Problem with namelist group &GPYRO_GEOM.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF
IF (GPG%FDSMODE) CALL GPYRO_FDSMODE('GPYRO_GEOM   ')

GPG%NUM_GPYRO_MESHES      = NMESH
GPG%NOBST                 = NOBST

ALLOCATE(GPG%ZDIM            (1:NMESH    )) 
ALLOCATE(GPG%NCELLZ          (1:NMESH    )) 
ALLOCATE(GPG%XDIM            (1:NMESH    )) 
ALLOCATE(GPG%NCELLX          (1:NMESH    )) 
ALLOCATE(GPG%YDIM            (1:NMESH    )) 
ALLOCATE(GPG%NCELLY          (1:NMESH    )) 
ALLOCATE(GPG%GEOMETRY_FILE   (1:NMESH    )) 
ALLOCATE(GPG%DEFAULT_SURF_IDX(1:NMESH,1:6)) 
ALLOCATE(GPG%DEFAULT_IC      (1:NMESH    )) 
ALLOCATE(GPG%OFFSETZ         (1:NMESH    )) 
ALLOCATE(GPG%OFFSETX         (1:NMESH    )) 
ALLOCATE(GPG%OFFSETY         (1:NMESH    )) 

GPG%ZDIM            (1:NMESH    ) = ZDIM            (1:NMESH    )
GPG%NCELLZ          (1:NMESH    ) = NCELLZ          (1:NMESH    )
GPG%XDIM            (1:NMESH    ) = XDIM            (1:NMESH    )
GPG%NCELLX          (1:NMESH    ) = NCELLX          (1:NMESH    )
GPG%YDIM            (1:NMESH    ) = YDIM            (1:NMESH    )
GPG%NCELLY          (1:NMESH    ) = NCELLY          (1:NMESH    )
GPG%GEOMETRY_FILE   (1:NMESH    ) = GEOMETRY_FILE   (1:NMESH    )
GPG%DEFAULT_SURF_IDX(1:NMESH,1:6) = DEFAULT_SURF_IDX(1:NMESH,1:6)
GPG%DEFAULT_IC      (1:NMESH    ) = DEFAULT_IC      (1:NMESH    )
GPG%OFFSETZ         (1:NMESH    ) = OFFSETZ         (1:NMESH    )
GPG%OFFSETX         (1:NMESH    ) = OFFSETX         (1:NMESH    )
GPG%OFFSETY         (1:NMESH    ) = OFFSETY         (1:NMESH    )

ALLOCATE(GPG%GEOM(1:GPG%NOBST) )

DO IOBST = 1, GPG%NOBST
   GPG%GEOM(IOBST)%IMESH = IMESH(IOBST) 
   GPG%GEOM(IOBST)%Z1    = Z1   (IOBST) 
   GPG%GEOM(IOBST)%Z2    = Z2   (IOBST) 
   GPG%GEOM(IOBST)%X1    = X1   (IOBST) 
   GPG%GEOM(IOBST)%X2    = X2   (IOBST) 
   GPG%GEOM(IOBST)%Y1    = Y1   (IOBST) 
   GPG%GEOM(IOBST)%Y2    = Y2   (IOBST) 
   GPG%GEOM(IOBST)%ICNUM = ICNUM(IOBST) 
   GPG%GEOM(IOBST)%SURF_IDX(1:6) = SURF_IDX2D(IOBST,1:6) 
   GPG%GEOM(IOBST)%HCR     (1:6) = HCR       (IOBST,1:6) 
ENDDO

IF (IGPYRO_TYPE .NE. 3) CLOSE (LUINPUT)

CONTAINS

!******************************************************************************
SUBROUTINE GPYRO_FDSMODE(NAMELIST_GROUP) !Over-writes with FDS defaults
!******************************************************************************
       
CHARACTER(13), INTENT (IN) :: NAMELIST_GROUP
              
SELECT CASE (TRIM(NAMELIST_GROUP))
       
CASE ('GPYRO_GENERAL')
   THERMAL_EQUILIBRIUM    = .FALSE.
   SOLVE_GAS_ENERGY       = .FALSE.
   SHYI_CORRECTION        = .TRUE.
   SOLVE_PRESSURE         = .FALSE.
   SOLVE_GAS_YJ           = .FALSE.
   EXPLICIT_T             = .FALSE. 
   USE_TOFH_NEWTON        = .TRUE.
   BLOWING                = .FALSE.
   NSSPECIESITERNS        = 1 
   NCONTINUITYITERNS      = 1
   ALPHA                  = 1D0
   NCOEFF_UPDATE_SKIP     = 1
   CONVENTIONAL_RXN_ORDER = .TRUE.
   NOCONSUMPTION          = .FALSE.
   VHLC                   = 0D0

CASE ('GPYRO_SPROPS')
   KAPPA(:)         = 9D9
   TMELT(:)         = 5D3
   DHMELT(:)        = 0D0
   SIGMA2MELT(:)    = 1D0
   GAMMA(:)         = 0D0

CASE ('GPYRO_GPROPS')
   CONTINUE

CASE ('GPYRO_RXNS')     
   DHS(:)           = DHV(:)
   CHI(:)           = 1D0
   ORDERO2(:)       = 0D0
   IKINETICMODEL(:) = 0
   IO2TYPE(:)       = 0
   M(:)             = 0D0
   ORDER(:)         = 1D0

CASE ('GPYRO_HGRXNS')     
   NHGRXNS       = 0

CASE ('GPYRO_GYIELDS')
   CONTINUE

CASE ('GPYRO_OUTPUT')
   CONTINUE

CASE ('GPYRO_CASES')
   CONTINUE

CASE DEFAULT
   CONTINUE

END SELECT

!******************************************************************************       
END SUBROUTINE GPYRO_FDSMODE
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_GENERAL !GPPYRO_GENERAL namelist group
!******************************************************************************
!NGPYROBC = 1 !Default is 1 (1D standalone or GA)...
       
TAMB                           = 300D0
GX                             = 0D0
GZ                             = 0D0
GY                             = 0D0
P0                             = 101.3D3
DT0                            = 0.02D0
TREF                           = 300D0
NTDMA_ITERATIONS               = 100
THERMAL_EQUILIBRIUM            = .TRUE.
SOLVE_GAS_ENERGY               = .FALSE.
SHYI_CORRECTION                = .TRUE.
SOLVE_PRESSURE                 = .FALSE.
SOLVE_GAS_YJ                   = .FALSE.
EXPLICIT_T                     = .FALSE. 
USE_TOFH_NEWTON                = .TRUE.
BLOWING                        = .FALSE.
NSSPECIESITERNS                = 1 
NCONTINUITYITERNS              = 1
ALPHA                          = 1D0
ALPHA_H                        = 1D0
ALPHA_YIS                      = 1D0
ALPHA_YJG                      = 1D0
ALPHA_P                        = 1D0
ALPHA_HG                       = 1D0
NCOEFF_UPDATE_SKIP             = 1
CONVENTIONAL_RXN_ORDER         = .FALSE.
KOZENY_CARMAN                  = .FALSE.
USE_ANISOTROPIC_SOLID_ENTHALPY_SOLVER = .FALSE.
GEOMETRY_IS_UPSIDE_DOWN        = .TRUE.
       
TMPTOL                         = 1D-4
HTOL                           = 1D-8
YITOL                          = 1D-4
PTOL                           = 1D-4
YJTOL                          = 1D-4
HGTOL                          = 1D-1
EPS_YJG                        = 1D-5
EPS_YIS                        = 1D-3

NOCONSUMPTION                  = .FALSE.
EPS                            = 1D-10
VHLC                           = 0D0 
HCV                            = 0D0
NU_A                           = 2D0
NU_B                           = 1D0
NU_C                           = 0.5D0
FDSMODE                        = .FALSE.
CONSTANT_DHVOL                 = .TRUE. 
FULL_QSG                       = .FALSE.
GASES_PRODUCED_AT_TSOLID       = .FALSE. 
FDS_HEAT_OF_COMBUSTION         = -1.
FDS_MATL_VER                   = 5
DUMP_INTERMEDIATE_TIMINGS      = .FALSE.
DUMP_DETAILED_CONVERGENCE      = .FALSE. 
CONV_DIFF_SCHEME               = 3
TORTUOSITY_FACTOR              = 1D0
USE_TORTUOSITY_FACTOR_FOR_FLUX = .FALSE. 
USE_CONSTANT_HM0               = .FALSE.
CONSTANT_HM0                   = 0.
GPYRO_TO_GPYRO_TOLERANCE       = 1D-5
OBST_SCALING_FACTOR            = 1D0
ADD_TO_OBST_XB                 = 0D0
ADD_TO_OBST_X                  = 0D0
ADD_TO_OBST_Y                  = 0D0
ADD_TO_OBST_Z                  = 0D0
ANISOTROPIC_SPECIES(:)         = .FALSE.
CSVDUMP                        = .FALSE.
DT_CSVDUMP                     = -1.0
SWEEP_DIRECTION                = 'null'
USE_SOLID_ENTHALPY_SOLVER_TEST = .FALSE.
FIX_DOMAIN_TEMPERATURE         = .FALSE.

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_GENERAL
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_OUTPUT ! GPYRO_OUTPUT namelist group:
!******************************************************************************
CASENAME                = 'gpyro'
N_POINT_QUANTITIES      = 4
N_PROFILE_QUANTITIES    = 2
N_SMOKEVIEW_QUANTITIES  = 0
DTDUMP_GA               = 10.0
DTDUMP_POINT            =  1.0
DTDUMP_PROFILE          = 10.0 
DTDUMP_SMOKEVIEW        = 10.0
       
TMP_REDUCED_DTDUMP      = 9D9
REDUCED_DTDUMP          = 1D0
DTMIN_KILL              = 1D-7

POINT_QUANTITY       (:) = 'null'
POINT_QUANTITY_INDEX (:) = -1
POINT_Z              (:) = 0D0
POINT_X              (:) = 0D0
POINT_Y              (:) = 0D0

POINT_QUANTITY       (1) = 'TEMPERATURE'

POINT_QUANTITY       (2) = 'TEMPERATURE'
POINT_Z              (2) = 0.01D0

POINT_QUANTITY       (3) = 'THICKNESS'
POINT_QUANTITY_INDEX (3) = 0

POINT_QUANTITY       (4) = 'MLR'
POINT_QUANTITY_INDEX (4) = 0

PROFILE_QUANTITY       (:) = 'null'
PROFILE_QUANTITY_INDEX (:) = -1
PROFILE_DIRECTION      (:) = 'z'
PROFILE_COORD1         (:) = 0D0
PROFILE_COORD2         (:) = 0D0
PROFILE_ISKIP          (:) = 1

PROFILE_QUANTITY       (1) = 'TEMPERATURE'

SMOKEVIEW_QUANTITY       (:) = 'null'
SMOKEVIEW_QUANTITY_INDEX (:) = -1

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_OUTPUT
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_SPROPS !GPYRO_SPROPS namelist group
!******************************************************************************

NSSPEC           = 1
NAME(:)          = 'null'
K0Z(:)           = 0.2D0
NKZ(:)           = 0D0
R0(:)            = 1000D0
NR(:)            = 0D0
C0(:)            = 1400D0
NC(:)            = 0D0
EMIS(:)          = 0.9D0
KAPPA(:)         = 9D9
TMELT(:)         = 5D3
DHMELT(:)        = 0D0
SIGMA2MELT(:)    = 1D0
GAMMA(:)         = 0D0
PERMZ(:)         = 1D-10
RS0(:)           = 1010D0
PORE_DIAMETER(:) = 5D-4
K0X(:)           = 0.2D0
NKX(:)           = 0D0
PERMX(:)         = 1D-10
K0Y(:)           = 0.2D0
NKY(:)           = 0D0
PERMY(:)         = 1D-10

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_SPROPS
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_ICS !GPYRO_ICS namelist group
!******************************************************************************

NIC             = 1
TMP_INITIAL(:)  = 300D0
TMPG_INITIAL(:) = 300D0
P_INITIAL  (:)  = 101.3D3
YI0(:,:)        = 0D0
YI0(1,1)        = 1D0
YJ0(:,:)        = 0D0
YJ0(1,1)        = 1D0
      
!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_ICS
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_GEOM !GPYRO_GEOM namelist group
!******************************************************************************

NMESH                 = 1
NOBST                 = 1
DEFAULT_SURF_IDX(:,:) = 1
DEFAULT_IC(:)         = 1
OFFSETZ(:)            = 0D0
OFFSETX(:)            = 0D0
OFFSETY(:)            = 0D0
IMESH(:)              = 0
X1(:)                 = -1D0
X2(:)                 = 1D0
Z1(:)                 = 0D0
Z2(:)                 = 1D0
Y1(:)                 = 0D0
Y2(:)                 = 1D0
ICNUM(:)              = 1
SURF_IDX2D(:,:)       = 1
HCR(:,:)              = 9D9
      
!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_GEOM
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_RXNS ! GPYRO_RXNS namelist group
!******************************************************************************

NRXNS            = 1
CFROM(:)         = 'null'
CTO(:)           = 'null'
Z(:)             = 1D8
E(:)             = 130D0
DHS(:)           = 0D0
DHV(:)           = 1.1D6
CHI(:)           = 1D0
ORDER(:)         = 1D0
ORDERO2(:)       = 0D0
IKINETICMODEL(:) = 0
IO2TYPE(:)       = 0
M(:)             = 0D0
KCAT(:)          = 0D0
ICAT(:)          = 0
TCRIT(:)         = 0D0

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_RXNS
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_GPROPS !GPYRO_GPROPS namelist group
!******************************************************************************

NGSPEC    = 1
IBG       = 1
IO2       = -1
CPG       = 1000D0
NAME(:)   = 'null'
M(:)      = 44.
SIGMA(:)  = 5.061
EPSOK(:)  = 254.
C0(:)     = 1D3
NC(:)     = 0D0

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_GPROPS
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_HGRXNS ! GPYRO_HGRXNS namelist group
!******************************************************************************

NHGRXNS       = 0
CREACTANT1(:) = 'null'
CREACTANT2(:) = 'null'
P(:)          = 1D0
Q(:)          = 1D0
B(:)          = 0D0
Z(:)          = 1D10
E(:)          = 200D0
DH(:)         = 20D3

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_HGRXNS
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_GYIELDS ! GPYRO_GYIELDS namelist group
!******************************************************************************

GYIELDS(:,:) = 0D0
GYIELDS(1,1) = 1D0

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_GYIELDS
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_HGYIELDS ! GPYRO_HGYIELDS namelist group
!******************************************************************************

HGYIELDS(:,:) = 0D0

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_HGYIELDS
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_ALLBC
!******************************************************************************

SURF_IDX    (:)   = 1
T           (:)   = 0D0
QE          (:)   = 0D0
HC          (:)   = 10D0
NHC         (:)   = 0D0
TINF        (:)   = 300D0
RERADIATION (:)   = .TRUE.
TFIXED      (:)   = -1D0
MDOTPP      (:)   = 0D0
PRES        (:)   = 0D0
QEG         (:)   = 0D0
HCG         (:)   = 10D0
TINFG       (:)   = 300D0
TFIXEDG     (:)   = -1D0
HM          (:)   = 0D0
YJINF       (:,:) = 0D0
YJINF       (1,1) = 1D0

!******************************************************************************
END SUBROUTINE SET_GPYRO_DEFAULTS_ALLBC
!******************************************************************************

!******************************************************************************
SUBROUTINE SET_GPYRO_DEFAULTS_CASES !GPYRO_CASES namelist group: 
!******************************************************************************

NCASES   = 1
TSTOP(:) = 600D0
ZEROD(:) = .FALSE.
BETA(:)  = 10D0

!******************************************************************************       
END SUBROUTINE SET_GPYRO_DEFAULTS_CASES
!******************************************************************************

!******************************************************************************
END SUBROUTINE READ_GPYRO
!******************************************************************************

!******************************************************************************
SUBROUTINE WRITE_DOTOUT_FILE(ICASE,TI,IMESH)
!******************************************************************************

USE GPYRO_FUNCS, ONLY: WALL_CLOCK_TIME_THANKS_FDS

INTEGER, INTENT(IN) :: ICASE,IMESH
REAL(EB), INTENT(IN) :: TI
REAL(EB) :: MINTMP
INTEGER :: ISPEC,IRXN,IOBST,IC,ISURF,IZ,IX,IY
CHARACTER(4) :: FOUR
CHARACTER(2) :: TWO
CHARACTER(300) :: FN
CHARACTER(200) :: STR1 
LOGICAL :: LOPEN
CHARACTER(300) :: MESSAGE
LOGICAL,DIMENSION(1:100) :: ICISUSED=.FALSE.

G=>GPM(IMESH)
GPBCP(1:,1:,1:,-3:)=>G%GPYRO_BOUNDARY_CONDITION(1:,1:,1:,-3:)

! Check whether .out file is open, and if not open it:	
INQUIRE(UNIT=LUDOTOUT,OPENED=LOPEN)

IF (.NOT. LOPEN) THEN
   WRITE(FOUR,'(I4.4)') ICASE
   FN = 'gpyro_' // TRIM(GPG%CASENAME) // '_' // FOUR // '.out'
   OPEN(UNIT=LUDOTOUT,FILE=FN,FORM='FORMATTED',STATUS='REPLACE')

   WRITE(LUDOTOUT,90) 'Gpyro 0.8200'
   WRITE(LUDOTOUT,90) 'Build date: August 29, 2020'
   WRITE(LUDOTOUT,90) 'https://github.com/reaxfire/gpyro'
   WRITE(LUDOTOUT,*)

   WRITE(TWO,'(I2.2)') ICASE; WRITE(LUDOTOUT,90) "Case #: " // TWO
   WRITE(TWO,'(I2.2)') IMESH; WRITE(LUDOTOUT,90) "Mesh #: " // TWO
   WRITE(LUDOTOUT,*)

   IF (GPG%FDSMODE) THEN
      WRITE(LUDOTOUT,90) '*** Gpyro is running in FDS mode. *** '
      WRITE(LUDOTOUT,*)
   ENDIF

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!      
   WRITE(LUDOTOUT,90) '*** General Parameters *** '
   WRITE(LUDOTOUT,*)

   WRITE(STR1,'(F11.4)') GPG%DT0
   WRITE(LUDOTOUT,90) 'DT0                     : ' // TRIM(STR1) // ' s'

   WRITE(STR1,'(F11.4)') GPG%TAMB
   WRITE(LUDOTOUT,90) 'TAMB                    : ' // TRIM(STR1) // ' K'

   WRITE(STR1,'(F11.4)') GPG%TREF
   WRITE(LUDOTOUT,90) 'TREF                    : ' // TRIM(STR1) // ' K'

   WRITE(STR1,'(E11.3)') GPG%P0
   WRITE(LUDOTOUT,90) 'P0                      : ' // TRIM(STR1) // ' Pa'

   WRITE(STR1,'(F11.4)') G%GX
   WRITE(LUDOTOUT,90) 'GX                      : ' // TRIM(STR1) // ' m/s2'

   WRITE(STR1,'(F11.4)') G%GZ
   WRITE(LUDOTOUT,90) 'GZ                      : ' // TRIM(STR1) // ' m/s2'

   WRITE(STR1,'(F11.4)') G%GY
   WRITE(LUDOTOUT,90) 'GY                      : ' // TRIM(STR1) // ' m/s2'

   WRITE(STR1,*) GPG%THERMAL_EQUILIBRIUM
   WRITE(LUDOTOUT,90) 'THERMAL_EQUILIBRIUM     : ' // TRIM(STR1)

   WRITE(STR1,'(E11.3)') GPG%VHLC
   WRITE(LUDOTOUT,90) 'VHLC                    : ' // TRIM(STR1) // ' W/m3-K'

   WRITE(STR1,'(E11.3)') GPG%HCV
   WRITE(LUDOTOUT,90) 'HCV                     : ' // TRIM(STR1) // ' W/m3-K'

   WRITE(STR1,'(F11.4)') GPG%NU_A
   WRITE(LUDOTOUT,90) 'NU_A                    : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(F11.4)') GPG%NU_B
   WRITE(LUDOTOUT,90) 'NU_B                    : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(F11.4)') GPG%NU_C
   WRITE(LUDOTOUT,90) 'NU_C                    : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(I5.5)') GPG%NTDMA_ITERATIONS
   WRITE(LUDOTOUT,90) 'NTDMA_ITERATIONS        : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(I4.4)') GPG%NSSPECIESITERNS
   WRITE(LUDOTOUT,90) 'NSSPECIESITERNS         : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(I4.4)') GPG%NCONTINUITYITERNS
   WRITE(LUDOTOUT,90) 'NCONTINUITYITERNS       : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(F11.4)') GPG%ALPHA
   WRITE(LUDOTOUT,90) 'ALPHA                   : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(E11.3)') GPG%TMPTOL
   WRITE(LUDOTOUT,90) 'TMPTOL                  : ' // TRIM(STR1) // ' (K)'

   WRITE(STR1,'(E11.3)') GPG%HTOL
   WRITE(LUDOTOUT,90) 'HTOL                    : ' // TRIM(STR1) // ' (J/kg)'

   WRITE(STR1,'(E11.3)') GPG%YITOL
   WRITE(LUDOTOUT,90) 'YITOL                   : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(E11.3)') GPG%PTOL
   WRITE(LUDOTOUT,90) 'PTOL                    : ' // TRIM(STR1) // ' (Pa)'

   WRITE(STR1,'(E11.3)') GPG%YJTOL
   WRITE(LUDOTOUT,90) 'YJTOL                   : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,'(E11.3)') GPG%HGTOL
   WRITE(LUDOTOUT,90) 'HGTOL                   : ' // TRIM(STR1) // ' (J/kg)'

   WRITE(STR1,*) GPG%EXPLICIT_T
   WRITE(LUDOTOUT,90) 'EXPLICIT_T              : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%SOLVE_GAS_YJ
   WRITE(LUDOTOUT,90) 'SOLVE_GAS_YJ            : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%SOLVE_GAS_ENERGY
   WRITE(LUDOTOUT,90) 'SOLVE_GAS_ENERGY        : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%SOLVE_PRESSURE
   WRITE(LUDOTOUT,90) 'SOLVE_PRESSURE          : ' // TRIM(STR1)
 
   WRITE(STR1,*) GPG%USE_TOFH_NEWTON
   WRITE(LUDOTOUT,90) 'USE_TOFH_NEWTON         : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%SHYI_CORRECTION
   WRITE(LUDOTOUT,90) 'SHYI_CORRECTION         : ' // TRIM(STR1)

   WRITE(STR1,'(I4.4)') GPG%NCOEFF_UPDATE_SKIP
   WRITE(LUDOTOUT,90) 'NCOEFF_UPDATE_SKIP      : ' // TRIM(STR1) // ' (-)'

   WRITE(STR1,*) GPG%FDSMODE
   WRITE(LUDOTOUT,90) 'FDSMODE                 : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%CONVENTIONAL_RXN_ORDER
   WRITE(LUDOTOUT,90) 'CONVENTIONAL_RXN_ORDER  : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%KOZENY_CARMAN
   WRITE(LUDOTOUT,90) 'KOZENY_CARMAN           : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%USE_ANISOTROPIC_SOLID_ENTHALPY_SOLVER
   WRITE(LUDOTOUT,90) 'USE_ANISOTROPIC_SOLID_ENTHALPY_SOLVER           : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%NOCONSUMPTION
   WRITE(LUDOTOUT,90) 'NOCONSUMPTION           : ' // TRIM(STR1)

   WRITE(STR1,'(F11.4)') GPG%EPS
   WRITE(LUDOTOUT,90) 'EPS                     : ' // TRIM(STR1) // ' m'

   WRITE(STR1,*) GPG%BLOWING
   WRITE(LUDOTOUT,90) 'BLOWING                 : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%CONSTANT_DHVOL
   WRITE(LUDOTOUT,90) 'CONSTANT_DHVOL          : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%FULL_QSG
   WRITE(LUDOTOUT,90) 'FULL_QSG                : ' // TRIM(STR1)

   WRITE(STR1,*) GPG%GASES_PRODUCED_AT_TSOLID
   WRITE(LUDOTOUT,90) 'GASES_PRODUCED_AT_TSOLID: ' // TRIM(STR1)

   WRITE(LUDOTOUT,*)

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
   WRITE(LUDOTOUT,90) '*** Solid Properties *** '
   WRITE(LUDOTOUT,*)

   WRITE(LUDOTOUT,89) 'Number of solid species: ', SPROP%NSSPEC
   WRITE(LUDOTOUT,*)
   
   DO ISPEC = 1, SPROP%NSSPEC

      WRITE(TWO,'(I2.2)') ISPEC

      WRITE (LUDOTOUT,90) 'Name          (' // TWO // '): ' // TRIM(SPROP%NAME(ISPEC))

      WRITE(STR1,'(F9.1)') SPROP%R0(ISPEC)
      WRITE (LUDOTOUT,90) 'R0            (' // TWO // '): ' // TRIM(STR1) // ' kg/m3'
      
      WRITE(STR1,'(F9.4)') SPROP%NR(ISPEC)
      WRITE (LUDOTOUT,90) 'NR            (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(F9.1)') SPROP%C0(ISPEC)
      WRITE (LUDOTOUT,90) 'C0            (' // TWO // '): ' // TRIM(STR1) // ' J/kg-K'

      WRITE(STR1,'(F9.4)') SPROP%NC(ISPEC)
      WRITE (LUDOTOUT,90) 'NC            (' // TWO // '): ' // TRIM(STR1) // ' (-)'
      
      IF (G%NCELLZ .GT. 1) THEN
         WRITE(STR1,'(F11.4)') SPROP%K0Z(ISPEC)
         WRITE (LUDOTOUT,90) 'K0Z           (' // TWO // '): ' // TRIM(STR1) // ' W/m-K'
      
         WRITE(STR1,'(F9.4)') SPROP%NKZ(ISPEC)
         WRITE (LUDOTOUT,90) 'NKZ           (' // TWO // '): ' // TRIM(STR1) // ' (-)'
      ENDIF

      IF (G%NCELLX .GT. 1) THEN
         WRITE(STR1,'(F9.4)') SPROP%K0X(ISPEC)
         WRITE (LUDOTOUT,90) 'K0X           (' // TWO // '): ' // TRIM(STR1) // ' W/m-K'

         WRITE(STR1,'(F9.4)') SPROP%NKX(ISPEC)
         WRITE (LUDOTOUT,90) 'NKX           (' // TWO // '): ' // TRIM(STR1) // ' (-)'
      ENDIF

      IF (G%NCELLY .GT. 1) THEN
         WRITE(STR1,'(F9.4)') SPROP%K0Y(ISPEC)
         WRITE (LUDOTOUT,90) 'K0Y           (' // TWO // '): ' // TRIM(STR1) // ' W/m-K'

         WRITE(STR1,'(F9.4)') SPROP%NKY(ISPEC)
         WRITE (LUDOTOUT,90) 'NKY           (' // TWO // '): ' // TRIM(STR1) // ' (-)'
      ENDIF

      WRITE(STR1,'(F9.4)') SPROP%EMIS(ISPEC)
      WRITE (LUDOTOUT,90) 'EMISSIVITY    (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(E10.3)') SPROP%KAPPA(ISPEC)
      WRITE (LUDOTOUT,90) 'KAPPA         (' // TWO // '): ' // TRIM(STR1) // ' 1/m'

      WRITE(STR1,'(F9.1)') SPROP%RS0(ISPEC)
      WRITE (LUDOTOUT,90) 'RS0           (' // TWO // '): ' // TRIM(STR1) // ' kg/m3'

      IF (GPG%SOLVE_PRESSURE) THEN
         WRITE(STR1,'(E10.3)') SPROP%PERMZ(ISPEC)
         WRITE (LUDOTOUT,90) 'PERMZ         (' // TWO // '): ' // TRIM(STR1) // ' m2'

         WRITE(STR1,'(E10.3)') SPROP%PERMX(ISPEC)
         WRITE (LUDOTOUT,90) 'PERMX         (' // TWO // '): ' // TRIM(STR1) // ' m2'

         WRITE(STR1,'(E10.3)') SPROP%PERMY(ISPEC)
         WRITE (LUDOTOUT,90) 'PERMY         (' // TWO // '): ' // TRIM(STR1) // ' m2'
      ENDIF

      WRITE(STR1,'(F9.2)') SPROP%TMELT(ISPEC)
      WRITE (LUDOTOUT,90) 'TMELT         (' // TWO // '): ' // TRIM(STR1) // ' K'

      WRITE(STR1,'(E10.3)') SPROP%DHMELT(ISPEC)
      WRITE (LUDOTOUT,90) 'DHMELT        (' // TWO // '): ' // TRIM(STR1) // ' J/kg'

      WRITE(STR1,'(F9.3)') SPROP%SIGMA2MELT(ISPEC)
      WRITE (LUDOTOUT,90) 'SIGMA2MELT    (' // TWO // '): ' // TRIM(STR1) // ' K2'

      WRITE(STR1,'(F9.1)') SPROP%GAMMA(ISPEC)
      WRITE (LUDOTOUT,90) 'GAMMA         (' // TWO // '): ' // TRIM(STR1) // ' m'

      WRITE(STR1,'(F9.5)') SPROP%PORE_DIAMETER(ISPEC)
      WRITE (LUDOTOUT,90) 'PORE_DIAMETER (' // TWO // '): ' // TRIM(STR1) // ' m'

      WRITE (LUDOTOUT,*)
   ENDDO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
   WRITE(LUDOTOUT,*)
   WRITE(LUDOTOUT,90) '*** Gas Properties *** '
   WRITE(LUDOTOUT,*)

   WRITE(TWO,'(I2.2)') GPROP%IBG
   WRITE(LUDOTOUT,90) 'Background species index: ' // TWO

   WRITE(TWO,'(I2.2)') GPROP%IO2
   WRITE(LUDOTOUT,90) 'Oxygen species index: ' // TWO

   WRITE(STR1,'(F9.4)') GPROP%CPG
   WRITE(LUDOTOUT,90) 'Gaseous specific heat capacity: ' // TRIM(STR1) // ' J/kg-K'    

   WRITE(LUDOTOUT,*)

   WRITE(LUDOTOUT,89) 'Number of gas species: ', GPROP%NGSPEC
   WRITE(LUDOTOUT,*)
   
   DO ISPEC = 1, GPROP%NGSPEC

      WRITE(TWO,'(I2.2)') ISPEC

      WRITE(LUDOTOUT,90) 'NAME          (' // TWO // '): ' // TRIM(GPROP%NAME(ISPEC))
      
      WRITE(STR1,'(F9.2)') GPROP%M(ISPEC)
      WRITE(LUDOTOUT,90) 'M             (' // TWO // '): ' // TRIM(STR1) // ' g/mol'

      WRITE(STR1,'(F9.3)') GPROP%SIGMA(ISPEC)
      WRITE(LUDOTOUT,90) 'SIGMA         (' // TWO // '): ' // TRIM(STR1) // ' Angstroms'

      WRITE(STR1,'(F9.3)') GPROP%EPSOK(ISPEC)
      WRITE(LUDOTOUT,90) 'EPSOK         (' // TWO // '): ' // TRIM(STR1) // ' K'

      WRITE(LUDOTOUT,*)
   ENDDO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
   WRITE(LUDOTOUT,*)
   WRITE(LUDOTOUT,90) '*** Condensed-phase/heterogeneous reactions *** '
   WRITE(LUDOTOUT,*)

   WRITE(LUDOTOUT,89) 'Number of condensed-phase/heterogeneous reactions: ', SPROP%NRXN
   WRITE(LUDOTOUT,*)

   DO IRXN = 1, SPROP%NRXN

      WRITE(TWO,'(I2.2)') IRXN

      WRITE (LUDOTOUT,90) 'CFROM         (' // TWO // '): ' // TRIM(RXN(IRXN)%CFROM)
      WRITE (LUDOTOUT,90) 'CTO           (' // TWO // '): ' // TRIM(RXN(IRXN)%CTO)

      WRITE(STR1,'(E10.3)') RXN(IRXN)%Z
      WRITE(LUDOTOUT,90) 'Z             (' // TWO // '): ' // TRIM(STR1) // ' 1/s'

      WRITE(STR1,'(F9.3)') RXN(IRXN)%E
      WRITE(LUDOTOUT,90) 'E             (' // TWO // '): ' // TRIM(STR1) // ' kJ/mol'

      WRITE(STR1,'(E10.3)') RXN(IRXN)%DHS
      WRITE(LUDOTOUT,90) 'DHS           (' // TWO // '): ' // TRIM(STR1) // ' J/kg'

      WRITE(STR1,'(E10.3)') RXN(IRXN)%DHV
      WRITE(LUDOTOUT,90) 'DHV           (' // TWO // '): ' // TRIM(STR1) // ' J/kg'

      WRITE(STR1,'(F9.4)') RXN(IRXN)%CHI
      WRITE(LUDOTOUT,90) 'CHI           (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(F9.4)') RXN(IRXN)%ORDER
      WRITE(LUDOTOUT,90) 'ORDER         (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(F9.4)') RXN(IRXN)%ORDERO2
      WRITE(LUDOTOUT,90) 'ORDERO2       (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(I2.2)') RXN(IRXN)%IKINETICMODEL
      WRITE(LUDOTOUT,90) 'IKINETICMODEL (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(I2.2)') RXN(IRXN)%IO2TYPE
      WRITE(LUDOTOUT,90) 'IO2TYPE       (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(F9.4)') RXN(IRXN)%M
      WRITE(LUDOTOUT,90) 'M             (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(F9.4)') RXN(IRXN)%KCAT
      WRITE(LUDOTOUT,90) 'KCAT          (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(I2.2)') RXN(IRXN)%ICAT
      WRITE(LUDOTOUT,90) 'ICAT          (' // TWO // '): ' // TRIM(STR1) // ' (-)'

      WRITE(STR1,'(F9.4)') RXN(IRXN)%TCRIT
      WRITE(LUDOTOUT,90) 'TCRIT         (' // TWO // '): ' // TRIM(STR1) // ' (-)'
      
      WRITE(LUDOTOUT,*)    
   ENDDO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
   WRITE(LUDOTOUT,90) '*** Gaseous species yield matrix from condensed/heterogeneous reactions *** '
   WRITE(LUDOTOUT,90) '*** Only nonzero values shown *** '
   WRITE(LUDOTOUT,*)

   DO ISPEC = 1, GPROP%NGSPEC
      DO IRXN = 1, SPROP%NRXN
         IF (GPROP%YIELDS(ISPEC,IRXN) .NE. 0D0) THEN
             WRITE(LUDOTOUT,91) 'Yield for species ', ISPEC, ' from reaction ', IRXN, ': ', GPROP%YIELDS(ISPEC,IRXN)
         ENDIF
      ENDDO
   ENDDO

   WRITE(LUDOTOUT,*)

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
   IF (GPROP%NHGRXN .GT. 0) THEN
      WRITE(LUDOTOUT,90) '*** Gas-phase/homogeneous reactions *** '
      WRITE(LUDOTOUT,*)

      WRITE(LUDOTOUT,89) 'Number of gas-phase/homoogeneous reactions: ', GPROP%NHGRXN
      WRITE(LUDOTOUT,*)

      DO IRXN = 1, GPROP%NHGRXN
         WRITE(TWO,'(I2.2)') IRXN

         WRITE (LUDOTOUT,90) 'CREACTANT1    (' // TWO // '): ' // TRIM(HGRXN(IRXN)%CREACTANT1)
         WRITE (LUDOTOUT,90) 'CREACTANT2    (' // TWO // '): ' // TRIM(HGRXN(IRXN)%CREACTANT2)

         WRITE(STR1,'(E11.3)') HGRXN(IRXN)%Z
         WRITE(LUDOTOUT,90) 'Z             (' // TWO // '): ' // TRIM(STR1) // '  kg, m3, s'

         WRITE(STR1,'(F11.3)') HGRXN(IRXN)%E
         WRITE(LUDOTOUT,90) 'E             (' // TWO // '): ' // TRIM(STR1) // ' kJ/mol'

         WRITE(STR1,'(F11.3)') HGRXN(IRXN)%P
         WRITE(LUDOTOUT,90) 'P             (' // TWO // '): ' // TRIM(STR1) // ' (-)'

         WRITE(STR1,'(F11.3)') HGRXN(IRXN)%Q
         WRITE(LUDOTOUT,90) 'Q             (' // TWO // '): ' // TRIM(STR1) // ' (-)'

         WRITE(STR1,'(F11.3)') HGRXN(IRXN)%B
         WRITE(LUDOTOUT,90) 'B             (' // TWO // '): ' // TRIM(STR1) // ' (-)'

         WRITE(STR1,'(E11.3)') HGRXN(IRXN)%DH
         WRITE(LUDOTOUT,90) 'DH            (' // TWO // '): ' // TRIM(STR1) // ' J/kg'

         WRITE(LUDOTOUT,*)    
      ENDDO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
      WRITE(LUDOTOUT,*)
      WRITE(LUDOTOUT,90) '*** Gaseous species yield matrix from homogeneous gaseous reactions *** '
      WRITE(LUDOTOUT,90) '*** Only nonzero values shown *** '
      WRITE(LUDOTOUT,*)

      DO ISPEC = 1, GPROP%NGSPEC
         DO IRXN = 1, GPROP%NHGRXN
            IF (GPROP%HGYIELDS(ISPEC,IRXN) .NE. 0D0) THEN
                WRITE(LUDOTOUT,91) 'Yield for species ', ISPEC, ' from reaction ', IRXN, ': ', GPROP%HGYIELDS(ISPEC,IRXN)
            ENDIF
         ENDDO
      ENDDO

   ELSE   
      WRITE(LUDOTOUT,90) '*** No gas-phase homogeneous reactions specified. *** '
   ENDIF
   WRITE(LUDOTOUT,*)

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   WRITE(LUDOTOUT,90) '*** Geometry *** '
   WRITE(LUDOTOUT,*)
   
   IF (G%NCELLZ .EQ. 1) THEN 
      WRITE(LUDOTOUT,90) 'Zero-dimensional simulation.'
      WRITE(LUDOTOUT,80) 'Heating rate: ', GPG%BETA(ICASE), " K/min"
   ELSE ! G%NCELLZ .GT. 1
      IF (G%NCELLX .EQ. 1 .AND. G%NCELLY .EQ. 1) WRITE(LUDOTOUT,90) 'One-dimensional simulation.'
      IF (G%NCELLX .GT. 1 .AND. G%NCELLY .EQ. 1) WRITE(LUDOTOUT,90) 'Two-dimensional simulation.'
      IF (G%NCELLX .GT. 1 .AND. G%NCELLY .GT. 1) WRITE(LUDOTOUT,90) 'Three-dimensional simulation.'
   ENDIF
   
   IF (G%NCELLZ .GT. 1) THEN  
      WRITE(LUDOTOUT,82) "z-dimension extends from z = 0.0000 m to z = ", G%Z(G%NCELLZ), " m."
      WRITE(LUDOTOUT,81) "Number of cells in z-direction: ", G%NCELLZ
   ENDIF

   IF (G%NCELLX .GT. 1) THEN  
      WRITE(LUDOTOUT,82) "x-dimension extends from x = 0.0000 m to x = ", G%X(G%NCELLX), " m."
      WRITE(LUDOTOUT,81) "Number of cells in x-direction: ", G%NCELLX
   ENDIF

   IF (G%NCELLY .GT. 1) THEN  
      WRITE(LUDOTOUT,82) "y-dimension extends from y = 0.0000 m to y = ", G%Y(G%NCELLY), " m."
      WRITE(LUDOTOUT,81) "Number of cells in y-direction: ", G%NCELLY
   ENDIF
            
   WRITE(LUDOTOUT,*)
   WRITE(LUDOTOUT,90) '*** Default initial and boundary conditions *** '
   WRITE(LUDOTOUT,*)

   ICISUSED(GPG%DEFAULT_IC(IMESH)) = .TRUE. 
   WRITE(TWO,'(I2.2)') GPG%DEFAULT_IC(IMESH)
   WRITE(LUDOTOUT,90) 'Default initial condition: ' // TWO
   WRITE(LUDOTOUT,*)

   IF (G%NCELLZ .GT. 1) THEN
      WRITE(LUDOTOUT,90) 'Default boundary condtions (can be overridden by obstructions):'
      WRITE(LUDOTOUT,*)

      WRITE(TWO,'(I2.2)') GPG%DEFAULT_SURF_IDX(IMESH,5)
      WRITE(LUDOTOUT,90) 'DEFAULT_SURF_IDX(5) (-z): ' // TWO

      WRITE(TWO,'(I2.2)') GPG%DEFAULT_SURF_IDX(IMESH,6)
      WRITE(LUDOTOUT,90) 'DEFAULT_SURF_IDX(6) (+z): ' // TWO
   ENDIF

   IF (G%NCELLX .GT. 1) THEN
      WRITE(TWO,'(I2.2)') GPG%DEFAULT_SURF_IDX(IMESH,1)
      WRITE(LUDOTOUT,90) 'DEFAULT_SURF_IDX(1) (-x): ' // TWO

      WRITE(TWO,'(I2.2)') GPG%DEFAULT_SURF_IDX(IMESH,2)
      WRITE(LUDOTOUT,90) 'DEFAULT_SURF_IDX(2) (+x): ' // TWO
   ENDIF

   IF (G%NCELLY .GT. 1) THEN
      WRITE(TWO,'(I2.2)') GPG%DEFAULT_SURF_IDX(IMESH,3)
      WRITE(LUDOTOUT,90) 'DEFAULT_SURF_IDX(3) (-y): ' // TWO

      WRITE(TWO,'(I2.2)') GPG%DEFAULT_SURF_IDX(IMESH,4)
      WRITE(LUDOTOUT,90) 'DEFAULT_SURF_IDX(4) (+y): ' // TWO
   ENDIF

   WRITE(LUDOTOUT,90) '*** User-specified obstructions/geometry ***'
   WRITE(LUDOTOUT,*) 

   DO IOBST = 1, GPG%NOBST
      IF (GPG%GEOM(IOBST)%IMESH .NE. IMESH) CYCLE

      WRITE(STR1,'(I3.3)') IOBST
      WRITE(LUDOTOUT,90) 'Obstruction # ' // TRIM(STR1) // ':'

      ICISUSED(GPG%GEOM(IOBST)%ICNUM) = .TRUE. 
      WRITE(TWO,'(I2.2)') GPG%GEOM(IOBST)%ICNUM
      WRITE(LUDOTOUT,90) 'Initial condition: ' // TWO

      IF (G%NCELLZ .GT. 1) THEN
         WRITE(STR1,'(F6.3)') GPG%GEOM(IOBST)%Z1
         WRITE(LUDOTOUT,90) 'z1: ' // TRIM(STR1)
         WRITE(STR1,'(F6.3)') GPG%GEOM(IOBST)%Z2
         WRITE(LUDOTOUT,90) 'z2: ' // TRIM(STR1)
      ENDIF

      IF (G%NCELLX .GT. 1) THEN
         WRITE(STR1,'(F6.3)') GPG%GEOM(IOBST)%X1
         WRITE(LUDOTOUT,90) 'x1: ' // TRIM(STR1)
         WRITE(STR1,'(F6.3)') GPG%GEOM(IOBST)%X2
         WRITE(LUDOTOUT,90) 'x2: ' // TRIM(STR1)
      ENDIF

      IF (G%NCELLY .GT. 1) THEN
         WRITE(STR1,'(F6.3)') GPG%GEOM(IOBST)%Y1
         WRITE(LUDOTOUT,90) 'y1: ' // TRIM(STR1)
         WRITE(STR1,'(F6.3)') GPG%GEOM(IOBST)%Y2
         WRITE(LUDOTOUT,90) 'y2: ' // TRIM(STR1)
      ENDIF

      IF (G%NCELLZ .GT. 1) THEN
         WRITE(TWO,'(I2.2)') GPG%GEOM(IOBST)%SURF_IDX(5)
         WRITE(LUDOTOUT,90) 'SURF_IDX(5) (-z): ' // TWO

         WRITE(TWO,'(I2.2)') GPG%GEOM(IOBST)%SURF_IDX(6)
         WRITE(LUDOTOUT,90) 'SURF_IDX(6) (+z): ' // TWO
      ENDIF

      IF (G%NCELLX .GT. 1) THEN
         WRITE(TWO,'(I2.2)') GPG%GEOM(IOBST)%SURF_IDX(1)
         WRITE(LUDOTOUT,90) 'SURF_IDX(1) (-x): ' // TWO

         WRITE(TWO,'(I2.2)') GPG%GEOM(IOBST)%SURF_IDX(2)
         WRITE(LUDOTOUT,90) 'SURF_IDX(2) (+x): ' // TWO
      ENDIF

      IF (G%NCELLY .GT. 1) THEN
         WRITE(TWO,'(I2.2)') GPG%GEOM(IOBST)%SURF_IDX(3)
         WRITE(LUDOTOUT,90) 'SURF_IDX(3) (-y): ' // TWO

         WRITE(TWO,'(I2.2)') GPG%GEOM(IOBST)%SURF_IDX(4)
         WRITE(LUDOTOUT,90) 'SURF_IDX(4) (+y): ' // TWO
      ENDIF
      
      WRITE(LUDOTOUT,*)

   ENDDO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   WRITE(LUDOTOUT,90) '*** Initial conditions *** '
   WRITE(LUDOTOUT,*)

   DO IC = 1, 100
      IF (.NOT. ICISUSED(IC)) CYCLE

      WRITE(STR1,'(I3.3)') IC
      WRITE(LUDOTOUT,90) 'Initial condition # ' // TRIM(STR1) // ':'

      WRITE(STR1,'(F7.2)') GPG%INITIAL_CONDITIONS(IC)%TMP_INITIAL
      WRITE(LUDOTOUT,90) 'TMP_INITIAL: ' // TRIM(STR1)
      
      IF (GPG%SOLVE_GAS_ENERGY) THEN
         WRITE(STR1,'(F7.2)') GPG%INITIAL_CONDITIONS(IC)%TMPG_INITIAL
         WRITE(LUDOTOUT,90) 'TMPG_INITIAL: ' // TRIM(STR1) 
      ENDIF

      IF (GPG%SOLVE_PRESSURE) THEN
         WRITE(STR1,'(F9.1)') GPG%INITIAL_CONDITIONS(IC)%P_INITIAL
         WRITE(LUDOTOUT,90) 'P_INITIAL: ' // TRIM(STR1) 
      ENDIF

      DO ISPEC = 1, SPROP%NSSPEC
         WRITE(TWO,'(I2.2)') ISPEC
         WRITE(STR1,'(F7.4)') GPG%INITIAL_CONDITIONS(IC)%YI0(ISPEC)
         WRITE(LUDOTOUT,90) 'YI0(' // TWO // '): ' // TRIM(STR1) 
      ENDDO
      
      IF (GPG%SOLVE_GAS_YJ) THEN
         DO ISPEC = 1, GPROP%NGSPEC
            WRITE(TWO,'(I2.2)') ISPEC
            WRITE(STR1,'(F7.4)') GPG%INITIAL_CONDITIONS(IC)%YJ0(ISPEC)
            WRITE(LUDOTOUT,90) 'YJ0(' // TWO // '): ' // TRIM(STR1) 
         ENDDO
      ENDIF
      
      WRITE(LUDOTOUT,*)

   ENDDO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   WRITE(LUDOTOUT,90) '*** Boundary conditions *** '
   WRITE(LUDOTOUT,*)

   DO ISURF = 1, GPG%NSURF_IDX

      WRITE(STR1,'(I3.3)') ISURF
      WRITE(LUDOTOUT,90) 'BC #: ' // TRIM(STR1)

      WRITE(STR1,'(I3.3)') GPG%ALLBC(ISURF)%SURF_IDX
      WRITE(LUDOTOUT,90) 'SURF_IDX: ' // TRIM(STR1)

      WRITE(STR1,'(F9.2)') GPG%ALLBC(ISURF)%T
      WRITE(LUDOTOUT,90) 'T: ' // TRIM(STR1)

      IF (GPG%ALLBC(ISURF)%TFIXED .GT. 0.) THEN
         WRITE(STR1,'(F7.2)') GPG%ALLBC(ISURF)%TFIXED
         WRITE(LUDOTOUT,90) 'TFIXED: ' // TRIM(STR1)
      ELSE
         WRITE(STR1,'(F12.2)') GPG%ALLBC(ISURF)%QE
         WRITE(LUDOTOUT,90) 'QE: ' // TRIM(STR1)

         WRITE(STR1,'(F6.1)') GPG%ALLBC(ISURF)%HC
         WRITE(LUDOTOUT,90) 'HC: ' // TRIM(STR1)

!         WRITE(STR1,'(F5.2)') GPG%ALLBC(ISURF)%NHC
!         WRITE(LUDOTOUT,90) 'NHC: ' // TRIM(STR1) // ' (not used)'

         WRITE(STR1,'(F7.2)') GPG%ALLBC(ISURF)%TINF
         WRITE(LUDOTOUT,90) 'TINF: ' // TRIM(STR1)

         WRITE(STR1,*) GPG%ALLBC(ISURF)%RERADIATION
         WRITE(LUDOTOUT,90) 'RERADIATION: ' // TRIM(STR1)
      ENDIF

      IF (GPG%SOLVE_PRESSURE) THEN
         IF (GPG%ALLBC(ISURF)%PRES .GT. 0.) THEN
            WRITE(STR1,'(F9.2)') GPG%ALLBC(ISURF)%PRES
            WRITE(LUDOTOUT,90) 'PRES: ' // TRIM(STR1)
         ELSE
            WRITE(STR1,'(F5.2)') GPG%ALLBC(ISURF)%MDOTPP
            WRITE(LUDOTOUT,90) 'MDOTPP: ' // TRIM(STR1)
         ENDIF
      ENDIF

      IF (GPG%SOLVE_GAS_ENERGY) THEN
         IF (GPG%ALLBC(ISURF)%TFIXEDG .GT. 0.) THEN
            WRITE(STR1,'(F7.2)') GPG%ALLBC(ISURF)%TFIXEDG
            WRITE(LUDOTOUT,90) 'TFIXEDG: ' // TRIM(STR1)
         ELSE
            WRITE(STR1,'(F9.2)') GPG%ALLBC(ISURF)%QEG
            WRITE(LUDOTOUT,90) 'QEG: ' // TRIM(STR1)

            WRITE(STR1,'(F6.1)') GPG%ALLBC(ISURF)%HCG
            WRITE(LUDOTOUT,90) 'HCG: ' // TRIM(STR1)

            WRITE(STR1,'(F7.2)') GPG%ALLBC(ISURF)%TINFG
            WRITE(LUDOTOUT,90) 'TINFG: ' // TRIM(STR1)
         ENDIF
      ENDIF

      IF (GPG%SOLVE_GAS_YJ) THEN
         WRITE(STR1,'(F6.1)') GPG%ALLBC(ISURF)%HM
         WRITE(LUDOTOUT,90) 'HM: ' // TRIM(STR1)
         
         DO ISPEC = 1, GPROP%NGSPEC
            WRITE(TWO,'(I2.2)') ISPEC
            WRITE(STR1,'(F7.4)') GPG%ALLBC(ISURF)%YJINF(ISPEC)
            WRITE(LUDOTOUT,90) 'YJINF(' // TWO // '): ' // TRIM(STR1)
         ENDDO
      ENDIF
      
      WRITE(LUDOTOUT,*)

   ENDDO

ELSE 

!   MINTMP = MINVAL(G%TPN(:,:,:))
! Limit reporting of minimum temperature to cells that are not masked:
   MINTMP = 9D9
   DO IY = 1, G%NCELLY
   DO IX = 1, G%NCELLX
   DO IZ = 1, G%NCELLZ
      IF (G%IMASK(IZ,IX,IY) .NE. 0 .AND. G%TPN(IZ,IX,IY) .LT. MINTMP) MINTMP = G%TPN(IZ,IX,IY)
   ENDDO
   ENDDO
   ENDDO
   
   WRITE(LUDOTOUT,*)
   WRITE(LUDOTOUT,90) ' ******************************************************************************* '
   WRITE(LUDOTOUT,98) ' Simulation time: ', TI, ' s     Timestep: ', GPG%DT, ' s     # of iterations: ', GPG%NTDMAITS 
   WRITE(LUDOTOUT,99) ' Minimum temperature: ', MINTMP-273.15D0, ' deg C         Maximum temperature: ', GPG%MAXTMP - 273.15D0, ' deg C'
   WRITE(LUDOTOUT,99) ' Elapsed wall clock time: ', WALL_CLOCK_TIME_THANKS_FDS() - GPG%GPYRO_WALL_CLOCK_START, ' s'
   WRITE(LUDOTOUT,90) " ******************************************************************************* "
ENDIF

! Check for NaN
IF (GPG%MAXTMP .NE. GPG%MAXTMP) THEN
   MESSAGE='Shutting down because NaN occurred.'
   CALL SHUTDOWN_GPYRO(MESSAGE)
ENDIF

98 FORMAT(A,F10.2,A,F8.5,A,I4)
99 FORMAT(A,F9.2,A,F8.2,A)
80 FORMAT(A,F8.2,A)
81 FORMAT(A,I4)
82 FORMAT(A,F8.4,A)
89 FORMAT(A,I2)
90 FORMAT(A)
91 FORMAT(A,I2.2,A,I2.2,A,F8.5)
92 FORMAT(' ',I4,'  ',F9.4,F9.4,F9.4,F9.4,E10.2,E10.2,F9.2,20(F9.4))
93 FORMAT(' ',I4,'  ',F9.1,F9.4,F9.4,F9.4,F9.4,F9.2)
94 FORMAT(' ',I4,'  ',F9.1,F9.4,F9.4,F9.4,F9.4,F9.1,F9.2,F9.2,L8)
95 FORMAT(' ',I4,'  ',F9.1,F9.4,F9.4,F9.4,F9.4,F9.1,F9.2,F11.3)
96 FORMAT(' ',I4,'  ',F9.1,F9.4,F9.4,F9.4,F9.4,F9.4,20(F9.4))

!******************************************************************************
END SUBROUTINE WRITE_DOTOUT_FILE
!******************************************************************************

!******************************************************************************
SUBROUTINE DUMP_GPYRO(IMESH,ICASE,TI)
!******************************************************************************
! This is the main dump subroutine.  It contains several sub-subroutines. 

USE GPYRO_FUNCS

INTEGER, INTENT(IN) :: IMESH,ICASE
REAL(EB), INTENT(IN) :: TI
REAL(EB) :: TSTART,TEND
LOGICAL :: TZERO

CALL GET_CPU_TIME(TSTART) !Used to calculate time required for dumping

IF (GPG%DUMP_INTERMEDIATE_TIMINGS) CALL DUMP_TIMINGS(IMESH) !Dump CPU timings
      
TZERO = .FALSE.; IF (TI .EQ. 0D0) TZERO = .TRUE.
      
GPG%MAXTMP = MAXVAL(G%TPN(:,:,:))
IF (GPG%SOLVE_GAS_ENERGY .AND. (.NOT. GPG%THERMAL_EQUILIBRIUM)) THEN
   GPG%MAXTMP = MAX(GPG%MAXTMP,MAXVAL(G%TGN(:,:,:)))
ENDIF

! Dump point data. 
IF (TI - GPG%TDUMPLAST_POINT(IMESH) .GE. GPG%DTDUMP_POINT .OR. TZERO .OR. GPG%MAXTMP .GT. GPG%TMP_REDUCED_DTDUMP .AND. TI-GPG%TDUMPLAST_POINT(IMESH) .GE. GPG%REDUCED_DTDUMP ) THEN 
   CALL DUMP_POINT_QUANTITIES(ICASE,IMESH,G%NCELLZ,G%NCELLX,G%NCELLY)
   GPG%TDUMPLAST_POINT(IMESH) = TI
ENDIF

! Dump a Smokeview output file if requested by the user:
IF (TI - GPG%TDUMPLAST_SMOKEVIEW(IMESH) .GE. GPG%DTDUMP_SMOKEVIEW .OR. TZERO .OR. GPG%MAXTMP .GT. GPG%TMP_REDUCED_DTDUMP .AND. TI-GPG%TDUMPLAST_SMOKEVIEW(IMESH) .GE. GPG%REDUCED_DTDUMP) THEN 
   IF (G%NCELLX .GT. 1 .AND. GPG%N_SMOKEVIEW_QUANTITIES .GT. 0) CALL DUMP_GPYRO_SMOKEVIEW(IMESH,TI)
   GPG%TDUMPLAST_SMOKEVIEW(IMESH) = TI
ENDIF

! Dump files containing profile data, if requested by user:
IF (TI - GPG%TDUMPLAST_PROFILE(IMESH) .GE. GPG%DTDUMP_PROFILE .OR. TZERO .OR. GPG%MAXTMP .GT. GPG%TMP_REDUCED_DTDUMP .AND. TI-GPG%TDUMPLAST_PROFILE(IMESH) .GE. GPG%REDUCED_DTDUMP) THEN 
   CALL DUMP_GPYRO_PROFILES(IMESH,G%NCELLZ,G%NCELLX,G%NCELLY)
   GPG%TDUMPLAST_PROFILE(IMESH) = TI
ENDIF

! Dump specialized files for data transfer:
IF (GPG%CSVDUMP) THEN
   IF (TI - GPG%TDUMPLAST_CSVDUMP(IMESH) .GE. GPG%DT_CSVDUMP .OR. TZERO) THEN 
      CALL DUMP_GPYRO_CSV(IMESH,G%NCELLZ,G%NCELLX,G%NCELLY,TI)
      GPG%TDUMPLAST_CSVDUMP(IMESH) = TI
   ENDIF
ENDIF

CALL GET_CPU_TIME(TEND)
GPG%TUSED(3) = GPG%TUSED(3) + TEND - TSTART 

CONTAINS

!******************************************************************************
SUBROUTINE DUMP_POINT_QUANTITIES(ICASE,IMESH,NCELLZ,NCELLX,NCELLY)
!******************************************************************************

INTEGER, INTENT(IN) :: ICASE,IMESH,NCELLZ,NCELLX,NCELLY
INTEGER :: I,IZ,IX,IY,ISPEC,IRXN,IXBEST,IYBEST,IZBEST
REAL(EB), DIMENSION(1:SPROP%NSSPEC) :: MPPI
REAL(EB), DIMENSION(1:NCELLZ)  :: TEMPARR
LOGICAL, DIMENSION (1:NCELLX,1:NCELLY) :: CALLED
REAL(EB), TARGET :: TEMPVAR
REAL(EB) :: DIFF, MINDIFF
LOGICAL :: LOPEN
CHARACTER(300) :: FN
CHARACTER(10000) :: WRITESTRING
CHARACTER(100) :: HEADER
CHARACTER(300) :: MESSAGE
CHARACTER(2) :: TWO
CHARACTER(3) :: THREE
CHARACTER(4) :: FOUR
CHARACTER(8) :: SEVEN1,SEVEN2,SEVEN3
CHARACTER(20) :: TEMPSTR

REAL(EB), POINTER :: PTR

G=>GPM(IMESH)
GPBCP(1:,1:,1:,-3:)=>G%GPYRO_BOUNDARY_CONDITION(1:,1:,1:,-3:)
 
CALLED(:,:) = .FALSE.

! Check whether summary file is open, and if not open it:	
INQUIRE(UNIT=LUPOINT,OPENED=LOPEN)

IF (.NOT. LOPEN) THEN
   WRITE(TWO,'(I2.2)') IMESH
   WRITE(FOUR,'(I4.4)') ICASE
   FN = TRIM(GPG%CASENAME) // '_summary_' // TWO // '_' // FOUR // '.csv'
   OPEN(UNIT=LUPOINT,FILE=FN,FORM='FORMATTED',STATUS='REPLACE')

   WRITESTRING = "t,"
   DO I = 1, GPG%N_POINT_QUANTITIES
      IF (GPG%POINT_IMESH(I) .NE. 0 .AND. GPG%POINT_IMESH(I) .NE. IMESH) CYCLE
      WRITE(THREE,'(I3.3)') I
      HEADER = THREE // "_" // TRIM(GPG%POINT_QUANTITY(I)) 
      WRITE(SEVEN1,'(F7.4)') GPG%POINT_Z(I)
      WRITE(SEVEN2,'(F7.4)') GPG%POINT_X(I)
      WRITE(SEVEN3,'(F7.4)') GPG%POINT_Y(I)
      WRITESTRING = TRIM(WRITESTRING) // TRIM(HEADER) // "(" // TRIM(SEVEN1) // "_" // TRIM(SEVEN2) // "_" // TRIM(SEVEN3) // "),"
   ENDDO
   WRITE(LUPOINT,90) TRIM(WRITESTRING)
ENDIF

WRITE(WRITESTRING,'(F15.4,A)') TI,',' 

DO I = 1, GPG%N_POINT_QUANTITIES

   IF (GPG%POINT_IMESH(I) .NE. 0 .AND. GPG%POINT_IMESH(I) .NE. IMESH) CYCLE

! IZ, IX, and IY values are set in subroutine init_gpyro_vars
   IZ = GPG%POINT_IZ(I)
   IX = GPG%POINT_IX(I)
   IY = GPG%POINT_IY(I)

   IF (IX .GT. 0 .AND. IY .GT. 0 .AND. SPROP%NRXN .GT. 0 .AND. (.NOT. GPG%SOLVE_PRESSURE)) THEN
      IF (.NOT. CALLED(IX,IY)) THEN
         CALL CALC_MDOTPPZ(IMESH,G%NCELLZ,IX,IY)
         CALLED(IX,IY) = .TRUE.
      ENDIF          
   ENDIF

   SELECT CASE(GPG%POINT_QUANTITY(I))

      CASE('TEMPERATURE')
         TEMPVAR = G%TPN(IZ,IX,IY) - 273.15D0
         PTR => TEMPVAR

      CASE ('ENTHALPY')
         PTR => G%HPN(IZ,IX,IY)         

      CASE ('YI')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%YIN(ISPEC,IZ,IX,IY)         

      CASE ('XI')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%XIN(ISPEC,IZ,IX,IY)         

      CASE ('CI')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         TEMPVAR = G%RPN(IZ,IX,IY) * G%YIN(ISPEC,IZ,IX,IY)
         PTR => TEMPVAR         

      CASE ('YISUM') !Sum of solid mass fractions
         TEMPVAR = 0D0
         DO ISPEC = 1, SPROP%NSSPEC
            TEMPVAR = TEMPVAR + G%YIN(ISPEC,IZ,IX,IY)
         ENDDO
         PTR => TEMPVAR         

      CASE('REACTION_RATE_K') !Condensed/heterogeneous reaction rate
         IRXN = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%OMEGASDAK(IRXN,IZ,IX,IY)

      CASE ('YJ')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%YJGN(ISPEC,IZ,IX,IY)

      CASE ('CJ') !Gas-phase species concentration
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         TEMPVAR = G%RGN(IZ,IX,IY) * G%POROSSN(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY)
         PTR => TEMPVAR         

      CASE ('YJSUM') !Sum of gaseous mass fractions
         TEMPVAR = 0D0
         DO ISPEC = 1, GPROP%NGSPEC
            TEMPVAR = TEMPVAR + G%YJGN(ISPEC,IZ,IX,IY)   
         ENDDO
         PTR => TEMPVAR         

      CASE('REACTION_RATE_L') !Homogeneous gas-phase reaction rate
         IRXN = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%HGRR(IRXN,IZ,IX,IY)

      CASE ('S') !Source term
         TEMPVAR = G%SHP(IZ,IX,IY) - G%SHM(IZ,IX,IY)
         PTR => TEMPVAR         

      CASE ('THERMAL_CONDUCTIVITY_Z')
         PTR => G%KZ(IZ,IX,IY)

      CASE ('THERMAL_CONDUCTIVITY_X')
         PTR => G%KX(IZ,IX,IY)

      CASE ('THERMAL_CONDUCTIVITY_Y')
         PTR => G%KY(IZ,IX,IY)

      CASE ('BULK_DENSITY')
         PTR => G%RPN(IZ,IX,IY)         

      CASE ('SOLID_DENSITY')
         PTR => G%RSPN(IZ,IX,IY)         

      CASE ('SPECIFIC_HEAT_CAPACITY')
         PTR => G%CPS(IZ,IX,IY)         

      CASE ('PRESSURE')
         TEMPVAR = G%PN(IZ,IX,IY) - GPG%P0
         PTR => TEMPVAR

!      CASE ('MASS_FLUX_TOTAL_Z')
!         IF (GPG%SOLVE_PRESSURE) THEN
!            TEMPVAR = G%MDOTPPDARCYT(IZ,IX,IY) * 1D3
!         ELSE
!            TEMPVAR = G%MDOTPPZ(0,IZ,IX,IY) * 1D3                  
!         ENDIF
!         PTR => TEMPVAR         

! TEST TEST TEST 
      CASE ('MASS_FLUX_TOTAL_Z')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         IF (GPG%SOLVE_PRESSURE) THEN
            IF (ISPEC .EQ. 0) THEN
               TEMPVAR = G%RWORK45(IZ,IX,IY) ! mdotppt
            ELSE !ISPEC .EQ. 0
               IF (G%NEEDSBCT(IZ,IX,IY)) THEN
                  IF (GPBCP(IZ,IX,IY,-3)%PRES .LT. 0D0) THEN ! Fixed mass flux boundary condition
                     IF (GPBCP(IZ,IX,IY,-3)%MFLUX .GE. 0.) THEN ! Mass flux in
                        TEMPVAR = G%RWORK45(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY) - G%RWORK40(IZ,IX,IY) * (GPBCP(IZ,IX,IY,-3)%YJINF(ISPEC) - G%YJGN(ISPEC,IZ,IX,IY) )
                     ELSE ! Mass flux out - same?
                        TEMPVAR = G%RWORK45(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY) - G%RWORK40(IZ,IX,IY) * (GPBCP(IZ,IX,IY,-3)%YJINF(ISPEC) - G%YJGN(ISPEC,IZ,IX,IY) )
                     ENDIF
                  ELSE ! Convection and diffusion
                     TEMPVAR = G%RWORK45(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY) - G%RWORK40(IZ,IX,IY) * (G%YJGN(ISPEC,IZ,IX,IY) - GPBCP(IZ,IX,IY,-3)%YJINF(ISPEC) )
                  ENDIF

               ELSE IF (G%NEEDSBCB(IZ,IX,IY)) THEN
                  IF (GPBCP(IZ,IX,IY,3)%PRES .LT. 0D0) THEN ! Fixed mass flux boundary condition
                     IF (GPBCP(IZ,IX,IY,3)%MFLUX .GE. 0.) THEN ! Mass flux in 
                        TEMPVAR = G%RWORK46(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY) - G%RWORK41(IZ,IX,IY) * (GPBCP(IZ,IX,IY,3)%YJINF(ISPEC) - G%YJGN(ISPEC,IZ,IX,IY) )
                     ELSE ! Mass flux out - same? 
                        TEMPVAR = G%RWORK46(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY) - G%RWORK41(IZ,IX,IY) * (GPBCP(IZ,IX,IY,3)%YJINF(ISPEC) - G%YJGN(ISPEC,IZ,IX,IY) )
                     ENDIF
                  ELSE ! Convection and diffusion
                     TEMPVAR = G%RWORK46(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY) + G%RWORK41(IZ,IX,IY) * (G%YJGN(ISPEC,IZ,IX,IY) - GPBCP(IZ,IX,IY,3)%YJINF(ISPEC) )
                  ENDIF

               ELSE ! Interior cell without boundary condition
                   TEMPVAR = G%RWORK45(IZ,IX,IY) * G%YJGN(ISPEC,IZ,IX,IY) - G%RWORK43(IZ,IX,IY) * (G%YJGN(ISPEC,IZ,IX,IY) - G%YJGN(ISPEC,IZ-1,IX,IY) )
               ENDIF
            ENDIF !ISPEC .EQ. 0
         ELSE !SOLVE_PRESSURE
            TEMPVAR = G%MDOTPPZ(0,IZ,IX,IY)
         ENDIF !SOLVE_PRESSURE
         TEMPVAR = 1000. * TEMPVAR !Convert to g/m2-s
         PTR => TEMPVAR

      CASE ('MASS_FLUX_TOTAL_X')
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPVAR = G%MDOTPPDARCYE(IZ,IX,IY) * 1D3         
         ELSE
            MESSAGE='Error:  cannot dump MASS_FLUX_TOTAL_X unless SOLVE_PRESSURE=.TRUE.'
            CALL SHUTDOWN_GPYRO(MESSAGE)
         ENDIF
         PTR => TEMPVAR         

      CASE ('MASS_FLUX_TOTAL_Y')
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPVAR = G%MDOTPPDARCYS(IZ,IX,IY) * 1D3         
         ELSE
            MESSAGE='Error:  cannot dump MASS_FLUX_TOTAL_Y unless SOLVE_PRESSURE=.TRUE.'
            CALL SHUTDOWN_GPYRO(MESSAGE)
         ENDIF
         PTR => TEMPVAR         

      CASE ('GAS_TEMPERATURE')
         TEMPVAR = G%TGN(IZ,IX,IY) - 273.15D0
         PTR => TEMPVAR         

      CASE ('GAS_ENTHALPY')
         PTR => G%HGN(IZ,IX,IY)         

      CASE ('TG-T')
         TEMPVAR = G%TGN(IZ,IX,IY) - G%TPN(IZ,IX,IY)
         PTR => TEMPVAR         

      CASE ('SHP')
         PTR => G%SHP(IZ,IX,IY)         

      CASE ('SHYIDTDMAZ')
         PTR => G%SHYIDTDMAZ(IZ,IX,IY)         

      CASE ('SHYIDTDMAX')
         PTR => G%SHYIDTDMAX(IZ,IX,IY)         

      CASE ('SHYIDTDMAY')
         PTR => G%SHYIDTDMAY(IZ,IX,IY)         

      CASE ('SHYIAPZ')
         PTR => G%SHYIAPZ(IZ,IX,IY)         

      CASE ('SHYIAPX')
         PTR => G%SHYIAPX(IZ,IX,IY)         

      CASE ('SHYIAPY')
         PTR => G%SHYIAPY(IZ,IX,IY)         

      CASE ('SHM')
         PTR => G%SHM(IZ,IX,IY)         

      CASE ('PERMEABILITY_Z')
         PTR => G%PERMZ(IZ,IX,IY)

      CASE ('PERMEABILITY_X')
         PTR => G%PERMX(IZ,IX,IY)

      CASE ('PERMEABILITY_Y')
         PTR => G%PERMY(IZ,IX,IY)

      CASE ('POROSITY')
         PTR => G%POROSSN(IZ,IX,IY)         

      CASE ('D12')
         PTR => G%D12(IZ,IX,IY)         

      CASE ('SHGP')
         PTR => G%SHGP(IZ,IX,IY)         

      CASE ('SHGM')
         PTR => G%SHGM(IZ,IX,IY)         

      CASE ('QSG')
         PTR => G%QSG(IZ,IX,IY)         

      CASE ('RYIDZSIGMA')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%RYIDZSIGMA(ISPEC,IZ,IX,IY)

      CASE ('UNREACTEDNESS')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%UNREACTEDNESS(ISPEC,IZ,IX,IY)

      CASE ('GOMEGA3')
         PTR => G%GOMEGA(3,0,IZ,IX,IY)

      CASE ('RE')
         PTR => G%RE(IZ,IX,IY)         

      CASE ('NU')
         PTR => G%NU(IZ,IX,IY)         

      CASE ('HCV')
         PTR => G%HCV(IZ,IX,IY)

      CASE ('M/M0')
         TEMPVAR = G%RDLTZN(IZ,IX,IY) / SUM(G%RYIDZ0(1:SPROP%NSSPEC,IZ,IX,IY))
         PTR => TEMPVAR

      CASE ('MLR')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         TEMPVAR = INTEGRATED_MASS_LOSS_RATE(ISPEC)
         PTR => TEMPVAR

      CASE ('GGR')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         TEMPVAR = INTEGRATED_GAS_GENERATION_RATE(ISPEC)
         PTR => TEMPVAR

      CASE ('HRR')
         TEMPVAR = INTEGRATED_HEAT_RELEASE_RATE()
         PTR => TEMPVAR

      CASE ('MDOTPPZ')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         PTR => G%MDOTPPZ(ISPEC,IZ,IX,IY)

      CASE ('MPPI')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         TEMPVAR = SUM(G%RYIDZP(ISPEC,1:G%NCELLZ,IX,IY))
         PTR => TEMPVAR

      CASE ('THICKNESS')
         TEMPVAR = G%DELTAN(IX,IY)
         PTR => TEMPVAR         

      CASE ('DT')
         TEMPVAR = GPG%DT
         PTR => TEMPVAR         

      CASE ('N_ITERATIONS')
         TEMPVAR = REAL(GPG%NTDMAITS,EB)
         PTR => TEMPVAR

      CASE ('CML')
         TEMPVAR=G%INITIAL_MASS - TOTAL_MASS(0) ; PTR => TEMPVAR

      CASE ('TOTAL_MASS')
         ISPEC = GPG%POINT_QUANTITY_INDEX(I)
         TEMPVAR=TOTAL_MASS(ISPEC) ; PTR => TEMPVAR

      CASE ('DLTZN')
         PTR => G%DLTZN(IZ,IX,IY)

      CASE ('DLTXN')
         PTR => G%DLTXN(IZ,IX,IY)

      CASE ('DLTYN')
         PTR => G%DLTYN(IZ,IX,IY)
         
      CASE DEFAULT
         WRITE(*,*) 'Error, point quantity', GPG%POINT_QUANTITY(I), ' not defined.'

   END SELECT
            
   WRITE(TEMPSTR,'(F17.7,A)') PTR,','
   WRITESTRING = TRIM(WRITESTRING) // TRIM(TEMPSTR) 
ENDDO

WRITE(LUPOINT,90) TRIM(WRITESTRING) 
      
 90   FORMAT(A)

!******************************************************************************
END SUBROUTINE DUMP_POINT_QUANTITIES
!******************************************************************************

!******************************************************************************
SUBROUTINE DUMP_GPYRO_CSV(IMESH,NCELLZ,NCELLX,NCELLY,TI)
!******************************************************************************

INTEGER, INTENT(IN) :: IMESH,NCELLZ,NCELLX,NCELLY
REAL(EB), INTENT(IN) :: TI
INTEGER :: I, IX, IY, IZ, IOS, ISPEC
CHARACTER(60) :: FN
CHARACTER(2) :: TWO
CHARACTER(5) :: FIVE
REAL(EB), ALLOCATABLE, DIMENSION(:,:,:), SAVE :: PSI_OLD
REAL(EB), SAVE :: TI_LAST = 0D0
REAL(EB) :: DT, DPSIDT

IF (.NOT. ALLOCATED(PSI_OLD)) THEN
   ALLOCATE(PSI_OLD(1:NCELLZ,1:NCELLX,1:NCELLY))
   PSI_OLD(:,:,:) = 0D0
ENDIF

DT = TI - TI_LAST
IF (DT .LT. 1D-9) DT = 1D0

G=>GPM(IMESH)

WRITE(TWO  ,'(I2.2)') IMESH
WRITE(FIVE ,'(I5.5)') NINT(TI)

FN = TWO // "_" // TRIM(FIVE) // ".csv" 
OPEN(UNIT=LUCSV, FILE=FN, FORM='FORMATTED', STATUS='REPLACE', IOSTAT=IOS)

WRITE(LUCSV,200) 'i,j,k,x (mm),y (mm),z (mm),Dx (mm),Dy (mm),Dz (mm),porosity (-),d psi / dt (1/s), pressure (Pa),temperature (K),Yi1 (-),Yi2 (-),Yi3 (-),Yi4 (-),Yi5 (-),Yi6 (-),Yi7 (-),Yi8 (-),Yi9 (-),Yi10 (-)'

DO IX = 1, G%NCELLX
DO IY = 1, G%NCELLY
DO IZ = 1, G%NCELLZ
   IF (G%IMASK(IZ,IX,IY) .NE. 0) THEN
      IF (TI .LT. 1D-9) THEN
         DPSIDT = 0D0
      ELSE
         DPSIDT = (G%POROSS(IZ,IX,IY) - PSI_OLD(IZ,IX,IY)) / DT
      ENDIF

      WRITE(LUCSV,100) IX, IY, IZ, &
                       1000.*(G%X(IX)-G%DLTX(IZ,1,IY)), 1000.*(G%Y(IY)-G%DLTY(IZ,IX,1)), 1000.*(G%Z(IZ)-G%DLTZ(1,IX,IY)), &
                       1000.*G%DLTXN(IZ,IX,IY), 1000.*G%DLTYN(IZ,IX,IY), 1000.*G%DLTZN(IZ,IX,IY), &
                       G%POROSS(IZ,IX,IY), DPSIDT, G%PN(IZ,IX,IY)-GPG%P0, G%TPN(IZ,IX,IY), &
                       (G%YIN(ISPEC,IZ,IX,IY), ISPEC=1, SPROP%NSSPEC)
   ENDIF
ENDDO
ENDDO
ENDDO

CLOSE(LUCSV)

PSI_OLD(:,:,:) = G%POROSS(:,:,:)
TI_LAST = TI

!           i,j,k      x,y,z        dx,dy,dz     porosity  d psi / dt  pressure  temp       species
!100 FORMAT (3(I3,','), 3(F6.3,','), 3(F5.3,','), F6.4,',', F10.7,',',  F7.4,',', F8.3, ',', 10(F7.5,','))
100 FORMAT (3(I4,','), 3(E11.5,','), 3(E11.5,','), E13.7,',', E13.7,',',  E12.6,',', E14.8, ',', 10(E13.7,','))
200 FORMAT (A)

!******************************************************************************
END SUBROUTINE DUMP_GPYRO_CSV
!******************************************************************************

!******************************************************************************
SUBROUTINE OLD_DUMP_GPYRO_CSV(IMESH,NCELLZ,NCELLX,NCELLY,TI)
!******************************************************************************

INTEGER, INTENT(IN) :: IMESH,NCELLZ,NCELLX,NCELLY
REAL(EB), INTENT(IN) :: TI
INTEGER :: I, IX, IY, IZ, IOS, ISPEC
CHARACTER(60) :: FN
CHARACTER(2) :: TWO
CHARACTER(5) :: FIVE

G=>GPM(IMESH)

WRITE(TWO  ,'(I2.2)') IMESH
WRITE(FIVE ,'(I5.5)') NINT(TI)

FN = TWO // "_" // TRIM(FIVE) // ".csv" 
OPEN(UNIT=LUCSV, FILE=FN, FORM='FORMATTED', STATUS='REPLACE', IOSTAT=IOS)

WRITE(LUCSV,200) 'i,j,k,x (mm),y (mm),z (mm),Dx (mm),Dy (mm),Dz (mm),porosity (-),pressure (Pa),temperature (K),Yi1 (-),Yi2 (-),Yi3 (-),Yi4 (-),Yi5 (-),Yi6 (-),Yi7 (-),Yi8 (-),Yi9 (-),Yi10 (-)'

DO IX = 1, G%NCELLX
DO IY = 1, G%NCELLY
DO IZ = 1, G%NCELLZ
   IF (G%IMASK(IZ,IX,IY) .NE. 0) THEN
      WRITE(LUCSV,100) IX, IY, IZ, &
                       1000.*G%X(IX), 1000.*G%Y(IY), 1000.*G%Z(IZ), &
                       1000.*G%DLTXN(IZ,IX,IY), 1000.*G%DLTYN(IZ,IX,IY), 1000.*G%DLTZN(IZ,IX,IY), &
                       G%POROSS(IZ,IX,IY), G%PN(IZ,IX,IY)-GPG%P0, G%TPN(IZ,IX,IY), &
                       (G%YIN(ISPEC,IZ,IX,IY), ISPEC=1, SPROP%NSSPEC)
   ENDIF
ENDDO
ENDDO
ENDDO

CLOSE(LUCSV)

!           i,j,k      x,y,z        dx,dy,dz     porosity  pressure  temp       species
100 FORMAT (3(I3,','), 3(F6.3,','), 3(F5.3,','), F6.4,',', F7.4,',', F8.3, ',', 10(F7.5,','))
200 FORMAT (A)

!******************************************************************************
END SUBROUTINE OLD_DUMP_GPYRO_CSV
!******************************************************************************
!******************************************************************************
SUBROUTINE DUMP_GPYRO_PROFILES(IMESH,NCELLZ,NCELLX,NCELLY)
!******************************************************************************

INTEGER, INTENT(IN) :: IMESH,NCELLZ,NCELLX,NCELLY
INTEGER :: I, J, N, IZ, IX, IY, ISPEC, ISKIP, IRXN, IOS
REAL(EB), DIMENSION(1:NCELLZ,1:NCELLX,1:NCELLY), TARGET :: TEMPARR
LOGICAL :: LOPEN
CHARACTER(80) :: FN
CHARACTER(2)  :: TWO0,TWO1,TWO2
CHARACTER(1)  :: PROF_DIR
CHARACTER(10000) :: WRITESTRING
CHARACTER(60) :: TEMPSTR
REAL(EB), POINTER, DIMENSION (:) :: PTR

IF (GPG%FIRST_PROF_IN_MESH(IMESH) .LT. 0) RETURN

G=>GPM(IMESH)

! Check to see if output files are open. if not, open them up
! and write headers across top of files:
!INQUIRE(UNIT=LUPROF+1,OPENED=LOPEN)
INQUIRE(UNIT=LUPROF+GPG%FIRST_PROF_IN_MESH(IMESH),OPENED=LOPEN)

IF (.NOT. LOPEN) THEN
   DO I = 1, GPG%N_PROFILE_QUANTITIES

      IF (GPG%PROFILE_IMESH(I) .NE. 0 .AND. GPG%PROFILE_IMESH(I) .NE. IMESH) CYCLE

      WRITE(TWO0,'(I2.2)') IMESH
      WRITE(TWO1,'(I2.2)') I
      IF (TRIM(GPG%PROFILE_QUANTITY(I)) .EQ. 'M/M0') THEN
         FN = TRIM(GPG%CASENAME) // '_profile_' // TWO0 // "_" // TWO1 // "_" // 'MOM0'
      ELSE 
         FN = TRIM(GPG%CASENAME) // '_profile_' // TWO0 // "_" // TWO1 // "_" // TRIM(GPG%PROFILE_QUANTITY(I))
      ENDIF
      IF (GPG%PROFILE_QUANTITY_INDEX(I) .GT. 0) THEN
         WRITE(TWO2,'(I2.2)') GPG%PROFILE_QUANTITY_INDEX(I)
         FN = TRIM(FN) // "(" // TWO2 // ")"
      ENDIF
      FN = TRIM(FN) // ".csv"

      OPEN(UNIT=LUPROF+I, FILE=FN,FORM='FORMATTED', STATUS='REPLACE',IOSTAT=IOS)

      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'PROF IMESH, TI, IOS:', IMESH, TI, IOS
      ENDIF

      IF (GPG%PROFILE_DIRECTION(I) .EQ. 'z' .OR. GPG%PROFILE_DIRECTION(I) .EQ. 'Z') THEN !f(z)
         WRITESTRING = ','
         DO IZ = 1, G%NCELLZ, GPG%PROFILE_ISKIP(I)
            WRITE(TEMPSTR,'(E16.9,A)') G%Z(IZ), ','            
            WRITESTRING = TRIM(WRITESTRING) // TRIM(TEMPSTR)
         ENDDO
         WRITE(LUPROF+I,90) TRIM(WRITESTRING)
         
      ELSE IF (GPG%PROFILE_DIRECTION(I) .EQ. 'x' .OR. GPG%PROFILE_DIRECTION(I) .EQ. 'X') THEN !f(x)
         WRITESTRING = ','
         DO IX = 1, G%NCELLX, GPG%PROFILE_ISKIP(I)
            WRITE(TEMPSTR,'(E16.9,A)') G%X(IX), ','            
            WRITESTRING = TRIM(WRITESTRING) // TRIM(TEMPSTR)
         ENDDO
         WRITE(LUPROF+I,90) TRIM(WRITESTRING)
      ELSE IF (GPG%PROFILE_DIRECTION(I) .EQ. 'y' .OR. GPG%PROFILE_DIRECTION(I) .EQ. 'Y') THEN !f(y)
         WRITESTRING = ','
         DO IY = 1, G%NCELLY, GPG%PROFILE_ISKIP(I)
            WRITE(TEMPSTR,'(E16.9,A)') G%Y(IY), ','            
            WRITESTRING = TRIM(WRITESTRING) // TRIM(TEMPSTR)
         ENDDO
         WRITE(LUPROF+I,90) TRIM(WRITESTRING)
      ENDIF
   ENDDO 
ENDIF
      
DO I = 1, GPG%N_PROFILE_QUANTITIES

   IF (GPG%PROFILE_IMESH(I) .NE. 0 .AND. GPG%PROFILE_IMESH(I) .NE. IMESH) CYCLE

   IF (GPG%PROFILE_DIRECTION(I) .EQ. 'z') THEN !f(z)
      PROF_DIR = 'z'
      IX = GPG%PROFILE_IX(I)
      IY = GPG%PROFILE_IY(I)
      N  = G%NCELLZ
   ELSE IF (GPG%PROFILE_DIRECTION(I) .EQ. 'x') THEN !f(x)
      PROF_DIR = 'x'
      IY = GPG%PROFILE_IY(I)
      IZ = GPG%PROFILE_IZ(I)
      N  = G%NCELLX
   ELSE IF (GPG%PROFILE_DIRECTION(I) .EQ. 'y') THEN !f(y)
      PROF_DIR = 'y'
      IX = GPG%PROFILE_IX(I)
      IZ = GPG%PROFILE_IZ(I)
      N  = G%NCELLY
   ENDIF
         
   SELECT CASE (GPG%PROFILE_QUANTITY(I))

      CASE ('TEMPERATURE')
         TEMPARR(:,:,:) = G%TPN(:,:,:) - 273.15D0
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('ENTHALPY')
         IF (PROF_DIR .EQ. 'z') PTR => G%HPN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%HPN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%HPN(IZ,IX,: )

      CASE ('YI')
         ISPEC = GPG%PROFILE_QUANTITY_INDEX(I)
         IF (PROF_DIR .EQ. 'z') PTR => G%YIN(ISPEC,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%YIN(ISPEC,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%YIN(ISPEC,IZ,IX,: )

      CASE ('XI')
         ISPEC = GPG%PROFILE_QUANTITY_INDEX(I)
         IF (PROF_DIR .EQ. 'z') PTR => G%XIN(ISPEC,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%XIN(ISPEC,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%XIN(ISPEC,IZ,IX,: )

      CASE ('CI')
         ISPEC = GPG%PROFILE_QUANTITY_INDEX(I)
         TEMPARR(:,:,:) = G%RPN(:,:,:) * G%YIN(ISPEC,:,:,:)
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('YISUM') !Sum of solid mass fractions
         TEMPARR(:,:,:) = 0D0
         DO ISPEC = 1, SPROP%NSSPEC
            TEMPARR(:,:,:) = TEMPARR(:,:,:) + G%YIN(ISPEC,:,:,:)
         ENDDO
!         TEMPARR(:,:,:) = TEMPARR(:,:,:) / REAL(SPROP%NSSPEC)
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE('REACTION_RATE_K') !Condensed/heterogeneous reaction rate
         IRXN = GPG%PROFILE_QUANTITY_INDEX(I)
         IF (PROF_DIR .EQ. 'z') PTR => G%OMEGASDAK(IRXN,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%OMEGASDAK(IRXN,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%OMEGASDAK(IRXN,IZ,IX,: )

      CASE ('YJ')
         ISPEC = GPG%PROFILE_QUANTITY_INDEX(I)
         IF (PROF_DIR .EQ. 'z') PTR => G%YJGN(ISPEC,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%YJGN(ISPEC,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%YJGN(ISPEC,IZ,IX,: )

      CASE ('CJ') !Gas-phase species concentration
         ISPEC = GPG%PROFILE_QUANTITY_INDEX(I)
         TEMPARR(:,:,:) = G%RGN(:,:,:) * G%POROSSN(:,:,:) * G%YJGN(ISPEC,:,:,:)
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('YJSUM') !Sum of gaseous mass fractions
         TEMPARR(:,:,:) = 0D0
         DO ISPEC = 1, GPROP%NGSPEC
            TEMPARR(:,:,:) = TEMPARR(:,:,:) + G%YJGN(ISPEC,:,:,:)
         ENDDO
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE('REACTION_RATE_L') !Homogeneous reaction rate
         IRXN = GPG%PROFILE_QUANTITY_INDEX(I)
         IF (PROF_DIR .EQ. 'z') PTR => G%HGRR(IRXN,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%HGRR(IRXN,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%HGRR(IRXN,IZ,IX,: )

      CASE ('S') !Source term
         TEMPARR(:,:,:) = G%SHP(:,:,:) - G%SHM(:,:,:)
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('THERMAL_CONDUCTIVITY_Z')
         IF (PROF_DIR .EQ. 'z') PTR => G%KZ(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%KZ(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%KZ(IZ,IX,: )

      CASE ('THERMAL_CONDUCTIVITY_X')
         IF (PROF_DIR .EQ. 'z') PTR => G%KX(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%KX(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%KX(IZ,IX,: )

      CASE ('THERMAL_CONDUCTIVITY_Y')
         IF (PROF_DIR .EQ. 'z') PTR => G%KY(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%KY(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%KY(IZ,IX,: )

      CASE ('BULK_DENSITY')
         IF (PROF_DIR .EQ. 'z') PTR => G%RPN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%RPN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%RPN(IZ,IX,: )

      CASE ('SOLID_DENSITY')
         IF (PROF_DIR .EQ. 'z') PTR => G%RSPN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%RSPN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%RSPN(IZ,IX,: )

      CASE ('SPECIFIC_HEAT_CAPACITY')
         IF (PROF_DIR .EQ. 'z') PTR => G%CPS(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%CPS(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%CPS(IZ,IX,: )

      CASE ('PRESSURE')
         TEMPARR(:,:,:) = G%PN(:,:,:) - GPG%P0
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('MASS_FLUX_TOTAL_Z') !z-direction mass flux
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPARR(:,:,:) = G%MDOTPPDARCYT(:,:,:) * 1D3
         ELSE
            TEMPARR(:,:,:) = G%MDOTPPZ   (0,:,:,:) * 1D3
         ENDIF         
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('MASS_FLUX_TOTAL_X') !x-direction mass flux
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPARR(:,:,:) = G%MDOTPPDARCYE(:,:,:) * 1D3
         ELSE
            CONTINUE !x-direction mass flux is zero unless pressure equation is solved
         ENDIF
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('MASS_FLUX_TOTAL_Y') !y-direction mass flux
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPARR(:,:,:) = G%MDOTPPDARCYS(:,:,:) * 1D3
         ELSE
            CONTINUE !y-direction mass flux is zero unless pressure equation is solved
         ENDIF
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('GAS_TEMPERATURE')
         TEMPARR(:,:,:) = G%TGN(:,:,:) - 273.15D0
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('GAS_ENTHALPY')
         IF (PROF_DIR .EQ. 'z') PTR => G%HGN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%HGN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%HGN(IZ,IX,: )

      CASE ('TG-T')
         TEMPARR(:,:,:) = G%TGN(:,:,:) - G%TPN(:,:,:)
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('SHP')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHP(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHP(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHP(IZ,IX,: )

      CASE ('SHM')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHM(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHM(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHM(IZ,IX,: )

      CASE ('SHYIDTDMAZ')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHYIDTDMAZ(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHYIDTDMAZ(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHYIDTDMAZ(IZ,IX,: )

      CASE ('SHYIDTDMAX')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHYIDTDMAX(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHYIDTDMAX(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHYIDTDMAX(IZ,IX,: )

      CASE ('SHYIDTDMAY')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHYIDTDMAY(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHYIDTDMAY(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHYIDTDMAY(IZ,IX,: )

      CASE ('SHYIAPZ')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHYIAPZ(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHYIAPZ(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHYIAPZ(IZ,IX,: )

      CASE ('SHYIAPX')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHYIAPX(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHYIAPX(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHYIAPX(IZ,IX,: )

      CASE ('SHYIAPY')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHYIAPY(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHYIAPY(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHYIAPY(IZ,IX,: )

      CASE ('PERMEABILITY_Z')
         IF (PROF_DIR .EQ. 'z') PTR => G%PERMZ(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%PERMZ(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%PERMZ(IZ,IX,: )

      CASE ('PERMEABILITY_X')
         IF (PROF_DIR .EQ. 'z') PTR => G%PERMX(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%PERMX(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%PERMX(IZ,IX,: )

      CASE ('PERMEABILITY_Y')
         IF (PROF_DIR .EQ. 'z') PTR => G%PERMY(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%PERMY(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%PERMY(IZ,IX,: )

      CASE ('POROSITY')
         IF (PROF_DIR .EQ. 'z') PTR => G%POROSSN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%POROSSN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%POROSSN(IZ,IX,: )

      CASE ('D12')
         IF (PROF_DIR .EQ. 'z') PTR => G%D12(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%D12(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%D12(IZ,IX,: )

      CASE ('SHGP')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHGP(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHGP(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHGP(IZ,IX,: )

      CASE ('SHGM')
         IF (PROF_DIR .EQ. 'z') PTR => G%SHGM(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%SHGM(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%SHGM(IZ,IX,: )

      CASE ('QSG')
         IF (PROF_DIR .EQ. 'z') PTR => G%QSG(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%QSG(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%QSG(IZ,IX,: )

      CASE ('RYIDZSIGMA')
         ISPEC = GPG%PROFILE_QUANTITY_INDEX(I)
         IF (PROF_DIR .EQ. 'z') PTR => G%RYIDZSIGMAN(ISPEC,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%RYIDZSIGMAN(ISPEC,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%RYIDZSIGMAN(ISPEC,IZ,IX,: )

      CASE ('UNREACTEDNESS')
         ISPEC = GPG%PROFILE_QUANTITY_INDEX(I)
         IF (PROF_DIR .EQ. 'z') PTR => G%UNREACTEDNESS(ISPEC,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%UNREACTEDNESS(ISPEC,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%UNREACTEDNESS(ISPEC,IZ,IX,: )

      CASE ('GOMEGA3')
         IF (PROF_DIR .EQ. 'z') PTR => G%GOMEGA(3,0,: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%GOMEGA(3,0,IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%GOMEGA(3,0,IZ,IX,: )

      CASE ('RE')
         IF (PROF_DIR .EQ. 'z') PTR => G%RE(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%RE(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%RE(IZ,IX,: )

      CASE ('NU')
         IF (PROF_DIR .EQ. 'z') PTR => G%NU(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%NU(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%NU(IZ,IX,: )

      CASE ('HCV')
         IF (PROF_DIR .EQ. 'z') PTR => G%HCV(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%HCV(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%HCV(IZ,IX,: )

      CASE ('M/M0')
         TEMPARR(:,:,:) = 0D0
         DO ISPEC = 1, SPROP%NSSPEC
            TEMPARR(:,:,:) = TEMPARR(:,:,:) + G%RYIDZ0(ISPEC,:,:,:)
         ENDDO
         TEMPARR(:,:,:) = G%RDLTZN(:,:,:) / TEMPARR(:,:,:)
         IF (PROF_DIR .EQ. 'z') PTR => TEMPARR(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => TEMPARR(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => TEMPARR(IZ,IX,: )

      CASE ('DLTZN')
         IF (PROF_DIR .EQ. 'z') PTR => G%DLTZN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%DLTZN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%DLTZN(IZ,IX,: )

      CASE ('DLTXN')
         IF (PROF_DIR .EQ. 'z') PTR => G%DLTXN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%DLTXN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%DLTXN(IZ,IX,: )

      CASE ('DLTYN')
         IF (PROF_DIR .EQ. 'z') PTR => G%DLTYN(: ,IX,IY)
         IF (PROF_DIR .EQ. 'x') PTR => G%DLTYN(IZ,: ,IY)
         IF (PROF_DIR .EQ. 'y') PTR => G%DLTYN(IZ,IX,: )

      CASE DEFAULT
         WRITE(*,*) 'Error, profile quantity', GPG%PROFILE_QUANTITY(I), ' not defined.'

   END SELECT

   WRITE(WRITESTRING,'(E16.9,A)') TI, ','
   DO J = 1, N, GPG%PROFILE_ISKIP(I)
      WRITE(TEMPSTR,'(E16.9,A)') PTR(J), ','
      WRITESTRING = TRIM(WRITESTRING) // TRIM(TEMPSTR)
   ENDDO
   WRITE(LUPROF+I,90) TRIM(WRITESTRING) 
ENDDO

90 FORMAT(A)

!******************************************************************************
END SUBROUTINE DUMP_GPYRO_PROFILES
!******************************************************************************

!******************************************************************************
SUBROUTINE DUMP_GPYRO_SMOKEVIEW(IMESH,TI)
!******************************************************************************

INTEGER, INTENT(IN) :: IMESH
REAL(EB), INTENT(IN) :: TI
CHARACTER(300) TITLE, ENDIAN, HEADER, FN
CHARACTER(30) FNSF, LONGNAME, SHORTNAME, UNITS

REAL(EB) XMIN,XMAX,YMIN,YMAX,ZMIN,ZMAX,SUMMATION
REAL(FB) :: STIME
CHARACTER(20) :: VERSION_STRING = 'FDS 6.4.0'
CHARACTER(2)  :: TWO
CHARACTER(4)  :: FOUR !TEMPORARY

INTEGER IZ,IX,IY,IBAR,JBAR,KBAR,ONE_INTEGER,N,I,J,K,I1,I2,J1,J2,K1,K2,NFISTBC,LUSF,KI, &
        NMESHES,NM,ISPEC,IRXN,ICOUNT,IMASKVALTODUMP,IOS

LOGICAL :: LOPEN
INTEGER, ALLOCATABLE, DIMENSION(:) :: NOC

REAL(FB), ALLOCATABLE, DIMENSION (:,:,:) :: QQ
REAL(EB), ALLOCATABLE, TARGET, DIMENSION (:,:,:) :: TEMPARR
REAL(FB) :: ADD
REAL(EB), POINTER , DIMENSION (:,:,:) :: QQPTR
REAL(EB), ALLOCATABLE, DIMENSION(:,:,:) :: QQTEMP, B, S, QQMID

REAL(EB), ALLOCATABLE, DIMENSION(:) :: TRNX,TRNY,TRNZ

IF (GPG%FIRST_SF_IN_MESH(IMESH) .LT. 0) RETURN

G=>GPM(IMESH)

ALLOCATE(NOC(3)); NOC(:)= 0

TITLE = 'Gpyro slice files'

XMIN = 0D0
XMAX = G%X(G%NCELLX) 

IF (G%NCELLY .EQ. 1) THEN
   YMIN = -0.00001
   YMAX =  0.00001
ELSE
   YMIN = 0D0
   YMAX = G%Y(G%NCELLY) 
ENDIF

ZMIN = 0D0
ZMAX = G%Z(G%NCELLZ)

ONE_INTEGER = 1
NMESHES = 1 !Number of meshes

I1   = 0
I2   = G%NCELLX ; IBAR  = G%NCELLX

J1   = 0
J2   = G%NCELLY ; JBAR  = G%NCELLY

K1   = 0
K2   = G%NCELLZ ; KBAR = G%NCELLZ 

STIME = TI !Single precision
HEADER = TRIM(GPG%CASENAME)

ALLOCATE(QQ     (0:IBAR+1,0:JBAR+1,0:KBAR+1)) ; QQ     (:,:,:) = 0D0
ALLOCATE(QQTEMP (0:IBAR+1,0:JBAR+1,0:KBAR+1)) ; QQTEMP (:,:,:) = 0D0
ALLOCATE(QQMID  (0:KBAR+1,0:IBAR+1,0:JBAR+1)) ; QQMID  (:,:,:) = 0D0
ALLOCATE(B      (0:IBAR+1,0:JBAR+1,0:KBAR+1)) ; B      (:,:,:) = 0D0
ALLOCATE(S      (0:IBAR+1,0:JBAR+1,0:KBAR+1)) ; S      (:,:,:) = 0D0
ALLOCATE(TEMPARR(1:KBAR,1:IBAR,1:JBAR))       ; TEMPARR(:,:,:) = 0D0

! Open new smokeview file for solid-phase quantities

IF (.NOT. G%SMOKEVIEW_FILE_OPENED_ALREADY) THEN
   
   G%SMOKEVIEW_FILE_OPENED_ALREADY = .TRUE. 
   WRITE(TWO,'(I2.2)') IMESH
   FN     = TRIM(HEADER) // '_' // TWO // '.smv'
   OPEN(LUSMV,FILE=FN,FORM='FORMATTED',STATUS='REPLACE')

   WRITE(LUSMV,'(A)') 'TITLE'
   WRITE(LUSMV,'(A)')  TITLE
 
! Record the version and endian-ness in .smv file
   WRITE(LUSMV,'(/A)') 'FDSVERSION'
   WRITE(LUSMV,'(A)') TRIM(VERSION_STRING)

! Indicate the "endian-ness" of the output files
   OPEN(2,FILE=TRIM(HEADER)//'.end', FORM='UNFORMATTED', STATUS='REPLACE')
   WRITE(2) ONE_INTEGER
   CLOSE(2)

   WRITE(LUSMV,'(/A)') 'ENDF'
   WRITE(LUSMV,'(A)') TRIM(HEADER)//'.end'

! Write out the name of the input file
   WRITE(LUSMV,'(/A)') 'INPF'
   WRITE(LUSMV,'(A)') TRIM(TRIM(HEADER)//'.data')

! Number of meshes
   WRITE(LUSMV,'(/A)') 'NMESHES'
   WRITE(LUSMV,'(I3)') NMESHES

! Information used for touring in Smokeview
   WRITE(LUSMV,'(/A)') 'VIEWTIMES'
   WRITE(LUSMV,'(2F10.2,I6)') 0.0_EB,0.01_EB,2

   WRITE(LUSMV,'(/A)') 'SURFDEF'
   WRITE(LUSMV,'(A,A)') ' ','INERT' 
 
! Spatial offset for texture maps  
   WRITE(LUSMV,'(/A)') 'TOFFSET'
   WRITE(LUSMV,'(3F8.3)') 0., 0., 0. 
 
! Write grid info for each block
   WRITE(LUSMV,'(/A)') 'OFFSET'
   WRITE(LUSMV,'(3F8.3)') 0.,0.,0.

   WRITE(LUSMV,'(/A,3X,A)') 'GRID','mesh1'

   WRITE(LUSMV,'(4I5)') IBAR,JBAR,KBAR,0

   WRITE(LUSMV,'(/A)') 'PDIM'
   WRITE(LUSMV,'(9F12.5)') XMIN,XMAX,YMIN,YMAX,ZMIN,ZMAX,0._FB, 0._FB, 0._FB

! Grid stretching in x-direction
   WRITE(LUSMV,'(A)') 'TRNX'
   WRITE(LUSMV,'(I5)') NOC(1)

   ALLOCATE(TRNX(0:G%NCELLX)); TRNX(:)=0D0

   TRNX (1) = G%DLTXN(1,1,1)
   DO IX = 2, G%NCELLX-1
      TRNX(IX)=G%X(IX)+0.5D0*G%DLTXN(1,IX,1)
   ENDDO
   TRNX (G%NCELLX) = G%XDIM

   DO IX=0, G%NCELLX
!      WRITE(LUSMV,'(I5,F12.5)') IX,TRNX(IX)
      WRITE(LUSMV,'(I5,F13.6)') IX,TRNX(IX)
   ENDDO

! Grid stretching in y-direction
   WRITE(LUSMV,'(A)') 'TRNY'
   WRITE(LUSMV,'(I5)') NOC(2)

   ALLOCATE(TRNY(0:G%NCELLY)); TRNY(:)=0D0

   IF (G%NCELLY .EQ. 1) THEN
      TRNY(0) = YMIN
      TRNY(1) = YMAX
!      WRITE(LUSMV,'(I5,F12.5)') 0, TRNY(0)
!      WRITE(LUSMV,'(I5,F12.5)') 1, TRNY(1)
      WRITE(LUSMV,'(I5,F13.6)') 0, TRNY(0)
      WRITE(LUSMV,'(I5,F13.6)') 1, TRNY(1)
   ELSE
      TRNY (1) = G%DLTYN(1,1,1)
      DO IY = 2, G%NCELLY-1
         TRNY(IY)=G%Y(IY)+0.5D0*G%DLTYN(1,1,IY)
      ENDDO
      TRNY (G%NCELLY) = G%YDIM

      DO IY=0, G%NCELLY
!         WRITE(LUSMV,'(I5,F12.5)') IY,TRNY(IY)
         WRITE(LUSMV,'(I5,F13.6)') IY,TRNY(IY)
      ENDDO
   ENDIF

! Grid stretching in z-direction
   WRITE(LUSMV,'(A)') 'TRNZ'
   WRITE(LUSMV,'(I5)') NOC(3)

   ALLOCATE(TRNZ(0:G%NCELLZ)); TRNZ(:)=0D0

   TRNZ (1) = G%DLTZN(1,1,1)
   DO IZ = 2, G%NCELLZ-1
      TRNZ(IZ)=G%Z(IZ)+0.5D0*G%DLTZN(IZ,1,1)
   ENDDO
   TRNZ (G%NCELLZ) = G%ZDIM

   DO IZ=0, G%NCELLZ
!      WRITE(LUSMV,'(I5,F12.5)') IZ,TRNZ(IZ)
      WRITE(LUSMV,'(I5,F13.6)') IZ,TRNZ(IZ)
   ENDDO

! Write obstruction data to .smv file:

! Normally, dump "inverse" of the geometry, i.e. dump the masked part. To do 
! this, set IMASKVALTODUMP to 0.  But to dump the geometry itself, useful for 
! diagnostic purposes, set IMASKVALTODUMP to 1. 
   IMASKVALTODUMP = 0

   ICOUNT = 0
   DO IY = 1, JBAR
   DO IX = 1, IBAR
   DO IZ = 1, KBAR
      IF (G%IMASK(IZ,IX,IY) .EQ. IMASKVALTODUMP) ICOUNT = ICOUNT + 1
   ENDDO
   ENDDO
   ENDDO

   WRITE(LUSMV,'(/A)') 'OBST'
   WRITE(LUSMV,*) ICOUNT

   DO IY = 1, JBAR
   DO IX = 1, IBAR
   DO IZ = 1, KBAR
      IF (G%IMASK(IZ,IX,IY) .EQ. IMASKVALTODUMP) THEN
         KI = KBAR + 1 - IZ
!         WRITE(LUSMV,'(6F12.5)') TRNX(IX-1), TRNX(IX), TRNY(IY-1), TRNY(IY), TRNZ(KI-1), TRNZ(KI)
         WRITE(LUSMV,'(6F13.6)') TRNX(IX-1), TRNX(IX), TRNY(IY-1), TRNY(IY), TRNZ(KI-1), TRNZ(KI)
      ENDIF
   ENDDO
   ENDDO
   ENDDO

   DO IY = 1, JBAR
   DO IX = 1, IBAR
   DO IZ = 1, KBAR
      IF (G%IMASK(IZ,IX,IY) .EQ. IMASKVALTODUMP) THEN
         KI = KBAR + 1 - IZ
         WRITE(LUSMV,'(6I5)') IX-1, IX, IY-1, IY, KI-1, KI
      ENDIF
   ENDDO
   ENDDO
   ENDDO

! Now that smokeview file is open and initialized, do the same 
! for the slice files
   DO N=1,GPG%N_SMOKEVIEW_QUANTITIES

      IF (GPG%SMOKEVIEW_IMESH(N) .NE. IMESH) CYCLE

      SELECT CASE (GPG%SMOKEVIEW_QUANTITY(N))

         CASE('TEMPERATURE')
            LONGNAME  = 'Temperature (solid)'
            SHORTNAME = 'Tmp_solid'
            UNITS     = 'C'

         CASE('ENTHALPY') !Solid enthalpy
            LONGNAME  = 'Enthalpy (solid)'
            SHORTNAME = 'h_solid'
            UNITS     = 'J/kg'

         CASE('YI') !Solid mass fraction
            WRITE(TWO,'(I2.2)') GPG%SMOKEVIEW_QUANTITY_INDEX(N)
            LONGNAME  = 'Yi, species ' // TWO 
            SHORTNAME = 'Yi_' // TWO
            UNITS     = 'kg/kg'

         CASE('XI') !Solid volume fraction
            WRITE(TWO,'(I2.2)') GPG%SMOKEVIEW_QUANTITY_INDEX(N)
            LONGNAME  = 'Xi, species ' // TWO 
            SHORTNAME = 'Xi_' // TWO
            UNITS     = 'm3/m3'

         CASE('CI') !Solid concentration
            WRITE(TWO,'(I2.2)') GPG%SMOKEVIEW_QUANTITY_INDEX(N)
            LONGNAME  = 'Ci, species ' // TWO 
            SHORTNAME = 'Ci_' // TWO
            UNITS     = 'kg/m3'

         CASE('YISUM') !Sum of solid mass fractions (for debugging)
            LONGNAME  = 'Yi_sum'
            SHORTNAME = 'Yi_sum'
            UNITS     = 'kg/kg'

         CASE('REACTION_RATE_K') !Condensed/heterogeneous reactions
            WRITE(TWO,'(I2.2)') GPG%SMOKEVIEW_QUANTITY_INDEX(N)
            LONGNAME  = 'Rxn rate, k=' // TWO 
            SHORTNAME = 'Rxn_k=' // TWO
            UNITS     = 'kg/m3'

         CASE('YJ') !Gas mass fraction
            WRITE(TWO,'(I2.2)') GPG%SMOKEVIEW_QUANTITY_INDEX(N)
            LONGNAME  = 'Yj, species ' // TWO 
            SHORTNAME = 'Yj_' // TWO
            UNITS     = 'kg/kg'

         CASE('CJ') !Gas concentration
            WRITE(TWO,'(I2.2)') GPG%SMOKEVIEW_QUANTITY_INDEX(N)
            LONGNAME  = 'Cj, species ' // TWO 
            SHORTNAME = 'Cj_' // TWO
            UNITS     = 'kg/m3'

         CASE('YJSUM') !Sum of gas mass fractions (for debugging)
            LONGNAME  = 'Yj_sum'
            SHORTNAME = 'Yj_sum'
            UNITS     = 'kg/kg'

         CASE('REACTION_RATE_L') !Homogeneous reactions
            WRITE(TWO,'(I2.2)') GPG%SMOKEVIEW_QUANTITY_INDEX(N)
            LONGNAME  = 'Rxn rate, l=' // TWO 
            SHORTNAME = 'Rxn_l=' // TWO
            UNITS     = 'kg/m3'

         CASE('S') !Solid Source term
            LONGNAME  = 'Solid source term'
            SHORTNAME = 'S_solid'
            UNITS     = 'W/m2'

         CASE('THERMAL_CONDUCTIVITY_Z')
            LONGNAME  = 'z-direction thermal conductivity (solid)'
            SHORTNAME = 'kz_solid'
            UNITS     = 'W/m-K'

         CASE('THERMAL_CONDUCTIVITY_X')
            LONGNAME  = 'x-direction thermal conductivity (solid)'
            SHORTNAME = 'kx_solid'
            UNITS     = 'W/m-K'

         CASE('THERMAL_CONDUCTIVITY_Y')
            LONGNAME  = 'y-direction thermal conductivity (solid)'
            SHORTNAME = 'ky_solid'
            UNITS     = 'W/m-K'

         CASE('BULK_DENSITY') 
            LONGNAME = 'Bulk density (solid)'
            SHORTNAME = 'rho'
            UNITS     = 'kg/m3'              

         CASE('SOLID_DENSITY') 
            LONGNAME = 'Solid density'
            SHORTNAME = 'rhos'
            UNITS     = 'kg/m3'              

         CASE('SPECIFIC_HEAT_CAPACITY') 
            LONGNAME = 'Specific heat capacity (solid)'
            SHORTNAME = 'c'
            UNITS     = 'J/kg-K'              

         CASE('PRESSURE') 
            LONGNAME  = 'Pressure'
            SHORTNAME = 'pres'
            UNITS     = 'Pa'              

         CASE('MASS_FLUX_TOTAL_Z') !z-direction mass flux
            LONGNAME = 'W-MASS_FLUX'
            SHORTNAME = 'W-FLUX'
            UNITS     = 'kg/m2-s'              

         CASE('MASS_FLUX_TOTAL_X') !x-direction mass flux
            LONGNAME = 'U-MASS_FLUX'
            SHORTNAME = 'U-FLUX'
            UNITS     = 'kg/m2-s'              

         CASE('MASS_FLUX_TOTAL_Y') !x-direction mass flux
            LONGNAME = 'V-MASS_FLUX'
            SHORTNAME = 'U-FLUX'
            UNITS     = 'kg/m2-s'              

         CASE('GAS_TEMPERATURE') 
            LONGNAME = 'Temperature (gas)'
            SHORTNAME = 'Tg'
            UNITS     = 'C'              

         CASE('GAS_ENTHALPY') 
            LONGNAME = 'Enthalpy (gas)'
            SHORTNAME = 'hg'
            UNITS     = 'J/kg'              

         CASE('TG-T') 
            LONGNAME = 'Tgas - Tsolid'
            SHORTNAME = 'Tg-T'
            UNITS     = 'C'              

         CASE('SHP') 
            LONGNAME = 'Positive part of solid enthalpy source term'
            SHORTNAME = 'SHP'
            UNITS     = 'W/m3'              

         CASE('SHM') 
            LONGNAME = 'Negative part of solid enthalpy source term'
            SHORTNAME = 'SHM'
            UNITS     = 'W/m3'              

         CASE('PERMEABILITY_Z') 
            LONGNAME = 'z-direction Permeability'
            SHORTNAME = 'Permz'
            UNITS     = 'm2'              

         CASE('PERMEABILITY_X') 
            LONGNAME = 'x-direction Permeability'
            SHORTNAME = 'Permx'
            UNITS     = 'm2'              

         CASE('PERMEABILITY_Y') 
            LONGNAME = 'y-direction Permeability'
            SHORTNAME = 'Permy'
            UNITS     = 'm2'              

         CASE('POROSITY') 
            LONGNAME  = 'Porosity'
            SHORTNAME = 'poros'
            UNITS     = 'm3/m3'              

         CASE('D12') 
            LONGNAME  = 'Diffusion coefficient'
            SHORTNAME = 'D12'
            UNITS     = 'm2/s'              

         CASE('SHGP') 
            LONGNAME = 'Positive part of gas enthalpy source term'
            SHORTNAME = 'SHGP'
            UNITS     = 'W/m3'              

         CASE('SHGM') 
            LONGNAME = 'Negative part of gas enthalpy source term'
            SHORTNAME = 'SHGM'
            UNITS     = 'W/m3'              

         CASE('SHYIDTDMAZ') 
            LONGNAME = 'SHYIDTDMAZ'
            SHORTNAME = 'SHYIDTDMAZ'
            UNITS     = 'W/m3'              

         CASE('SHYIDTDMAX') 
            LONGNAME = 'SHYIDTDMAX'
            SHORTNAME = 'SHYIDTDMAX'
            UNITS     = 'W/m3'              

         CASE('SHYIDTDMAY') 
            LONGNAME = 'SHYIDTDMAY'
            SHORTNAME = 'SHYIDTDMAY'
            UNITS     = 'W/m3'              

         CASE('SHYIAPZ') 
            LONGNAME = 'SHYIAPZ'
            SHORTNAME = 'SHYIAPZ'
            UNITS     = 'W/m3'              

         CASE('SHYIAPX') 
            LONGNAME = 'SHYIAPX'
            SHORTNAME = 'SHYIAPX'
            UNITS     = 'W/m3'              

         CASE('SHYIAPY') 
            LONGNAME = 'SHYIAPY'
            SHORTNAME = 'SHYIAPY'
            UNITS     = 'W/m3'              

         CASE('QSG') 
            LONGNAME = 'Solid to gas heat transfer'
            SHORTNAME = 'QSG'
            UNITS     = 'W/m3'              

         CASE('RYIDZSIGMA') 
            LONGNAME = '(rho*Yi*DZ)_sigma'
            SHORTNAME = 'RYIDZSIGMA'
            UNITS     = 'kg/m2'              

         CASE('UNREACTEDNESS') 
            LONGNAME = 'Unreactedness, 1-alpha_i'
            SHORTNAME = '1-alpha_i'
            UNITS     = '-'

         CASE('GOMEGA3') 
            LONGNAME = 'GOMEGA3'
            SHORTNAME = 'GOMEGA3'
            UNITS     = 'kg/m3-s'

         CASE('RE') 
            LONGNAME = 'Reynolds number'
            SHORTNAME = 'Re'
            UNITS     = '-'

         CASE('NU') 
            LONGNAME = 'Nusselt number'
            SHORTNAME = 'Nu'
            UNITS     = '-'

         CASE('HCV') 
            LONGNAME = 'Vol. heat trans. coeff.'
            SHORTNAME = 'hcv'
            UNITS     = 'W/m3-K'

         CASE('M/M0') 
            LONGNAME = 'm/m0'
            SHORTNAME = 'm/m0'
            UNITS     = '-'

         CASE('NEEDSBCT') 
            LONGNAME = 'NEEDSBCT'
            SHORTNAME = 'NEEDSBCT'
            UNITS     = '-'              

         CASE('NEEDSBCB') 
            LONGNAME = 'NEEDSBCB'
            SHORTNAME = 'NEEDSBCB'
            UNITS     = '-'              

         CASE('NEEDSBCE') 
            LONGNAME = 'NEEDSBCE'
            SHORTNAME = 'NEEDSBCE'
            UNITS     = '-'              

         CASE('NEEDSBCW') 
            LONGNAME = 'NEEDSBCW'
            SHORTNAME = 'NEEDSBCW'
            UNITS     = '-'              

         CASE('NEEDSBCN') 
            LONGNAME = 'NEEDSBCN'
            SHORTNAME = 'NEEDSBCN'
            UNITS     = '-'              

         CASE('NEEDSBCS') 
            LONGNAME = 'NEEDSBCS'
            SHORTNAME = 'NEEDSBCS'
            UNITS     = '-'              

         CASE DEFAULT
            WRITE(*,*) 'Error, Smokeview quantity ', GPG%SMOKEVIEW_QUANTITY(N), ' not found.'
              
      END SELECT

      WRITE(FNSF,'(A,A,I2.2,A,I3.3,A)') TRIM(HEADER),'_',IMESH,'_',N,'.sf'

      WRITE(LUSMV,'(A)') 'SLCF    1'
      WRITE(LUSMV,'(A)') FNSF
      WRITE(LUSMV,'(A)') LONGNAME  !CDATA(INDSP(N))
      WRITE(LUSMV,'(A)') SHORTNAME !SDATA(INDSP(N))
      WRITE(LUSMV,'(A)') UNITS     !UDATA(INDSP(N))
      
      LUSF = LUSMV+N
      OPEN (LUSF,FILE=FNSF,FORM='UNFORMATTED',STATUS='REPLACE',IOSTAT=IOS)
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'SMV IMESH, TI, IOS:', IMESH, TI, IOS
      ENDIF
      WRITE(LUSF) LONGNAME     !CDATA(INDSP(N))
      WRITE(LUSF) SHORTNAME    !SDATA(INDSP(N))
      WRITE(LUSF) UNITS        !UDATA(INDSP(N))
      
      IF (GPG%SMOKEVIEW_PLANE(N) .EQ. 'xz' .OR. GPG%SMOKEVIEW_PLANE(N) .EQ. 'XZ' .OR. &
          GPG%SMOKEVIEW_PLANE(N) .EQ. 'zx' .OR. GPG%SMOKEVIEW_PLANE(N) .EQ. 'ZX') THEN !y=const plane
          IY = GPG%SMOKEVIEW_ICELL(N) 
         WRITE(LUSF) I1,I2,IY,IY,K1,K2
      ENDIF

      IF (GPG%SMOKEVIEW_PLANE(N) .EQ. 'yz' .OR. GPG%SMOKEVIEW_PLANE(N) .EQ. 'YZ' .OR. &
          GPG%SMOKEVIEW_PLANE(N) .EQ. 'zy' .OR. GPG%SMOKEVIEW_PLANE(N) .EQ. 'ZY') THEN !x=const plane
          IX = GPG%SMOKEVIEW_ICELL(N) 
         WRITE(LUSF) IX,IX,J1,J2,K1,K2
      ENDIF

      IF (GPG%SMOKEVIEW_PLANE(N) .EQ. 'xy' .OR. GPG%SMOKEVIEW_PLANE(N) .EQ. 'XY' .OR. &
         GPG%SMOKEVIEW_PLANE(N) .EQ. 'yx' .OR. GPG%SMOKEVIEW_PLANE(N) .EQ. 'YX') THEN !z=const plane
         IZ = GPG%SMOKEVIEW_ICELL(N) 
         WRITE(LUSF) I1,I2,J1,J2,IZ,IZ
      ENDIF

! Note that LUSF stays open
            
   ENDDO !N=1,GPG%N_SMOKEVIEW_QUANTITIES

   CLOSE(LUSMV) 

ENDIF
      
DO N=1,GPG%N_SMOKEVIEW_QUANTITIES
   IF (GPG%SMOKEVIEW_IMESH(N) .NE. IMESH) CYCLE

   SELECT CASE(GPG%SMOKEVIEW_QUANTITY(N))

      CASE('TEMPERATURE') !Temperature
         QQ(:,:,:) =  273.15
         QQPTR     => G%TPN(:,:,:)
         ADD       =  -273.15

      CASE('ENTHALPY') !Enthalpy
         QQ(:,:,:) =  0.
         QQPTR     => G%HPN(:,:,:)
         ADD       =  0.

      CASE('YI') !Solid mass fraction
         QQ(:,:,:) =  0.
         ISPEC     =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQPTR     => G%YIN(ISPEC,:,:,:)
         ADD       =  0.

      CASE('XI') !Solid volume fraction
         QQ(:,:,:) =  0.
         ISPEC     =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQPTR     => G%XIN(ISPEC,:,:,:)
         ADD       =  0.

      CASE('CI') !Concentration of species I
         ISPEC        =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = G%RPN(:,:,:) * G%YIN(ISPEC,:,:,:)
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('YISUM') !Sum of solid mass fractions (for debugging)
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = 0.
         DO ISPEC = 1, SPROP%NSSPEC
            TEMPARR(:,:,:) = TEMPARR(:,:,:) + G%YIN(ISPEC,:,:,:)   
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('REACTION_RATE_K') !Condensed/heterogeneous reaction rate
         QQ(:,:,:) =  0.
         IRXN      =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQPTR     => G%OMEGASDAK(IRXN,:,:,:)
         ADD       =  0.

      CASE('YJ') !Gas mass fraction
         QQ(:,:,:) =  0.
         ISPEC     =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQPTR     => G%YJGN(ISPEC,:,:,:)
         ADD       =  0.

      CASE('CJ') !Concentration of species J
         ISPEC        =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = G%RGN(:,:,:) * G%POROSSN(:,:,:) * G%YJGN(ISPEC,:,:,:)
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('YJSUM') !Sum of gas mass fractions (for debugging)
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = 0.
         DO ISPEC = 1, GPROP%NGSPEC
            TEMPARR(:,:,:) = TEMPARR(:,:,:) + G%YJGN(ISPEC,:,:,:)   
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('REACTION_RATE_L') !Homogeneous gaseous reaction rate
         QQ(:,:,:) =  0.
         IRXN      =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQPTR     => G%HGRR(IRXN,:,:,:)
         ADD       =  0.

      CASE('S') !Solid enthalpy source term
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = G%SHP(:,:,:) - G%SHM(:,:,:)
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('THERMAL_CONDUCTIVITY_Z') !z-direction thermal conductivity
         QQ(:,:,:) =  0.
         QQPTR     => G%KZ(:,:,:)
         ADD       =  0.

      CASE('THERMAL_CONDUCTIVITY_X') !x-direction thermal conductivity
         QQ(:,:,:) =  0.
         QQPTR     => G%KX(:,:,:)
         ADD       =  0.

      CASE('THERMAL_CONDUCTIVITY_Y') !y-direction thermal conductivity
         QQ(:,:,:) =  0.
         QQPTR     => G%KY(:,:,:)
         ADD       =  0.

      CASE('BULK_DENSITY') !Bulk density
         QQ(:,:,:) =  0.
         QQPTR     => G%RPN(:,:,:)
         ADD       =  0.

      CASE('SOLID_DENSITY') !Solid density
         QQ(:,:,:) =  0.
         QQPTR     => G%RSPN(:,:,:)
         ADD       =  0.

      CASE('SPECIFIC_HEAT_CAPACITY') !Specific heat capacity
         QQ(:,:,:) =  0.
         QQPTR     => G%CPS(:,:,:)
         ADD       =  0.

      CASE('PRESSURE') !Pressure
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = G%PN(:,:,:) - GPG%P0 !Single precision not enough
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('MASS_FLUX_TOTAL_Z') !z-direction mass flux
         QQ(:,:,:) =  0.
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPARR(:,:,:) = G%MDOTPPDARCYT(:,:,:) * 1D3
         ELSE
            TEMPARR(:,:,:) = G%MDOTPPZ(0,:,:,:) * 1D3
         ENDIF

         QQPTR     => TEMPARR
         ADD       =  0.

      CASE('MASS_FLUX_TOTAL_X') !x-direction mass flux
         QQ(:,:,:) =  0.
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPARR(:,:,:) = G%MDOTPPDARCYE(:,:,:) * 1D3
            QQPTR        => TEMPARR
         ELSE
            CONTINUE ! x-direction mass flux is zero unless solve_pressure = .true.
         ENDIF
         ADD       =  0.

      CASE('MASS_FLUX_TOTAL_Y') !y-direction mass flux
         QQ(:,:,:) =  0.
         IF (GPG%SOLVE_PRESSURE) THEN
            TEMPARR(:,:,:) = G%MDOTPPDARCYS(:,:,:) * 1D3
            QQPTR        => TEMPARR
         ELSE
            CONTINUE ! Y-direction mass flux is zero unless solve_pressure = .true.
         ENDIF
         ADD       =  0.

      CASE('GAS_TEMPERATURE') !Gas temperature
         QQ(:,:,:) =  273.15
         QQPTR     => G%TGN(:,:,:)
         ADD       =  -273.15

      CASE('GAS_ENTHALPY') !Gas enthalpy
         QQ(:,:,:) =  0.
         QQPTR     => G%HGN(:,:,:)
         ADD       =  0.

      CASE('TG-T') !Tgas - Tsolid
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = G%TGN(:,:,:) - G%TPN(:,:,:)
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('SHP') !Positive part of solid enthalpy source term
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHP(:,:,:)
         ADD          =  0.

      CASE('SHM') !Negative part of solid enthalpy source term
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHM(:,:,:)
         ADD          =  0.

      CASE('SHYIDTDMAZ')
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHYIDTDMAZ(:,:,:)
         ADD          =  0.

      CASE('SHYIDTDMAX')
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHYIDTDMAX(:,:,:)
         ADD          =  0.

      CASE('SHYIDTDMAY')
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHYIDTDMAY(:,:,:)
         ADD          =  0.

      CASE('SHYIAPZ')
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHYIAPZ(:,:,:)
         ADD          =  0.

      CASE('SHYIAPX')
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHYIAPX(:,:,:)
         ADD          =  0.

      CASE('SHYIAPY')
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHYIAPY(:,:,:)
         ADD          =  0.

      CASE('PERMEABILITY_Z') !z-direction permeability
         QQ(:,:,:) =  0.
         QQPTR     => G%PERMZ(:,:,:)
         ADD       =  0.

      CASE('PERMEABILITY_X') !x-direction permeability
         QQ(:,:,:) =  0.
         QQPTR     => G%PERMX(:,:,:)
         ADD       =  0.

      CASE('PERMEABILITY_Y') !y-direction permeability
         QQ(:,:,:) =  0.
         QQPTR     => G%PERMY(:,:,:)
         ADD       =  0.

      CASE('POROSITY') !Porosity
         QQ(:,:,:) =  0.
         QQPTR     => G%POROSSN(:,:,:)
         ADD       =  0.

      CASE('D12') !Diffusion coefficient
         QQ(:,:,:) =  0.
         QQPTR     => G%D12(:,:,:)
         ADD       =  0.

      CASE('SHGP') !Positive part of gas enthalpy source term
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHGP(:,:,:)
         ADD          =  0.

      CASE('SHGM') !Negative part of gas enthalpy source term
         QQ(:,:,:)    =  0.
         QQPTR        => G%SHGM(:,:,:)
         ADD          =  0.

      CASE('QSG') !Solid to gas heat transfer
         QQ(:,:,:)    =  0.
         QQPTR        => G%QSG(:,:,:)
         ADD          =  0.

      CASE('RYIDZSIGMA') ! rho * Yi * Dz * sigma()
         QQ(:,:,:)    =  0.
         ISPEC        =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQPTR        => G%RYIDZSIGMAN(ISPEC,:,:,:)
         ADD          =  0.

      CASE('UNREACTEDNESS') !Unreactedness
         QQ(:,:,:) =  0.
         ISPEC     =  GPG%SMOKEVIEW_QUANTITY_INDEX(N)
         QQPTR     => G%UNREACTEDNESS(ISPEC,:,:,:)
         ADD       =  0D0

      CASE('GOMEGA3') !GOMEGA3
         QQ(:,:,:) =  0.
         QQPTR     => G%GOMEGA(3,0,:,:,:)
         ADD       =  0D0

      CASE('RE') !Reynolds number
         QQ(:,:,:) =  0.
         QQPTR     => G%RE(:,:,:)
         ADD       =  0D0

      CASE('NU') !Nusselt number
         QQ(:,:,:) =  0.
         QQPTR     => G%NU(:,:,:)
         ADD       =  0D0

      CASE('HCV') !Volumetric heat transfer coefficient
         QQ(:,:,:) =  0.
         QQPTR     => G%HCV(:,:,:)
         ADD       =  0D0

      CASE('M/M0') 
         QQ(:,:,:)    =  0.
         TEMPARR(:,:,:) = G%RDLTZN(:,:,:) / SUM(G%RYIDZ0(1:SPROP%NSSPEC,:,:,:))
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('NEEDSBCT') 
         QQ(:,:,:)=0.
         TEMPARR(:,:,:)=0.
         DO IY = 1, JBAR
         DO IX = 1, IBAR
         DO IZ = 1, KBAR
            IF (G%NEEDSBCT(IZ,IX,IY)) TEMPARR(IZ,IX,IY) = 1.
         ENDDO
         ENDDO
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('NEEDSBCB') 
         QQ(:,:,:)=0.
         TEMPARR(:,:,:)=0.
         DO IY = 1, JBAR
         DO IX = 1, IBAR
         DO IZ = 1, KBAR
            IF (G%NEEDSBCB(IZ,IX,IY)) TEMPARR(IZ,IX,IY) = 1.
         ENDDO
         ENDDO
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('NEEDSBCE') 
         QQ(:,:,:)=0.
         TEMPARR(:,:,:)=0.
         DO IY = 1, JBAR
         DO IX = 1, IBAR
         DO IZ = 1, KBAR
            IF (G%NEEDSBCE(IZ,IX,IY)) TEMPARR(IZ,IX,IY) = 1.
         ENDDO
         ENDDO
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('NEEDSBCW') 
         QQ(:,:,:)=0.
         TEMPARR(:,:,:)=0.
         DO IY = 1, JBAR
         DO IX = 1, IBAR
         DO IZ = 1, KBAR
            IF (G%NEEDSBCW(IZ,IX,IY)) TEMPARR(IZ,IX,IY) = 1.
         ENDDO
         ENDDO
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('NEEDSBCN') 
         QQ(:,:,:)=0.
         TEMPARR(:,:,:)=0.
         DO IY = 1, JBAR
         DO IX = 1, IBAR
         DO IZ = 1, KBAR
            IF (G%NEEDSBCN(IZ,IX,IY)) TEMPARR(IZ,IX,IY) = 1.
         ENDDO
         ENDDO
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE('NEEDSBCS') 
         QQ(:,:,:)=0.
         TEMPARR(:,:,:)=0.
         DO IY = 1, JBAR
         DO IX = 1, IBAR
         DO IZ = 1, KBAR
            IF (G%NEEDSBCS(IZ,IX,IY)) TEMPARR(IZ,IX,IY) = 1.
         ENDDO
         ENDDO
         ENDDO
         QQPTR        => TEMPARR
         ADD          =  0.

      CASE DEFAULT
         WRITE(*,*) 'Error, Smokeview quantity ', GPG%SMOKEVIEW_QUANTITY(N), ' not found.'

   END SELECT
   
   LUSF = LUSMV+N
   WRITE(LUSF) STIME

!Begin by setting up blockage array:
   B(:,:,:) = 1D0
!   DO K=1,KBAR
!   DO J=1,JBAR
!   DO I=1,IBAR
!      KI =  KBAR+1 - K       
!      IF (G%IMASK(K,I,J) .EQ. 0) B(I,J,KI) = 0D0
!   ENDDO
!   ENDDO
!   ENDDO

!Now calculate "S" following FDS:
   S(:,:,:) = 0.125D0
   DO K=1,KBAR
   DO J=1,JBAR
   DO I=1,IBAR
      SUMMATION = B(I,J,K)+B(I+1,J+1,K+1)+B(I+1,J,K)+B(I,J+1,K)+B(I,J,K+1)+B(I+1,J+1,K)+B(I+1,J,K+1)+B(I,J+1,K+1)
      IF (SUMMATION>0D0) S(I,J,K) = 1D0/SUMMATION
   ENDDO
   ENDDO
   ENDDO

!Fill in dummy cells for better visualzation:
QQMID(1:G%NCELLZ,1:G%NCELLX,1:G%NCELLY) = QQPTR(1:G%NCELLZ,1:G%NCELLX,1:G%NCELLY)
DO IY = 1, G%NCELLY
DO IX = 1, G%NCELLX
DO IZ = 1, G%NCELLZ
   IF (G%NEEDSBCT(IZ,IX,IY)) QQMID(IZ-1,IX,IY) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCB(IZ,IX,IY)) QQMID(IZ+1,IX,IY) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCW(IZ,IX,IY)) QQMID(IZ,IX-1,IY) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCE(IZ,IX,IY)) QQMID(IZ,IX+1,IY) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCS(IZ,IX,IY)) QQMID(IZ,IX,IY-1) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCN(IZ,IX,IY)) QQMID(IZ,IX,IY+1) = QQPTR(IZ,IX,IY)

   IF (G%NEEDSBCT(IZ,IX,IY) .AND. G%NEEDSBCW(IZ,IX,IY)) QQMID(IZ-1,IX-1,IY) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCT(IZ,IX,IY) .AND. G%NEEDSBCE(IZ,IX,IY)) QQMID(IZ-1,IX+1,IY) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCB(IZ,IX,IY) .AND. G%NEEDSBCW(IZ,IX,IY)) QQMID(IZ+1,IX-1,IY) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCB(IZ,IX,IY) .AND. G%NEEDSBCE(IZ,IX,IY)) QQMID(IZ+1,IX+1,IY) = QQPTR(IZ,IX,IY)

   IF (G%NEEDSBCT(IZ,IX,IY) .AND. G%NEEDSBCS(IZ,IX,IY)) QQMID(IZ-1,IX,IY-1) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCT(IZ,IX,IY) .AND. G%NEEDSBCN(IZ,IX,IY)) QQMID(IZ-1,IX,IY+1) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCB(IZ,IX,IY) .AND. G%NEEDSBCS(IZ,IX,IY)) QQMID(IZ+1,IX,IY-1) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCB(IZ,IX,IY) .AND. G%NEEDSBCN(IZ,IX,IY)) QQMID(IZ+1,IX,IY+1) = QQPTR(IZ,IX,IY)

   IF (G%NEEDSBCW(IZ,IX,IY) .AND. G%NEEDSBCS(IZ,IX,IY)) QQMID(IZ,IX-1,IY-1) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCW(IZ,IX,IY) .AND. G%NEEDSBCN(IZ,IX,IY)) QQMID(IZ,IX+1,IY+1) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCE(IZ,IX,IY) .AND. G%NEEDSBCS(IZ,IX,IY)) QQMID(IZ,IX-1,IY-1) = QQPTR(IZ,IX,IY)
   IF (G%NEEDSBCE(IZ,IX,IY) .AND. G%NEEDSBCN(IZ,IX,IY)) QQMID(IZ,IX+1,IY+1) = QQPTR(IZ,IX,IY)
ENDDO
ENDDO
ENDDO

!Put data in usual (i,j,k) form instead of gpyro (k,i,j) form:
   QQTEMP(:,:,:) = 0D0
   DO K=1,KBAR
   DO J=1,JBAR
   DO I=1,IBAR
      KI =  KBAR+1 - K 
      QQTEMP(I,J,KI) = QQMID(K,I,J)
   ENDDO
   ENDDO
   ENDDO

!Now copy data to edges:

!z:
   QQTEMP(:     , : ,0     ) = QQTEMP(:   , : , 1   )
   QQTEMP(:     , : ,KBAR+1) = QQTEMP(:   , : , KBAR)

!x:
   QQTEMP(0     , : ,:     ) = QQTEMP(1   , : , :   )
   QQTEMP(IBAR+1, : ,:     ) = QQTEMP(IBAR, : , :   )

!y:
   QQTEMP(:, 0     ,:     ) = QQTEMP(:, 1   , :   )
   QQTEMP(:, JBAR+1,:     ) = QQTEMP(:, JBAR, :   )

! Now calculate corner values necessary for Smokeview dump
   DO K=K1,K2
   DO J=J1,J2
   DO I=I1,I2
!      QQ(I,J,K) = CORNER_VALUE_GPYRO(QQTEMP,B,S,I,J,K)
      QQ(I,J,K) = QQTEMP(I,J,K)
      QQ(I,J,K) = QQ(I,J,K) + ADD
   ENDDO
   ENDDO
   ENDDO

!Now determine location of slice file
   IF (GPG%SMOKEVIEW_PLANE(N) .EQ. 'xz') THEN !y=const plane
      IY = GPG%SMOKEVIEW_ICELL(N)
      WRITE(LUSF) (((QQ(I,J,K),I=I1,I2),J=IY,IY),K=K1,K2)
   ENDIF

   IF (GPG%SMOKEVIEW_PLANE(N) .EQ. 'yz') THEN !x=const plane
      IX = GPG%SMOKEVIEW_ICELL(N)
      WRITE(LUSF) (((QQ(I,J,K),I=IX,IX),J=J1,J2),K=K1,K2)   
   ENDIF
   
   IF (GPG%SMOKEVIEW_PLANE(N) .EQ. 'xy') THEN !z=const plane
      IZ = GPG%SMOKEVIEW_ICELL(N)
      WRITE(LUSF) (((QQ(I,J,K),I=I1,I2),J=J1,J2),K=IZ,IZ)   
   ENDIF
   
ENDDO

IF (ALLOCATED(QQ     )) DEALLOCATE (QQ     )
IF (ALLOCATED(QQTEMP )) DEALLOCATE (QQTEMP )
IF (ALLOCATED(QQMID  )) DEALLOCATE (QQMID  )
IF (ALLOCATED(B      )) DEALLOCATE (B      )
IF (ALLOCATED(S      )) DEALLOCATE (S      )
IF (ALLOCATED(TEMPARR)) DEALLOCATE (TEMPARR)
IF (ALLOCATED(TRNX   )) DEALLOCATE (TRNX   )
IF (ALLOCATED(TRNY   )) DEALLOCATE (TRNY   )
IF (ALLOCATED(TRNZ   )) DEALLOCATE (TRNZ   )

!******************************************************************************
END SUBROUTINE DUMP_GPYRO_SMOKEVIEW
!******************************************************************************


!******************************************************************************
REAL(EB) FUNCTION CORNER_VALUE_GPYRO(A,B,S,I,J,K)
!******************************************************************************
! Borrowed from FDS to calculate corner values for slice files 

REAL(EB), INTENT(IN), DIMENSION(0:,0:,0:) :: A,B,S
INTEGER, INTENT(IN) :: I,J,K

IF (ABS(S(I,J,K))<=1D-9) THEN
   CORNER_VALUE_GPYRO = 0D0
ELSE
   CORNER_VALUE_GPYRO = S(I,J,K)*(A(I,J,K)    *B(I,J,K)     + A(I+1,J,K)    *B(I+1,J,K)   + &
                                  A(I,J,K+1)  *B(I,J,K+1)   + A(I+1,J,K+1)  *B(I+1,J,K+1) + &
                                  A(I,J+1,K)  *B(I,J+1,K)   + A(I+1,J+1,K)  *B(I+1,J+1,K) + &
                                  A(I,J+1,K+1)*B(I,J+1,K+1) + A(I+1,J+1,K+1)*B(I+1,J+1,K+1))
ENDIF

!****************************************************************************** 
END FUNCTION CORNER_VALUE_GPYRO
!******************************************************************************

!******************************************************************************
END SUBROUTINE DUMP_GPYRO
!******************************************************************************

!******************************************************************************
SUBROUTINE DUMP_TIMINGS(IMESH)
!******************************************************************************
INTEGER, INTENT(IN) :: IMESH
CHARACTER(300) :: FN
INTEGER :: IOS
CHARACTER(2) :: TWO

WRITE(TWO,'(I2.2)') IMESH

FN = TRIM(GPG%CASENAME) // '_timing_' // TWO // '.csv'
OPEN(UNIT=LUTIME,FILE=FN,FORM='FORMATTED', STATUS='REPLACE',IOSTAT=IOS)
      
WRITE(LUTIME,*,IOSTAT=IOS)  'Subroutine, CPU time (s)'
WRITE(LUTIME,99,IOSTAT=IOS) 'SOLID_ENTHALPY_SOLVER,',GPG%TUSED(01)
WRITE(LUTIME,99,IOSTAT=IOS) 'GETTING T FROM H,',GPG%TUSED(02)
WRITE(LUTIME,99,IOSTAT=IOS) 'DUMP ROUTINES,',GPG%TUSED(03)
WRITE(LUTIME,99,IOSTAT=IOS) 'GPYRO_PYROLYSIS,',GPG%TUSED(04)
WRITE(LUTIME,99,IOSTAT=IOS) 'CALCULATE_WEIGHTED_POINT_QUANTITIES,',GPG%TUSED(05)
WRITE(LUTIME,99,IOSTAT=IOS) 'PRESSURE_SOLVER,',GPG%TUSED(06)
WRITE(LUTIME,99,IOSTAT=IOS) 'SPECIES_SOURCE_TERMS,',GPG%TUSED(08)
WRITE(LUTIME,99,IOSTAT=IOS) 'CALCULATE_SHYI_CORRECTION_COEFFICIENTS,',GPG%TUSED(10)
WRITE(LUTIME,99,IOSTAT=IOS) 'ENERGY_SOURCE_TERMS,',GPG%TUSED(11)
WRITE(LUTIME,99,IOSTAT=IOS) 'CALCULATE_INTERFACE_WEIGHTING_FACTORS,',GPG%TUSED(12)
WRITE(LUTIME,99,IOSTAT=IOS) 'CALCULATE_INTERFACE_QUANTITIES,',GPG%TUSED(13)
WRITE(LUTIME,99,IOSTAT=IOS) 'SOLID_SPECIES_SOLVER,',GPG%TUSED(15)
WRITE(LUTIME,99,IOSTAT=IOS) 'REACTION_RATE_T,',GPG%TUSED(16)
WRITE(LUTIME,99,IOSTAT=IOS) 'REACTION_RATE_Y,',GPG%TUSED(17)
WRITE(LUTIME,99,IOSTAT=IOS) 'CALC_MDOTPPZ,',GPG%TUSED(18)
WRITE(LUTIME,99,IOSTAT=IOS) 'GET_ALL_BOUNDARY_CONDITIONS,',GPG%TUSED(19)
WRITE(LUTIME,99,IOSTAT=IOS) 'GET_D,',GPG%TUSED(20)
WRITE(LUTIME,99,IOSTAT=IOS) 'CALC_HCV,',GPG%TUSED(21)
WRITE(LUTIME,99,IOSTAT=IOS) 'GAS_ENERGY_SOLVER,',GPG%TUSED(22)
WRITE(LUTIME,99,IOSTAT=IOS) 'UPDATE_SOLUTION,',GPG%TUSED(24)
WRITE(LUTIME,99,IOSTAT=IOS) 'CALCULATE_GAS_DENSITY,',GPG%TUSED(25)
WRITE(LUTIME,99,IOSTAT=IOS) 'DARCIAN_MASS_FLUX,',GPG%TUSED(26)

WRITE(LUTIME,99,IOSTAT=IOS) 'CONVECTIVE_DIFFUSIVE_SOLVER PART 1,',GPG%TUSED(09)
WRITE(LUTIME,99,IOSTAT=IOS) 'CONVECTIVE_DIFFUSIVE_SOLVER BC,',GPG%TUSED(14)
WRITE(LUTIME,99,IOSTAT=IOS) 'CONVECTIVE_DIFFUSIVE_SOLVER COND,',GPG%TUSED(23)
WRITE(LUTIME,99,IOSTAT=IOS) 'CONVECTIVE_DIFFUSIVE_SOLVER SOLV1,',GPG%TUSED(27)
WRITE(LUTIME,99,IOSTAT=IOS) 'CONVECTIVE_DIFFUSIVE_SOLVER SOLV2,',GPG%TUSED(28)
WRITE(LUTIME,99,IOSTAT=IOS) 'CONVECTIVE_DIFFUSIVE_SOLVER CONVG,',GPG%TUSED(07)

WRITE(LUTIME,99,IOSTAT=IOS) 'All others,',GPG%TUSED(0) - SUM(GPG%TUSED(1:28))

CLOSE(LUTIME,IOSTAT=IOS)

99 FORMAT(A,F16.9)

!******************************************************************************
END SUBROUTINE DUMP_TIMINGS
!******************************************************************************

!******************************************************************************
SUBROUTINE DUMP_FDS_INPUT_FILE(ICASE)
!******************************************************************************

INTEGER, INTENT(IN) :: ICASE
INTEGER   :: LU = 100
INTEGER :: I,J,ITO,IMATL,IRXN,NRAMP,ISPEC,ICOUNT
CHARACTER(500) :: WRITESTR
CHARACTER(300) :: STR1,STR2,STR3,CHID,FN,CASENAME
CHARACTER(2) :: TWO,CSPEC
REAL(EB) :: TR,TK,TC,VAL,ALPHA,TAMB,TINITIAL
REAL(EB), DIMENSION(1:10) :: NU_RESIDUE, NU_GAS
REAL(EB), PARAMETER :: DTMP  =  50. !Delta-TMP for RAMPs 
REAL(EB), PARAMETER :: TMPHI = 1000. !Run RAMPs out to this T
LOGICAL, PARAMETER :: TESTING=.FALSE.

! Potentially remove period from casename if it exists
CASENAME(:) = '                                                            '
J = 0
DO I = 1, 40
   IF (GPG%CASENAME(I:I) .NE. '.') THEN
      J = J + 1
      CASENAME(J:J) = GPG%CASENAME(I:I)
   ENDIF
   IF (GPG%CASENAME(I:I) .EQ. ' ') EXIT
ENDDO 

WRITE(TWO,'(I2.2)') ICASE

CHID = "gpyro_" // TRIM(CASENAME)
FN   = "gpyro_" // TRIM(GPG%CASENAME) // "_" // TWO // ".fds"
                        
OPEN(LU,FILE=FN,FORM='FORMATTED',STATUS='REPLACE')

! Write &HEAD line:
IF (GPG%FDS_MATL_VER .EQ. 5) WRITESTR = "&HEAD CHID='" // TRIM(CHID) // "', TITLE='FDS 5.5.3 pyrolysis dummy file, generated by Gpyro' /"
IF (GPG%FDS_MATL_VER .EQ. 6) WRITESTR = "&HEAD CHID='" // TRIM(CHID) // "', TITLE='FDS 6.0.1 pyrolysis dummy file, generated by Gpyro' /"

WRITE(LU,91) TRIM (WRITESTR)
WRITE(LU,*)

! Write &MESH:
WRITE(LU,91) "&MESH IJK=6,6,6, XB=-1.5,1.5,-1.5,1.5,0.0,3.0 /"
WRITE(LU,*)

! Write &TIME line:
WRITE(STR1,'(F7.1)') GPG%TSTOP(ICASE)
WRITE(STR2,'(F7.4)') GPG%DT0
WRITESTR = "&TIME T_END= " // TRIM(STR1) // ", DT = "  // TRIM(STR2) // ", WALL_INCREMENT = 1 /"
WRITE(LU,91) TRIM (WRITESTR)

! Write &MISC line:
WRITE(STR1,'(F5.1)') GPG%TAMB - 273.15
IF (GPG%FDS_MATL_VER .EQ. 6) WRITESTR = "&MISC TMPA= " // TRIM(STR1) // ", SOLID_PHASE_ONLY=.TRUE., Y_O2_INFTY=0.00001 / "
IF (GPG%FDS_MATL_VER .EQ. 5) WRITESTR = "&MISC TMPA= " // TRIM(STR1) // ", SOLID_PHASE_ONLY=.TRUE. "
WRITE(LU,91) TRIM (WRITESTR)
WRITE(LU,*)

! Write &SPEC lines:
DO ISPEC = 1, GPROP%NGSPEC
   WRITE(STR1,'(F5.1)') GPROP%M(ISPEC)
   STR2 = "&SPEC ID = '" // TRIM(GPROP%NAME(ISPEC)) // "', MW= " // TRIM(STR1) // " /"
   WRITE(LU,91) TRIM(STR2) 
ENDDO
WRITE(LU,*)

! Write &REAC line:
WRITE(LU,91) "&REAC FUEL='PROPANE' /"
WRITE(LU,*)

! Write &VENT info:
IF (G%NCELLZ .EQ. 1) WRITE(LU,93) "&VENT XB = -0.5,0.5,-0.5,0.5,0.0,0.0, SURF_ID = '", TRIM(GPG%CASENAME), "_TGA', COLOR = 'BLUE' / "
IF (G%NCELLZ .GT. 1) WRITE(LU,93) "&VENT XB = -0.5,0.5,-0.5,0.5,0.0,0.0, SURF_ID = '", TRIM(GPG%CASENAME), "_SLAB', COLOR = 'BLUE' / "

IF (G%NCELLZ .GT. 1) THEN
   WRITE(LU,91) "&VENT MB='XMIN', SURF_ID='OPEN' / "
   WRITE(LU,91) "&VENT MB='XMAX', SURF_ID='OPEN' / "
   WRITE(LU,91) "&VENT MB='YMIN', SURF_ID='OPEN' / "
   WRITE(LU,91) "&VENT MB='YMAX', SURF_ID='OPEN' / "   
   WRITE(LU,91) "&VENT MB='ZMAX', SURF_ID='OPEN' / "
ELSE
   WRITE(LU,91) "&VENT MB='XMIN', SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT MB='XMAX', SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT MB='YMIN', SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT MB='YMAX', SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT MB='ZMAX', SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT XB=-1.5,-0.5,-1.5, 1.5, 0.0, 0.0, SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT XB= 0.5, 1.5,-1.5, 1.5, 0.0, 0.0, SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT XB=-0.5, 0.5,-1.5,-0.5, 0.0, 0.0, SURF_ID='HOT' / "
   WRITE(LU,91) "&VENT XB=-0.5, 0.5, 0.5, 1.5, 0.0, 0.0, SURF_ID='HOT' / "   
   WRITE(LU,*) 

   WRITE(LU,91) "&SURF ID                     = 'HOT'"
   WRITE(LU,91) "EMISSIVITY                   = 1.0"
   WRITE(LU,91) "RGB                          = 250,0,0"
   WRITE(LU,91) "TMP_FRONT                    = 1000."
   WRITE(LU,91) "HEAT_TRANSFER_COEFFICIENT    = 0."
   WRITE(LU,91) "RAMP_T 	                  = 'T_RAMP' / "
   WRITE(LU,*)

! Determine T ramp
! f(t) = (Tinitial - TAMB + beta*t) / (TMP_FRONT - TAMB)
   TAMB     = GPG%TAMB - 273.15
   TINITIAL = GPG%INITIAL_CONDITIONS(1)%TMP_INITIAL - 273.15

   WRITE(STR1,'(F8.5)') (TINITIAL - TAMB) / (1000D0 - TAMB)
   STR2 = "&RAMP ID = 'T_RAMP', T =     0.00,    F = " // TRIM(STR1) // " / "
   WRITE(LU,91) TRIM(STR2) 
   
!   WRITE(STR1,'(F8.5)') (TINITIAL - TAMB + 1.004*GPG%BETA(ICASE)*GPG%TSTOP(ICASE)/60D0) / (1000D0 - TAMB)
   WRITE(STR1,'(F8.5)') (TINITIAL - TAMB + 1.000*GPG%BETA(ICASE)*GPG%TSTOP(ICASE)/60D0) / (1000D0 - TAMB)
   WRITE(STR2,'(F8.2)') GPG%TSTOP(ICASE)
   STR3 = "&RAMP ID = 'T_RAMP', T = " // TRIM(STR2) // ",    F = " // TRIM(STR1) // " / "
   WRITE(LU,91) TRIM(STR3) 
ENDIF

! Write MATL lines:
NRAMP = 0

DO IMATL = 1, SPROP%NSSPEC
   WRITE(LU,*)
   WRITESTR = "&MATL ID                       = '" // TRIM(GPG%CASENAME) // "_" // TRIM(SPROP%NAME(IMATL))
   WRITE(LU,91) TRIM(WRITESTR) // "'"

   IF (SPROP%NKZ(IMATL) .NE. 0D0) THEN
      NRAMP = NRAMP + 1
      WRITE(TWO,'(I2.2)') NRAMP
      STR1 = "'RAMP_" // TRIM(GPG%CASENAME) // "_" // TWO // "'"
      WRITESTR = "      CONDUCTIVITY_RAMP        = " // TRIM(STR1)
   ELSE
      WRITE(STR1,'(F6.3)') SPROP%K0Z(IMATL)
      WRITESTR = "      CONDUCTIVITY             = " // TRIM(STR1)
   ENDIF
   WRITE(LU,91) TRIM(WRITESTR)

   WRITE(STR1,'(F7.2)') SPROP%R0(IMATL)
   WRITESTR = "      DENSITY                  = " // TRIM(STR1)
   WRITE(LU,91) TRIM(WRITESTR)

   IF (SPROP%NC(IMATL) .NE. 0D0) THEN
      NRAMP = NRAMP + 1
      WRITE(TWO,'(I2.2)') NRAMP
      STR1 = "'RAMP_" // TRIM(GPG%CASENAME) // "_" // TWO // "'"
      WRITESTR = "      SPECIFIC_HEAT_RAMP       = " // TRIM(STR1)
   ELSE
      WRITE(STR1,'(F7.2)') SPROP%C0(IMATL) * 1D-3
      WRITESTR = "      SPECIFIC_HEAT            = " // TRIM(STR1)
   ENDIF
   WRITE(LU,91) TRIM(WRITESTR)

   WRITE(STR1,'(F6.3)') SPROP%EMIS(IMATL)
   WRITESTR = "      EMISSIVITY               = " // TRIM(STR1)
   WRITE(LU,91) TRIM(WRITESTR)

   WRITE(STR1,'(E11.4)') SPROP%KAPPA(IMATL)
   WRITESTR = "      ABSORPTION_COEFFICIENT   = " // TRIM(STR1)
   WRITE(LU,91) TRIM(WRITESTR)

   I = 0
   DO IRXN = 1, SPROP%NRXN
      IF (TRIM(RXN(IRXN)%CFROM) .EQ. TRIM(SPROP%NAME(IMATL))) THEN

         I = I + 1
         WRITE(TWO,'(I2.2)') I

! Write kinetics and thermodynamics:
         STR1 = "      A(" // TWO // ")                    = "
         WRITE(STR2,'(E11.4)') RXN(IRXN)%Z
         WRITE(LU,91) TRIM(STR1) // TRIM (STR2)

         STR1 = "      E(" // TWO // ")                    = "
         WRITE(STR2,'(E11.4)') RXN(IRXN)%E * 1D3
         WRITE(LU,91) TRIM(STR1) // TRIM (STR2)
         
         STR1 = "      N_S(" // TWO // ")                  = "
         WRITE(STR2,'(F7.2)') RXN(IRXN)%ORDER
         WRITE(LU,91) TRIM(STR1) // TRIM (STR2)

         STR1 = "      THRESHOLD_TEMPERATURE(" // TWO // ")= "
         WRITE(STR2,'(F7.2)') 0D0
         WRITE(LU,91) TRIM(STR1) // TRIM (STR2)

         STR1 = "      HEAT_OF_REACTION(" // TWO // ")     = "
         WRITE(STR2,'(F9.2)') RXN(IRXN)%DHV*1D-3
         WRITE(LU,91) TRIM(STR1) // TRIM (STR2)

         IF (GPG%FDS_HEAT_OF_COMBUSTION .GT. 0.) THEN
            STR1 = "      HEAT_OF_COMBUSTION(" // TWO // ")   = "
            WRITE(STR2,'(F8.1)') GPG%FDS_HEAT_OF_COMBUSTION
            WRITE(LU,91) TRIM(STR1) // TRIM (STR2)
         ENDIF

! Begin reaction stoichiometry:
         IF (RXN(IRXN)%ITOS .EQ. 0) THEN         
            NU_RESIDUE(IRXN) = 0D0
         ELSE
            DO ITO = 1, SPROP%NSSPEC
               IF (TRIM(RXN(IRXN)%CTO) .EQ. TRIM(SPROP%NAME(ITO))) NU_RESIDUE(IRXN) = SPROP%R0(ITO) / SPROP%R0(IMATL)         
            ENDDO
         ENDIF

         NU_GAS(IRXN) = 1D0 - NU_RESIDUE(IRXN)

! FDS6 &MATL lines
! Write NU_SPEC and NU_MATL matrices:
         IF (GPG%FDS_MATL_VER .EQ. 6) THEN

            ICOUNT = 0
            DO ISPEC = 1, GPROP%NGSPEC
               IF (NU_GAS(IRXN)*GPROP%YIELDS(ISPEC,IRXN) .GT. 0.) THEN
                  ICOUNT = ICOUNT + 1
                  WRITE(CSPEC,'(I2.2)') ICOUNT
                  STR1 = "      SPEC_ID(" // CSPEC // "," // TWO // ")           = '" // TRIM(GPROP%NAME(ISPEC)) // "' "
                  WRITE(LU,91) TRIM(STR1)

                  STR1 = "      NU_SPEC(" // CSPEC // "," // TWO // ")           = "
                  WRITE(STR2,'(F8.3)') NU_GAS(IRXN)*GPROP%YIELDS(ISPEC,IRXN)
                  WRITE(LU,91) TRIM(STR1) // TRIM (STR2)
               ENDIF
            ENDDO

            IF (NU_RESIDUE(IRXN) .GT. 0D0) THEN
               STR1 = "      MATL_ID(01," // TWO // ")           = '"
               WRITE(LU,91) TRIM(STR1) // TRIM(GPG%CASENAME) // "_" // TRIM(RXN(IRXN)%CTO) // "'"

               STR1 = "      NU_MATL(01," // TWO // ")           = "
               WRITE(STR2,'(F8.3)') NU_RESIDUE(IRXN)
               WRITE(LU,91) TRIM(STR1) // TRIM (STR2)
            ENDIF
         
         ENDIF

! FDS5 &MATL lines
! Write NU_GAS and NU_RESIDUE matrices:

         IF (GPG%FDS_MATL_VER .EQ. 5) THEN

            DO ISPEC = 1, GPROP%NGSPEC
               IF (NU_GAS(IRXN)*GPROP%YIELDS(ISPEC,IRXN) .GT. 0.) THEN
                  STR1 = "      NU_FUEL(" // TWO // ")              = "
                  WRITE(STR2,'(F8.3)') NU_GAS(IRXN)*GPROP%YIELDS(ISPEC,IRXN)
                  WRITE(LU,91) TRIM(STR1) // TRIM (STR2)
               ENDIF
            ENDDO

            IF (NU_RESIDUE(IRXN) .GT. 0D0) THEN
               STR1 = "      RESIDUE(" // TWO // ")              = '"
               WRITE(LU,91) TRIM(STR1) // TRIM(GPG%CASENAME) // "_" // TRIM(RXN(IRXN)%CTO) // "'"

               STR1 = "      NU_RESIDUE(" // TWO // ")           = "
               WRITE(STR2,'(F8.3)') NU_RESIDUE(IRXN)
               WRITE(LU,91) TRIM(STR1) // TRIM (STR2)
            ENDIF
         
         ENDIF

      ENDIF

   ENDDO

   WRITE(STR1,'(I2.2)') I !number of reactions for this MATL
   WRITESTR = "      N_REACTIONS              = " // TRIM(STR1)
   WRITE(LU,91) TRIM(WRITESTR) // " /"
         
ENDDO
WRITE(LU,*)
      
! Write &SURF line: 
IF (G%NCELLZ .EQ. 1) WRITE(LU,93) "&SURF ID                         = '", TRIM(GPG%CASENAME), "_TGA' "
IF (G%NCELLZ .GT. 1) WRITE(LU,93) "&SURF ID                         = '", TRIM(GPG%CASENAME), "_SLAB' "

! Only for testing:
IF (G%NCELLZ .GT. 1 .AND. TESTING) THEN
   WRITE(STR1,'(F4.1)') GPG%ALLBC(2)%QE*0.001
   STR2 = "      EXTERNAL_FLUX              = " // TRIM(STR1)
   WRITE(LU,91) TRIM(STR2)
ENDIF

STR1 = "      THICKNESS                  = "
IF (G%NCELLZ .EQ. 1) THEN
   WRITE(STR2,'(F8.5)') 0.00001
ELSE
   WRITE(STR2,'(F9.6)') G%ZDIM
ENDIF
WRITE(LU,91) TRIM(STR1) // TRIM (STR2)

STR1 = "      STRETCH_FACTOR             = "
WRITE(STR2,'(F7.4)') 1D0
WRITE(LU,91) TRIM(STR1) // TRIM (STR2)

IF (G%NCELLZ .GT. 1) THEN
   ALPHA = SPROP%K0Z(1)/(SPROP%R0(1)*SPROP%C0(1))
   STR1 = "      CELL_SIZE_FACTOR           = "
   WRITE(STR2,'(F6.3)') 1.2 * G%ZDIM / ((G%NCELLZ-1) * SQRT(ALPHA) ) 
   WRITE(LU,91) TRIM(STR1) // TRIM (STR2)
ENDIF

DO IMATL = 1, SPROP%NSSPEC	
    WRITE(TWO,'(I2.2)') IMATL
    WRITE(STR1,*) "     MATL_ID(01,", TWO, ")             = '", TRIM(GPG%CASENAME), "_", TRIM(SPROP%NAME(IMATL)), "',"
    WRITE(LU,91) TRIM(STR1)
ENDDO

DO IMATL = 1, SPROP%NSSPEC	
    WRITE(TWO,'(I2.2)') IMATL
    WRITE(STR1,'(F7.4)') GPG%INITIAL_CONDITIONS(1)%YI0(IMATL)
    WRITE(STR2,*) "     MATL_MASS_FRACTION(01,",TWO,")  = ", TRIM(STR1), ", " 
    WRITE(LU,91) TRIM(STR2)
ENDDO

! Only for testing:
IF (G%NCELLZ .GT. 1 .AND. TESTING) THEN
   WRITE(STR1,'(F6.3)') GPG%ALLBC(2)%HC
   STR2 = "      HEAT_TRANSFER_COEFFICIENT  = " // TRIM(STR1) // ", "
   WRITE(LU,91) TRIM(STR2)
ENDIF

IF (G%NCELLZ .EQ. 1) THEN
   WRITE(STR1,'(F6.3)') 0D0
   STR2 = "      HEAT_TRANSFER_COEFFICIENT  = " // TRIM(STR1) // ", "
   WRITE(LU,91) TRIM(STR2)
ENDIF

STR1 = "      BACKING                    = 'INSULATED' /"
WRITE(LU,91) TRIM(STR1)

! Write RAMP's for temperature-dependent thermal properties
NRAMP = 0
DO IMATL = 1, SPROP%NSSPEC
      
   IF (SPROP%NKZ(IMATL) .NE. 0D0) THEN
      WRITE(LU,*)
      NRAMP = NRAMP + 1
      WRITE(TWO,'(I2.2)') NRAMP
      STR1 = "&RAMP ID = 'RAMP_" // TRIM(GPG%CASENAME) // "_" // TWO // "', T= "

      TR = GPG%TREF !GPG%TMP0 + 273.15
      TK = TR
            
      DO WHILE (TK .LT. TMPHI) 
         TC = TK - 273.15
         WRITE(STR2,'(F7.1)') TC

         VAL = SPROP%K0Z(IMATL) * (TK/TR)**SPROP%NKZ(IMATL)
         WRITE(STR3,'(F7.4)') VAL

         WRITESTR = TRIM(STR1) // TRIM(STR2) // ", F = " // TRIM(STR3) // " /"
         WRITE(LU,91) TRIM(WRITESTR)

         TK = TK + DTMP
      ENDDO

   ENDIF
         
   IF (SPROP%NC(IMATL) .NE. 0D0) THEN
      WRITE(LU,*)
      NRAMP = NRAMP + 1
      WRITE(TWO,'(I2.2)') NRAMP
      STR1 = "&RAMP ID = 'RAMP_" // TRIM(GPG%CASENAME) // "_" // TWO // "', T= "

      TR = GPG%TREF 
      TK = TR
            
      DO WHILE (TK .LT. TMPHI) 
         TC = TK - 273.15
         WRITE(STR2,'(F7.1)') TC

         VAL = 1D-3 * SPROP%C0(IMATL) * (TK/TR)**SPROP%NC(IMATL)
         WRITE(STR3,'(F7.4)') VAL
           
         WRITESTR = TRIM(STR1) // TRIM(STR2) // ", F = " // TRIM(STR3) // " /"
         WRITE(LU,91) TRIM(WRITESTR)
               
         TK = TK + DTMP
      ENDDO
   ENDIF

ENDDO

! Write lines for output files:
WRITE(STR1,'(F7.4)') GPG%DTDUMP_POINT
WRITE(STR2,'(F7.4)') GPG%DTDUMP_PROFILE
WRITESTR = "&DUMP DT_DEVC= " // TRIM(STR1) // ", DT_PROF= " // TRIM(STR2) 
WRITESTR = TRIM(WRITESTR) // ", DT_HRR = 1E6, DT_PL3D = 1E6, SMOKE3D = .FALSE. /"

WRITE(LU,*)
WRITE(LU,91) TRIM(WRITESTR) 
WRITE(LU,*)
      
! DEVC's:

IF (G%NCELLZ .EQ. 1) THEN
   WRITE(LU,91) "&DEVC XYZ = 0.0,0.0,0.0, IOR =  3, QUANTITY = 'WALL TEMPERATURE', ID= 'temp' /"
   WRITE(LU,91) "&DEVC XYZ = 0.0,0.0,0.0, IOR =  3, QUANTITY = 'NORMALIZED MASS', ID ='m/m0' /"
   DO ISPEC = 1, GPROP%NGSPEC
       WRITESTR = "&DEVC XYZ = 0.0,0.0,0.0, IOR =  3, QUANTITY = 'NORMALIZED MASS LOSS RATE', SPEC_ID='" // TRIM(GPROP%NAME(ISPEC)) // "', ID = 'normalized_mlr_" // TRIM(GPROP%NAME(ISPEC)) // "' /"
       WRITE(LU,91) TRIM(WRITESTR)
   ENDDO
ELSE
   DO I = 1, GPG%N_POINT_QUANTITIES
   
      IF (GPG%POINT_IMESH(I) .NE. 0 .AND. GPG%POINT_IMESH(I) .NE. GPG%IMESH(ICASE)) CYCLE 

      SELECT CASE(GPG%POINT_QUANTITY(I))
         CASE('TEMPERATURE')
            IF (GPG%POINT_Z(I) .LT. 1E-7) THEN
               WRITE(STR1,'(F8.5)') GPG%POINT_Z(I) + 0.00001
            ELSE
               WRITE(STR1,'(F8.5)') GPG%POINT_Z(I)            
            ENDIF
            WRITESTR = "&DEVC XYZ = 0.0,0.0,0.0, IOR=3, QUANTITY='INSIDE WALL TEMPERATURE', ID='temp', DEPTH = "
            WRITESTR = TRIM(WRITESTR) // TRIM(STR1) // " / "
            WRITE(LU,91) WRITESTR
         CASE ('MLR')
            WRITE(LU,91) "&DEVC XYZ = 0.0,0.0,0.0, IOR=3, QUANTITY='BURNING RATE', ID='burn' /"
         CASE DEFAULT
            CONTINUE
      END SELECT
   ENDDO
   
! Dump all species mass fluxes:   
   WRITE(LU,*)
   DO ISPEC = 1, GPROP%NGSPEC
      WRITESTR="&DEVC XYZ = 0.0,0.0,0.0, IOR=3, QUANTITY='MASS FLUX', SPEC_ID='" // TRIM(GPROP%NAME(ISPEC)) // "', ID='MLR_" // TRIM(GPROP%NAME(ISPEC)) // "' /"
      WRITE(LU,91) TRIM(WRITESTR)
   ENDDO

! PROF's:
   WRITESTR = "&PROF XYZ = 0.0,0.0,0.0, IOR=3, QUANTITY = 'DENSITY' / "
   WRITE (LU,91) TRIM(WRITESTR)

   WRITESTR = "&PROF XYZ = 0.0,0.0,0.0, IOR=3, QUANTITY = 'TEMPERATURE' / "
   WRITE (LU,91) TRIM(WRITESTR)
ENDIF
  
WRITE(LU,*) 
WRITE(LU,91) "&TAIL /"
      
CLOSE(LU)

 91   FORMAT(A)
 93   FORMAT(A,A,A)


!******************************************************************************
END SUBROUTINE DUMP_FDS_INPUT_FILE
!******************************************************************************

! *****************************************************************************
SUBROUTINE GET_CLOSEST_CELL(NCELL,DEPTH,TARGET_DEPTH,ICBEST)
! *****************************************************************************

INTEGER, INTENT(IN) :: NCELL
REAL(EB) :: TARGET_DEPTH
REAL(EB), DIMENSION(1:NCELL) :: DEPTH
INTEGER, INTENT(OUT) :: ICBEST
REAL(EB) :: DIFF, MINDIFF
INTEGER :: IC

MINDIFF = 9D9
DO IC = 1, NCELL
   DIFF = ABS(DEPTH(IC) - TARGET_DEPTH)
   IF (DIFF .LT. MINDIFF) THEN
      MINDIFF = DIFF
      ICBEST = IC
   ENDIF 
ENDDO !IC

! *****************************************************************************
END SUBROUTINE GET_CLOSEST_CELL
! *****************************************************************************

!******************************************************************************
SUBROUTINE SHUTDOWN_GPYRO(MESSAGE)
!******************************************************************************
USE GPYRO_VARS

CHARACTER(300), INTENT(IN) :: MESSAGE
INTEGER :: I,IOS
LOGICAL :: LOPEN, GO

WRITE(*,*) MESSAGE

DO I = 1, GPG%N_SMOKEVIEW_QUANTITIES ! Close out solid-phase smokeview files
   INQUIRE(UNIT=LUSMV+I,OPENED=LOPEN,IOSTAT=IOS)
   IF (LOPEN) CLOSE(LUSMV+I)
ENDDO

GO=.TRUE. 
IF (MESSAGE(1:31) == 'Error, no input file specified.') GO = .FALSE.
IF (GO) CALL DUMP_TIMINGS(1) ! Dump final cpu time statistics

STOP

!******************************************************************************
END SUBROUTINE SHUTDOWN_GPYRO
!******************************************************************************

!******************************************************************************
END MODULE GPYRO_IO
!******************************************************************************
